<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± | ÙˆØ§ØµÙ„</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-layout {
            display: flex;
            min-height: 100vh;
            background: var(--bg-main);
        }

        .admin-sidebar {
            width: 280px;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            padding: 2rem 0;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .admin-sidebar.collapsed {
            width: 80px;
        }

        .admin-sidebar.collapsed .admin-brand h2,
        .admin-sidebar.collapsed .admin-brand p,
        .admin-sidebar.collapsed .admin-nav-item span {
            display: none;
        }

        .admin-sidebar.collapsed .admin-brand {
            padding: 0 0.5rem 2rem;
        }

        .admin-sidebar.collapsed .admin-nav-item {
            justify-content: center;
            padding: 12px;
            margin-bottom: 6px;
        }

        .admin-sidebar.collapsed .admin-nav-item i {
            margin-left: 0;
        }

        /* Sidebar Collapse Button */
        .sidebar-collapse-btn,
        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            width: 40px !important;
            height: 40px !important;
            min-width: 40px !important;
            min-height: 40px !important;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
            color: var(--text-muted);
            flex-shrink: 0;
            padding: 0;
            margin: 0;
        }

        .sidebar-collapse-btn:hover,
        .theme-toggle:hover {
            background: var(--primary-light);
            color: var(--primary-dark);
            border-color: var(--primary);
        }

        .admin-sidebar.collapsed .sidebar-collapse-btn i {
            transform: rotate(180deg);
        }

        @media (min-width: 1025px) {
            .sidebar-collapse-btn {
                display: flex !important;
            }
        }

        .admin-brand {
            padding: 1.5rem 1rem 2rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .brand-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .admin-sidebar.collapsed .brand-header {
            flex-direction: column;
            gap: 12px;
        }

        .admin-brand h2 {
            color: var(--primary-dark);
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-nav {
            padding: 0 1rem;
        }

        .admin-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 6px;
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            position: relative;
        }

        .admin-nav-item:hover {
            background: var(--bg-secondary);
            color: var(--primary);
            transform: translateX(-4px);
        }

        .admin-nav-item.active {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .admin-nav-item i {
            width: 20px;
            text-align: center;
        }

        /* Tooltip for collapsed sidebar */
        .admin-sidebar.collapsed .admin-nav-item::after {
            content: attr(data-tooltip);
            position: absolute;
            right: -120px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-secondary);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
            border: 1px solid var(--border);
        }

        .admin-sidebar.collapsed .admin-nav-item:hover::after {
            opacity: 1;
        }

        /* Submenu Styles */
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(0, 0, 0, 0.02);
            border-radius: var(--radius-sm);
        }

        .submenu.open {
            max-height: 500px;
            /* Arbitrary large height */
            transition: max-height 0.5s ease-in;
        }

        .submenu .admin-nav-item {
            padding-right: 2.5rem;
            /* Indent submenu items */
            font-size: 0.9em;
        }

        .submenu-arrow {
            margin-right: auto;
            transition: transform 0.3s;
            font-size: 0.8em;
        }

        .admin-nav-item.submenu-trigger.open .submenu-arrow {
            transform: rotate(-180deg);
        }

        .admin-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        /* Admin Header (non-fixed). It responds to sidebar state */
        #admin-header {
            position: static;
            background: transparent;
            z-index: auto;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            transition: all 0.25s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        /* When sidebar is collapsed, make header more compact */
        #admin-header.sidebar-collapsed h1 {
            font-size: 1.4rem;
        }

        #admin-header.sidebar-collapsed p {
            display: none;
        }

        /* When sidebar is open on mobile (overlay), reduce header elevation */
        #admin-header.sidebar-open {
            background: rgba(0, 0, 0, 0.03);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }

        .stat-box {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .stat-box h3 {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .stat-box .number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-main);
        }

        .data-table {
            width: 100%;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--border);
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table thead {
            background: var(--bg-secondary);
        }

        .data-table th,
        .data-table td {
            padding: 16px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            font-weight: 700;
            color: var(--text-main);
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .data-table tbody tr {
            background: var(--bg-card);
            transition: all 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: var(--bg-secondary);
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Table wrapper for horizontal scroll on small screens */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 2rem;
            border-radius: var(--radius-md);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: 0.2s;
            margin-left: 6px;
        }

        .action-btn.primary {
            background: var(--primary);
            color: white;
        }

        .action-btn.danger {
            background: #f44336;
            color: white;
        }

        .action-btn.warning {
            background: var(--accent);
            color: white;
        }

        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;

            overflow-y: auto;
        }

        /* --- QR POPUP CSS (From User Dashboard) --- */
        .qr-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .qr-popup.active {
            display: flex;
        }

        .qr-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* --- TOAST NOTIFICATIONS CSS --- */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--bg-card);
            color: var(--text-main);
            padding: 12px 20px;
            border-radius: var(--radius-md);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 280px;
            max-width: 400px;
            border-right: 4px solid var(--primary);
            animation: slideIn 0.3s ease-out;
            font-weight: 500;
        }

        .toast.success {
            border-right-color: #4caf50;
        }

        .toast.error {
            border-right-color: #f44336;
        }

        .toast.info {
            border-right-color: var(--primary);
        }

        .toast i {
            font-size: 1.2rem;
        }

        .toast.success i {
            color: #4caf50;
        }

        .toast.error i {
            color: #f44336;
        }

        .toast.info i {
            color: var(--primary);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* --- RESPONSIVE TABLES CSS (Matching User Dashboard) --- */
        @media (max-width: 768px) {
            .data-table thead {
                display: none;
                /* Hide headers on mobile */
            }

            .data-table,
            .data-table tbody,
            .data-table tr,
            .data-table td {
                display: block;
                width: 100%;
            }

            .data-table tr {
                margin-bottom: 15px;
                background: var(--bg-card);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 15px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            }

            .data-table td {
                border: none;
                border-bottom: 1px solid var(--border);
                position: relative;
                padding-right: 50% !important;
                padding-left: 10px;
                text-align: left;
                padding-top: 10px;
                padding-bottom: 10px;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: flex-end;
            }

            .data-table td {
                display: block;
                text-align: left;
            }

            .data-table td:last-child {
                border-bottom: none;
                padding-right: 10px !important;
                text-align: center;
                display: flex;
                justify-content: center;
                gap: 10px;
                padding-bottom: 0;
            }

            .data-table td::before {
                content: attr(data-label);
                position: absolute;
                top: 10px;
                right: 10px;
                width: 45%;
                white-space: nowrap;
                font-weight: bold;
                color: var(--text-muted);
                text-align: right;
            }

            /* Special case for Actions column */
            .data-table td[data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]::before,
            .data-table td:last-child::before {
                display: none;
            }

            /* Responsive Utilities */
            .card {
                padding: 1rem !important;
            }

            .modal-content {
                padding: 1.5rem !important;
                width: 95% !important;
            }

            /* Sessions Page Specifics */
            .session-card-mobile {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        /* User Filter Tabs */
        .user-filter-tabs {
            overflow-x: auto;
            white-space: nowrap;
        }

        .user-filter-btn {
            background: transparent;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.95rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
        }

        .user-filter-btn:hover {
            color: var(--primary);
            background: var(--bg-secondary);
        }

        .user-filter-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .user-filter-btn i {
            font-size: 1.1rem;
        }

        .filter-count {
            background: var(--primary-light);
            color: var(--primary-dark);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            min-width: 24px;
            text-align: center;
        }

        .user-filter-btn.active .filter-count {
            background: var(--primary);
            color: white;
        }

        /* Hide rows based on filter */
        .user-row {
            transition: opacity 0.2s;
        }

        .user-row.hidden {
            display: none;
        }

        /* Alternating row colors for better readability */
        .data-table tbody tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.02);
        }

        .data-table tbody tr:nth-child(odd) {
            background: var(--bg-card);
        }

        .data-table tbody tr:hover {
            background: var(--primary-light) !important;
        }

        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            font-size: 1.2rem;
        }

        .sidebar-close-btn {
            display: none !important;
        }

        @media (max-width: 1024px) {
            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .sidebar-close-btn {
                display: block !important;
            }

            .admin-sidebar {
                position: fixed;
                right: -280px;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: right 0.3s ease;
                box-shadow: var(--shadow-lg);
                width: 280px;
                overflow: hidden;
            }

            .admin-sidebar.open {
                right: 0;
            }

            .admin-content {
                padding: 4rem 1rem 2rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .data-table {
                font-size: 0.9rem;
            }

            .action-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .user-filter-btn {
                display: block;
                margin-bottom: 0.5rem;
                border: 1px solid var(--border);
                border-radius: var(--radius-md);
                padding: 1rem;
                width: 100%;
            }
        }

        @media (max-width: 1024px) {
            .sidebar-collapse-btn {
                display: none !important;
            }

            .admin-sidebar.collapsed {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            .admin-sidebar {
                width: 100%;
                right: -100%;
            }

            .admin-content {
                padding: 3.5rem 0.75rem 1rem;
            }

            h1 {
                font-size: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-box {
                padding: 1.5rem;
            }

            .data-table th,
            .data-table td {
                padding: 10px;
                font-size: 0.85rem;
            }

            .action-btn {
                padding: 4px 8px;
                font-size: 0.7rem;
                margin-left: 3px;
            }

            .modal-content {
                width: 95%;
                max-width: none;
            }

            .form-control {
                padding: 10px;
                font-size: 16px;
            }

            /* Show Mobile Menu Toggle */
            #mobile-menu-toggle {
                display: block !important;
            }

            /* Header Responsive on Small Screens */
            .admin-content>div:first-child {
                flex-direction: column;
                gap: 1rem;
            }

            .admin-content>div:first-child>div:last-child {
                width: 100%;
                justify-content: space-around;
            }
        }

        @media (max-width: 480px) {
            .admin-content {
                padding: 3rem 0.5rem 1rem;
            }

            h1 {
                font-size: 1.3rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stat-box {
                padding: 1rem;
            }

            .stat-box h3 {
                font-size: 0.8rem;
            }

            .stat-box .number {
                font-size: 2rem;
            }

            .data-table th,
            .data-table td {
                padding: 8px;
                font-size: 0.75rem;
            }

            .action-btn {
                padding: 3px 6px;
                font-size: 0.65rem;
                margin-left: 2px;
            }

            .admin-brand h2 {
                font-size: 1rem;
            }

            .admin-nav-item {
                padding: 10px 12px;
                font-size: 0.9rem;
            }

            .tab-content {
                padding: 0;
            }

            /* Mobile Header Optimization */
            .admin-content>div:first-child h1 {
                font-size: 1.4rem;
            }

            .admin-content>div:first-child>div:first-child {
                gap: 0.5rem;
            }

            #mobile-menu-toggle {
                padding: 8px 10px;
                font-size: 1rem;
            }

            .admin-content>div:first-child>div:last-child {
                gap: 0.5rem;
            }

            .admin-content>div:first-child>div:last-child button {
                padding: 8px 10px;
            }
        }

        /* Header and Stat Box Animations */
        .stat-box {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .stat-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border-color: var(--primary);
        }

        /* Notification Badge Animation */
        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        #notification-badge {
            animation: pulse 2s infinite;
        }

        /* Collapse Button Rotation */
        .sidebar-collapse-btn i {
            display: inline-block;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .admin-sidebar.collapsed .sidebar-collapse-btn i {
            transform: rotate(180deg);
        }

        /* Dropdown Animation */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #notifications-dropdown[style*="block"],
        #profile-dropdown[style*="block"] {
            animation: slideDown 0.2s ease;
        }

        /* Sidebar Overlay */
        #sidebar-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
            transition: opacity 0.3s ease;
        }

        .admin-sidebar.open~#sidebar-overlay {
            display: block;
        }

        /* Empty State */
        .empty-state {
            padding: 3rem 2rem;
            text-align: center;
            color: var(--text-muted);
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-main) 100%);
            border-radius: var(--radius-md);
            border: 2px dashed var(--border);
        }

        .empty-state i {
            font-size: 3.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state h3 {
            color: var(--text-main);
            font-size: 1.2rem;
            margin: 1rem 0;
        }

        .empty-state p {
            color: var(--text-muted);
            margin: 0.5rem 0 1.5rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Loading Animation */
        .loading-skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 0%, var(--bg-secondary) 50%, var(--bg-main) 100%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            height: 1.2rem;
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Sidebar Toggle - Old Media Query */
    </style>
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-brand">
                <div class="brand-header">
                    <h2 style="flex: 1; margin: 0;"><i class="fab fa-whatsapp"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
                    <div style="display: flex; gap: 10px; align-items: center;" class="toolbar-btns">
                        <button class="theme-toggle" onclick="toggleTheme()" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">
                            <i class="fas fa-moon"></i>
                        </button>
                        <button onclick="toggleSidebarCollapse()" class="sidebar-collapse-btn" title="Ø·ÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </div>
                </div>
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 5px;">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <%= user.name %>
                </p>
            </div>

            <button onclick="toggleAdminSidebar()"
                style="background:none; border:none; cursor:pointer; font-size:1.2rem; color:var(--text-muted); padding: 6px; display: none;"
                class="sidebar-close-btn">
                <i class="fas fa-times"></i>
            </button>

            <nav class="admin-nav">
                <div class="admin-nav-item active" onclick="switchTab('dashboard')" data-tooltip="Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª">
                    <i class="fas fa-chart-line"></i>
                    <span>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</span>
                </div>
                <div class="admin-nav-item" onclick="switchTab('whatsapp')" data-tooltip="Ø¬Ù„Ø³Ø§ØªÙŠ">
                    <i class="fab fa-whatsapp"></i>
                    <span>Ø¬Ù„Ø³Ø§ØªÙŠ</span>
                </div>
                <div class="admin-nav-item" onclick="switchTab('payments')" data-tooltip="Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„"
                    style="position: relative;">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„</span>
                    <span id="payments-badge"
                        style="position: absolute; top: 10px; left: 10px; background: #f44336; color: white; border-radius: 50%; width: 18px; height: 18px; display: none; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: bold; border: 2px solid var(--bg-card);">0</span>
                </div>

                <div class="admin-nav-item" onclick="switchTab('users')" data-tooltip="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†">
                    <i class="fas fa-users"></i>
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                </div>
                <div class="admin-nav-item" onclick="switchTab('plans')" data-tooltip="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ù‚Ø§Øª">
                    <i class="fas fa-box"></i>
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</span>
                </div>
                <div class="admin-nav-item" onclick="switchTab('logs')" data-tooltip="Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·">
                    <i class="fas fa-history"></i>
                    <span>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</span>
                </div>

                <!-- User Systems Submenu -->
                <div class="admin-nav-item submenu-trigger" onclick="toggleSubmenu('user-systems-submenu')"
                    data-tooltip="Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†">
                    <i class="fas fa-cubes"></i>
                    <span>Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                    <i class="fas fa-chevron-down submenu-arrow"></i>
                </div>
                <div id="user-systems-submenu" class="submenu">
                    <div class="admin-nav-item" onclick="window.location.href='/dashboard/islamic-reminders'"
                        data-tooltip="Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©">
                        <i class="fas fa-mosque"></i>
                        <span>Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</span>
                    </div>
                </div>

                <div class="admin-nav-item" onclick="window.location.href='/dashboard/settings'"
                    data-tooltip="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
                    <i class="fas fa-cog"></i>
                    <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                </div>
                <div class="admin-nav-item" onclick="window.location.href='/logout'" data-tooltip="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"
                    style="margin-top: 2rem; color: #f44336;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <!-- Admin Header - responds to sidebar state -->
            <div id="admin-header"
                style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 0; margin-bottom: 2rem; border-bottom: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                    <!-- Mobile Menu Toggle Button -->
                    <button id="mobile-menu-toggle"
                        style="display: none; background: var(--bg-secondary); border: none; padding: 10px 12px; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-main); font-size: 1.2rem; transition: all 0.3s;"
                        onclick="toggleAdminSidebar()" title="ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h1 style="margin: 0; color: var(--text-main); font-size: 1.8rem;">
                            <i class="fas fa-tachometer-alt" style="color: var(--primary); margin-left: 8px;"></i>
                            Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                        </h1>
                        <p style="margin: 8px 0 0 0; color: var(--text-muted); font-size: 0.9rem;">
                            <i class="fas fa-calendar-alt" style="margin-left: 5px;"></i>
                            <span id="current-date"></span>
                        </p>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <!-- Notifications -->
                    <div style="position: relative;">
                        <button
                            style="background: var(--bg-secondary); border: none; padding: 10px 12px; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-main); font-size: 1rem; transition: all 0.3s;"
                            onclick="toggleNotifications()" title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">
                            <i class="fas fa-bell"></i>
                            <span id="notification-badge"
                                style="position: absolute; top: 5px; right: 5px; background: #f44336; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">0</span>
                        </button>
                        <!-- Notifications Dropdown -->
                        <div id="notifications-dropdown"
                            style="position: absolute; top: calc(100% + 8px); left: 0; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); width: 350px; max-height: 400px; overflow-y: auto; display: none; box-shadow: 0 4px 16px rgba(0,0,0,0.1); z-index: 1000;">
                            <div
                                style="padding: 1rem; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--text-main); display: flex; justify-content: space-between; align-items: center;">
                                <span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
                                <button onclick="markAllNotificationsAsRead()"
                                    style="background: none; border: none; color: var(--primary); font-size: 0.75rem; cursor: pointer; font-weight: 600;">ØªØ­Ø¯ÙŠØ¯
                                    Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡</button>
                            </div>
                            <div id="notifications-list" style="max-height: 300px; overflow-y: auto;">
                                <div style="padding: 1rem; text-align: center; color: var(--text-muted);">Ù„Ø§ ØªÙˆØ¬Ø¯
                                    Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Profile -->
                    <div style="position: relative;">
                        <button
                            style="background: var(--bg-secondary); border: none; padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-main); display: flex; align-items: center; gap: 8px; transition: all 0.3s;"
                            onclick="toggleAdminProfile()">
                            <div
                                style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                <%= user.name.charAt(0) %>
                            </div>
                            <span style="font-size: 0.9rem;">
                                <%= user.name %>
                            </span>
                            <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>
                        </button>
                        <!-- Profile Dropdown -->
                        <div id="profile-dropdown"
                            style="position: absolute; top: calc(100% + 8px); left: -100px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); width: 200px; display: none; box-shadow: 0 4px 16px rgba(0,0,0,0.1); z-index: 1000; overflow: hidden;">
                            <a href="/dashboard/settings"
                                style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-main); text-decoration: none; transition: background 0.2s;"
                                onmouseover="this.style.background='var(--bg-secondary)'"
                                onmouseout="this.style.background='transparent'">
                                <i class="fas fa-user-circle" style="color: var(--primary); font-size: 1.1rem;"></i>
                                Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
                            </a>
                            <a href="/logout"
                                style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #f44336; text-decoration: none; transition: background 0.2s;"
                                onmouseover="this.style.background='var(--bg-secondary)'"
                                onmouseout="this.style.background='transparent'">
                                <i class="fas fa-sign-out-alt" style="font-size: 1.1rem;"></i>
                                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <h1 style="margin-bottom: 2rem; color: var(--text-main); display: none;">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h1>

                <div class="stats-grid">
                    <div class="stat-box" style="position: relative; overflow: hidden;">
                        <div
                            style="position: absolute; top: 10px; right: 10px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-light), var(--primary)); opacity: 0.1;">
                        </div>
                        <div style="position: relative; z-index: 1;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <h3 style="margin: 0; font-size: 0.9rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                                <div
                                    style="width: 40px; height: 40px; border-radius: var(--radius-sm); background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: var(--primary);">
                                    <i class="fas fa-users" style="font-size: 1.2rem;"></i>
                                </div>
                            </div>
                            <div class="number" id="stat-users" style="margin-bottom: 0.5rem;">0</div>
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0;">
                                <i class="fas fa-arrow-up" style="color: var(--primary); margin-left: 4px;"></i>
                                +0 Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
                            </p>
                        </div>
                    </div>

                    <!-- Admin Count Card -->
                    <div class="stat-box" style="position: relative; overflow: hidden;">
                        <div
                            style="position: absolute; top: 10px; right: 10px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #FF9800, #F57C00); opacity: 0.1;">
                        </div>
                        <div style="position: relative; z-index: 1;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <h3 style="margin: 0; font-size: 0.9rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†</h3>
                                <div
                                    style="width: 40px; height: 40px; border-radius: var(--radius-sm); background: #FFF3E0; display: flex; align-items: center; justify-content: center; color: #FF9800;">
                                    <i class="fas fa-user-shield" style="font-size: 1.2rem;"></i>
                                </div>
                            </div>
                            <div class="number" id="stat-admins" style="color: #FF9800; margin-bottom: 0.5rem;">0</div>
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0;">
                                <i class="fas fa-shield-alt" style="color: #FF9800; margin-left: 4px;"></i>
                                Ù…Ø¯ÙŠØ±ÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…
                            </p>
                        </div>
                    </div>
                    <div class="stat-box" style="position: relative; overflow: hidden;">
                        <div
                            style="position: absolute; top: 10px; right: 10px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #4CAF50, #45a049); opacity: 0.1;">
                        </div>
                        <div style="position: relative; z-index: 1;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <h3 style="margin: 0; font-size: 0.9rem;">Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù†Ø´Ø·Ø©</h3>
                                <div
                                    style="width: 40px; height: 40px; border-radius: var(--radius-sm); background: #E8F5E9; display: flex; align-items: center; justify-content: center; color: #4CAF50;">
                                    <i class="fas fa-check-circle" style="font-size: 1.2rem;"></i>
                                </div>
                            </div>
                            <div class="number" id="stat-active" style="color: #4CAF50; margin-bottom: 0.5rem;">0</div>
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0;">
                                <i class="fas fa-circle"
                                    style="color: #4CAF50; font-size: 0.5rem; margin-left: 4px;"></i>
                                Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†
                            </p>
                        </div>
                    </div>
                    <div class="stat-box" style="position: relative; overflow: hidden;">
                        <div
                            style="position: absolute; top: 10px; right: 10px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-light), var(--accent)); opacity: 0.1;">
                        </div>
                        <div style="position: relative; z-index: 1;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <h3 style="margin: 0; font-size: 0.9rem;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</h3>
                                <div
                                    style="width: 40px; height: 40px; border-radius: var(--radius-sm); background: var(--accent-light); display: flex; align-items: center; justify-content: center; color: var(--accent);">
                                    <i class="fas fa-hourglass-half" style="font-size: 1.2rem;"></i>
                                </div>
                            </div>
                            <div class="number" id="stat-pending" style="color: var(--accent); margin-bottom: 0.5rem;">0
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0;">
                                <i class="fas fa-exclamation-circle"
                                    style="color: var(--accent); margin-left: 4px;"></i>
                                ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users-tab" class="tab-content">
                <button onclick="switchTab('dashboard')"
                    style="background: var(--bg-secondary); border: none; padding: 10px 16px; border-radius: var(--radius-sm); cursor: pointer; color: var(--primary); font-weight: 600; margin-bottom: 1.5rem; transition: all 0.3s;"
                    onmouseover="this.style.background='var(--primary)'; this.style.color='white'"
                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--primary)'">
                    <i class="fas fa-arrow-right" style="margin-left: 6px;"></i>
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                </button>
                <h1 style="margin-bottom: 1.5rem; color: var(--text-main);">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h1>

                <!-- Quick Access Admin Sessions -->
                <div
                    style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); border-right: 4px solid var(--primary); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 style="margin: 0; color: var(--text-main); font-size: 1rem;">
                            <i class="fas fa-user-shield" style="color: var(--primary);"></i> Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± (Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙŠ)
                        </h4>
                        <p style="margin: 5px 0 0 0; font-size: 0.85rem; color: var(--text-muted);">Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù„Ø³Ø§Øª Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
                            Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·</p>
                    </div>
                    <button class="btn"
                        onclick="viewUserSessions('<%= user.id %>', '<%= user.name %>', { email: '<%= user.email %>', phone: '<%= user.phone %>', role: '<%= user.role %>', created_at: '<%= user.created_at %>' })"
                        style="background: var(--primary); color: white;">
                        <i class="fas fa-history"></i> Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ ÙˆØ¬Ù„Ø³Ø§ØªÙŠ
                    </button>
                </div>

                <!-- User Filter Tabs -->
                <div class="user-filter-tabs"
                    style="display: flex; gap: 10px; margin-bottom: 2rem; border-bottom: 2px solid var(--border); padding-bottom: 0;">
                    <button class="user-filter-btn active" onclick="filterUsers('all')" data-filter="all">
                        <i class="fas fa-users"></i>
                        <span>Ø§Ù„ÙƒÙ„</span>
                        <span class="filter-count" id="count-all">0</span>
                    </button>
                    <button class="user-filter-btn" onclick="filterUsers('active')" data-filter="active">
                        <i class="fas fa-check-circle"></i>
                        <span>Ø§Ø´ØªØ±Ø§Ùƒ Ù†Ø´Ø·</span>
                        <span class="filter-count" id="count-active">0</span>
                    </button>
                    <button class="user-filter-btn" onclick="filterUsers('trial')" data-filter="trial">
                        <i class="fas fa-gift"></i>
                        <span>ØªØ¬Ø±ÙŠØ¨ÙŠ</span>
                        <span class="filter-count" id="count-trial">0</span>
                    </button>
                    <button class="user-filter-btn" onclick="filterUsers('pending')" data-filter="pending">
                        <i class="fas fa-clock"></i>
                        <span>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„</span>
                        <span class="filter-count" id="count-pending">0</span>
                    </button>
                    <button class="user-filter-btn" onclick="filterUsers('expired')" data-filter="expired">
                        <i class="fas fa-times-circle"></i>
                        <span>Ù…Ù†ØªÙ‡ÙŠ</span>
                        <span class="filter-count" id="count-expired">0</span>
                    </button>
                </div>

                <!-- Search Bar and Date Filter -->
                <div style="margin-bottom: 1.5rem; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <div style="flex: 1; min-width: 250px;">
                        <input type="text" id="user-search" class="form-control"
                            placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." onkeyup="searchUsers()">
                    </div>

                    <div
                        style="display: flex; gap: 8px; align-items: center; background: var(--bg-secondary); padding: 5px; border-radius: var(--radius-sm);">
                        <div style="position: relative;">
                            <label
                                style="position: absolute; top: -8px; right: 8px; font-size: 0.7rem; color: var(--text-muted); background: var(--bg-secondary); padding: 0 4px;">Ù…Ù†
                                ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="date-from" class="form-control"
                                style="padding: 8px; font-size: 0.9rem; border: none; background: transparent;">
                        </div>
                        <span style="color: var(--text-muted);">-</span>
                        <div style="position: relative;">
                            <label
                                style="position: absolute; top: -8px; right: 8px; font-size: 0.7rem; color: var(--text-muted); background: var(--bg-secondary); padding: 0 4px;">Ø¥Ù„Ù‰
                                ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="date-to" class="form-control"
                                style="padding: 8px; font-size: 0.9rem; border: none; background: transparent;">
                        </div>
                        <button class="btn btn-primary" onclick="loadUsers()"
                            style="padding: 8px 16px; min-width: auto;">
                            <i class="fas fa-filter"></i> ØªØµÙÙŠØ©
                        </button>
                    </div>
                </div>

                <table class="data-table" id="users-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                            <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                            <th>Ø§Ù„Ø¨Ø§Ù‚Ø©</th>
                            <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Payments Tab (Unified Activation Requests) -->
            <div id="payments-tab" class="tab-content">
                <button onclick="switchTab('dashboard')"
                    style="background: var(--bg-secondary); border: none; padding: 10px 16px; border-radius: var(--radius-sm); cursor: pointer; color: var(--primary); font-weight: 600; margin-bottom: 1.5rem; transition: all 0.3s;"
                    onmouseover="this.style.background='var(--primary)'; this.style.color='white'"
                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--primary)'">
                    <i class="fas fa-arrow-right" style="margin-left: 6px;"></i>
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                </button>

                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                    <div>
                        <h1 style="margin: 0; color: var(--text-main);">
                            <i class="fas fa-money-bill-wave" style="color: #25D366; margin-left: 10px;"></i>
                            Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„ØªÙØ¹ÙŠÙ„
                        </h1>
                        <p style="color: var(--text-muted); margin-top: 8px;">
                            Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥ÙŠØµØ§Ù„Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.
                        </p>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div style="display: flex; gap: 10px; margin-bottom: 1.5rem; padding-bottom: 0;">
                    <button class="activation-filter-btn active" onclick="filterActivationRequests('all')"
                        data-activation-filter="all"
                        style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 6px;">
                        <i class="fas fa-th-list"></i>
                        <span>Ø§Ù„ÙƒÙ„</span>
                        <span id="filter-all-count"
                            style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">0</span>
                    </button>
                    <button class="activation-filter-btn" onclick="filterActivationRequests('payments')"
                        data-activation-filter="payments"
                        style="background: var(--bg-secondary); color: var(--text-main); border: none; padding: 8px 16px; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 6px;">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Ø·Ù„Ø¨Ø§Øª Ø¯ÙØ¹</span>
                        <span id="filter-payment-count"
                            style="background: var(--border); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">0</span>
                    </button>
                    <button class="activation-filter-btn" onclick="filterActivationRequests('subscriptions')"
                        data-activation-filter="subscriptions"
                        style="background: var(--bg-secondary); color: var(--text-main); border: none; padding: 8px 16px; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 6px;">
                        <i class="fas fa-user-clock"></i>
                        <span>Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…Ø¹Ù„Ù‚Ø©</span>
                        <span id="filter-subscription-count"
                            style="background: var(--border); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">0</span>
                    </button>
                </div>

                <style>
                    .activation-filter-btn:not(.active):hover {
                        background: var(--primary-light) !important;
                        color: var(--primary) !important;
                    }

                    .activation-filter-btn.active {
                        background: var(--primary) !important;
                        color: white !important;
                    }
                </style>

                <div class="table-container"
                    style="background: var(--bg-card); border-radius: var(--radius-md); border: 1px solid var(--border); overflow: hidden;">
                    <table class="data-table" id="payments-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                <th>Ø§Ù„Ø¨Ø§Ù‚Ø©</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                                <th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                                <th>Ø§Ù„Ø¥ÙŠØµØ§Ù„</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="payments-tbody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 3rem;">
                                    <i class="fas fa-spinner fa-spin"
                                        style="font-size: 2rem; color: var(--primary); margin-bottom: 1rem; display: block;"></i>
                                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Plans Tab -->
            <div id="plans-tab" class="tab-content">
                <button onclick="switchTab('dashboard')"
                    style="background: var(--bg-secondary); border: none; padding: 10px 16px; border-radius: var(--radius-sm); cursor: pointer; color: var(--primary); font-weight: 600; margin-bottom: 1.5rem; transition: all 0.3s;"
                    onmouseover="this.style.background='var(--primary)'; this.style.color='white'"
                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--primary)'">
                    <i class="fas fa-arrow-right" style="margin-left: 6px;"></i>
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                </button>
                <h1 style="margin-bottom: 1.5rem; color: var(--text-main);">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</h1>
                <button class="btn" onclick="showCreatePlanModal()" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©
                </button>

                <div id="plans-grid" class="stats-grid">
                    <div style="text-align: center; padding: 2rem; grid-column: 1/-1; color: var(--text-muted);">Ø¬Ø§Ø±ÙŠ
                        Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div id="logs-tab" class="tab-content">
                <button onclick="switchTab('dashboard')"
                    style="background: var(--bg-secondary); border: none; padding: 10px 16px; border-radius: var(--radius-sm); cursor: pointer; color: var(--primary); font-weight: 600; margin-bottom: 1.5rem; transition: all 0.3s;"
                    onmouseover="this.style.background='var(--primary)'; this.style.color='white'"
                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--primary)'">
                    <i class="fas fa-arrow-right" style="margin-left: 6px;"></i>
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                </button>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h1 style="margin-bottom: 0; color: var(--text-main);">Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</h1>
                    <button class="btn btn-secondary" onclick="loadLogs()">
                        <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                                <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                                <th>IP</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table-body">
                            <!-- Logs loaded via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CMS Tab -->
            <div id="cms-tab" class="tab-content">
                <button onclick="switchTab('dashboard')"
                    style="background: var(--bg-secondary); border: none; padding: 10px 16px; border-radius: var(--radius-sm); cursor: pointer; color: var(--primary); font-weight: 600; margin-bottom: 1.5rem; transition: all 0.3s;"
                    onmouseover="this.style.background='var(--primary)'; this.style.color='white'"
                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--primary)'">
                    <i class="fas fa-arrow-right" style="margin-left: 6px;"></i>
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                </button>
                <h1 style="margin-bottom: 2rem; color: var(--text-main);">
                    <i class="fas fa-cog" style="color: var(--primary);"></i>
                    Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                </h1>
                <p style="color: var(--text-muted); margin-bottom: 2rem;">Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</p>
                <a href="/dashboard/settings" class="btn">
                    <i class="fas fa-edit"></i>
                    ØªØ­Ø±ÙŠØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </a>
            </div>

            <!-- Tabs Management Tab -->
            <div id="tabs-tab" class="tab-content">
                <button onclick="switchTab('dashboard')"
                    style="background: var(--bg-secondary); border: none; padding: 10px 16px; border-radius: var(--radius-sm); cursor: pointer; color: var(--primary); font-weight: 600; margin-bottom: 1.5rem; transition: all 0.3s;"
                    onmouseover="this.style.background='var(--primary)'; this.style.color='white'"
                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--primary)'">
                    <i class="fas fa-arrow-right" style="margin-left: 6px;"></i>
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                </button>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h1 style="margin: 0; color: var(--text-main);">ğŸ“‘ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª</h1>
                    <button class="btn" onclick="openAddTabModal()" style="padding: 12px 24px;">
                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ØªØ¨ÙˆÙŠØ¨Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>

                <div id="tabs-list" class="stats-grid"
                    style="grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                    <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ØªÙØ­Ù…Ù‘Ù„ Ù‡Ù†Ø§ -->
                </div>
            </div>

            <!-- WhatsApp Tab -->
            <div id="whatsapp-tab" class="tab-content">
                <button onclick="switchTab('dashboard')"
                    style="background: var(--bg-secondary); border: none; padding: 10px 16px; border-radius: var(--radius-sm); cursor: pointer; color: var(--primary); font-weight: 600; margin-bottom: 1.5rem; transition: all 0.3s;"
                    onmouseover="this.style.background='var(--primary)'; this.style.color='white'"
                    onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--primary)'">
                    <i class="fas fa-arrow-right" style="margin-left: 6px;"></i>
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                </button>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div>
                        <h1 style="margin: 0; color: var(--text-main);">
                            <i class="fab fa-whatsapp" style="color: var(--primary);"></i>
                            Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù„Ø³Ø§Øª Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
                        </h1>
                        <p style="color: var(--text-muted); margin-top: 8px;">Ù‚Ù… Ø¨Ø±Ø¨Ø· ÙˆØ¥Ø¯Ø§Ø±Ø© Ø¬Ù„Ø³Ø§Øª Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                        </p>
                    </div>
                    <button onclick="openAddSessionModal()" class="btn" style="padding: 12px 24px;">
                        <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>

                <!-- Stats Overview -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-box">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div
                                style="width: 50px; height: 50px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-plug" style="color: var(--primary); font-size: 1.5rem;"></i>
                            </div>
                            <div>
                                <div class="label">Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ØªØµÙ„Ø©</div>
                                <div class="number" id="stats-connected-sessions">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div
                                style="width: 50px; height: 50px; border-radius: 50%; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-list" style="color: var(--text-muted); font-size: 1.5rem;"></i>
                            </div>
                            <div>
                                <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</div>
                                <div class="number" id="stats-total-sessions">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sessions Table -->
                <div class="card-auth" style="max-width: 100%; padding: 0; overflow: hidden;">
                    <table class="data-table" id="sessions-table">
                        <thead>
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø¬Ù„Ø³Ø©</th>
                                <th>Ø§Ù„Ù…Ø§Ù„Ùƒ (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)</th>
                                <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="sessions-tbody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- User Sessions Modal -->
    <div id="user-sessions-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="user-sessions-title">Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
                <button class="modal-close" onclick="closeModal('user-sessions-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Profile Info Section (for admin or user details) -->
                <div id="user-profile-info"
                    style="margin-bottom: 2rem; display: none; padding: 1.5rem; background: var(--bg-secondary); border-radius: var(--radius-md); border-right: 4px solid var(--primary);">
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                        <div>
                            <label
                                style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px;">Ø§Ù„Ø¨Ø±ÙŠØ¯
                                Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <div id="prof-email" style="font-weight: 600; color: var(--text-main);"></div>
                        </div>
                        <div>
                            <label
                                style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px;">Ø±Ù‚Ù…
                                Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <div id="prof-phone" style="font-weight: 600; color: var(--text-main);"></div>
                        </div>
                        <div>
                            <label
                                style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px;">ØªØ§Ø±ÙŠØ®
                                Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</label>
                            <div id="prof-date" style="font-weight: 600; color: var(--text-main);"></div>
                        </div>
                        <div>
                            <label
                                style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px;">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                            <div id="prof-role" style="font-weight: 600; color: var(--text-main);"></div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø¬Ù„Ø³Ø©</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="user-sessions-tbody">
                            <!-- Sessions will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
                <button class="modal-close" onclick="closeModal('edit-user-modal')">&times;</button>
            </div>
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id">
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø§Ø³Ù…</label>
                    <input type="text" id="edit-user-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="edit-user-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" id="edit-user-phone" class="form-control" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </form>
        </div>
    </div>

    <!-- Edit Subscription Modal -->
    <div id="edit-subscription-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h2>
                <button class="modal-close" onclick="closeModal('edit-subscription-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-subscription-form">
                    <input type="hidden" id="sub-edit-user-id">
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                        <input type="text" id="sub-edit-user-name" class="form-control" readonly
                            style="background: var(--bg-secondary);">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
                        <input type="datetime-local" id="sub-edit-start" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
                        <input type="datetime-local" id="sub-edit-end" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                        <select id="sub-edit-status" class="form-control">
                            <option value="active">Ù†Ø´Ø· (Active)</option>
                            <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (Pending)</option>
                            <option value="expired">Ù…Ù†ØªÙ‡ÙŠ (Expired)</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn"
                            style="background: var(--bg-secondary); color: var(--text-main);"
                            onclick="closeModal('edit-subscription-modal')">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div style="margin-bottom: 20px;">
                <i class="fas fa-question-circle" style="font-size: 4rem; color: var(--primary); opacity: 0.8;"></i>
            </div>
            <h3 id="confirm-title" style="margin-bottom: 10px; color: var(--text-main);">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h3>
            <p id="confirm-message" style="color: var(--text-muted); margin-bottom: 25px; line-height: 1.6;">Ù‡Ù„ Ø£Ù†Øª
                Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØªÙ…Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="confirm-btn-yes" class="btn btn-primary" style="min-width: 100px;">Ù†Ø¹Ù…ØŒ ØªØ§Ø¨Ø¹</button>
                <button id="confirm-btn-no" class="btn btn-outline" style="min-width: 100px;"
                    onclick="closeModal('confirm-modal')">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Reject Reason Modal -->
    <div id="reject-modal" class="modal" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶</h2>
                <button class="modal-close" onclick="closeModal('reject-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 15px;">ÙŠØ±Ø¬Ù‰ Ø°ÙƒØ± Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…):</p>
                <textarea id="reject-reason" class="form-control" rows="4" placeholder="Ù…Ø«Ø§Ù„: ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ ØºÙŠØ± ÙˆØ§Ø¶Ø­Ø©..."
                    style="resize: none;"></textarea>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-outline" onclick="closeModal('reject-modal')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button id="reject-confirm-btn" class="btn btn-danger">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"
        style="position: fixed; bottom: 30px; left: 30px; z-index: 3000; display: flex; flex-direction: column; gap: 10px;">
    </div>

    <style>
        .toast {
            background: var(--bg-card);
            border-left: 4px solid var(--primary);
            padding: 15px 20px;
            border-radius: var(--radius-sm);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideInLeft 0.3s ease-out forwards;
            color: var(--text-main);
        }

        .toast.success {
            border-left-color: #25D366;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.info {
            border-left-color: #667eea;
        }

        .toast-icon {
            font-size: 1.2rem;
        }

        .toast.success .toast-icon {
            color: #25D366;
        }

        .toast.error .toast-icon {
            color: #ef4444;
        }

        .toast.info .toast-icon {
            color: #667eea;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(10px);
            }
        }
    </style>

    <!-- Create Plan Modal -->
    <div id="create-plan-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                <button class="modal-close" onclick="closeModal('create-plan-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="create-plan-form">
                    <div class="form-group">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ù‚Ø©</label>
                        <input type="text" id="plan-name" class="form-control" required
                            placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ø§Ù„Ù…Ø¯Ø© (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</label>
                            <input type="number" id="plan-duration" class="form-control" required placeholder="30">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ø§Ù„Ø³Ø¹Ø± (Ø¬Ù†ÙŠÙ‡)</label>
                            <input type="number" id="plan-price" class="form-control" required placeholder="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø£Ù‚ØµÙ‰ Ø¹Ø¯Ø¯ Ø¬Ù„Ø³Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨</label>
                        <input type="number" id="plan-max-sessions" class="form-control" required value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="plan-trial" style="accent-color: var(--primary);">
                            <span>Ø¨Ø§Ù‚Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ø¬Ø§Ù†ÙŠØ©</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¨Ø§Ù‚Ø©</label>
                        <div class="features-grid"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px;">
                            <label class="feature-checkbox">
                                <input type="checkbox" id="feature-prayer" checked>
                                <span>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="feature-adhkar" checked>
                                <span>Ø§Ù„Ø£Ø°ÙƒØ§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="feature-morning-evening">
                                <span>Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­ ÙˆØ§Ù„Ù…Ø³Ø§Ø¡</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="feature-before-after">
                                <span>Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯ Ø§Ù„ØµÙ„Ø§Ø©</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="feature-quran">
                                <span>Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="feature-hadith">
                                <span>Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠÙ</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="feature-fasting">
                                <span>ØªØ°ÙƒÙŠØ± Ø§Ù„ØµÙŠØ§Ù…</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="feature-rosary">
                                <span>Ø§Ù„Ø³Ø¨Ø­Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="feature-support">
                                <span>Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</span>
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn"
                            style="background: var(--bg-secondary); color: var(--text-main);"
                            onclick="closeModal('create-plan-modal')">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="btn btn-primary">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø§Ù‚Ø©</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Plan Modal -->
    <div id="edit-plan-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø©</h2>
                <button class="modal-close" onclick="closeModal('edit-plan-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-plan-form">
                    <input type="hidden" id="edit-plan-id">
                    <div class="form-group">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ù‚Ø©</label>
                        <input type="text" id="edit-plan-name" class="form-control" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ø§Ù„Ù…Ø¯Ø© (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</label>
                            <input type="number" id="edit-plan-duration" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ø§Ù„Ø³Ø¹Ø± (Ø¬Ù†ÙŠÙ‡)</label>
                            <input type="number" step="0.01" id="edit-plan-price" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø£Ù‚ØµÙ‰ Ø¹Ø¯Ø¯ Ø¬Ù„Ø³Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨</label>
                        <input type="number" id="edit-plan-max-sessions" class="form-control" required min="1">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="edit-plan-trial" style="accent-color: var(--primary);">
                            <span>Ø¨Ø§Ù‚Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¨Ø§Ù‚Ø©</label>
                        <div class="features-grid"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px;">
                            <label class="feature-checkbox">
                                <input type="checkbox" id="edit-feature-prayer">
                                <span>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="edit-feature-adhkar">
                                <span>Ø§Ù„Ø£Ø°ÙƒØ§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="edit-feature-morning-evening">
                                <span>Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­ ÙˆØ§Ù„Ù…Ø³Ø§Ø¡</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="edit-feature-before-after">
                                <span>Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯ Ø§Ù„ØµÙ„Ø§Ø©</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="edit-feature-quran">
                                <span>Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="edit-feature-hadith">
                                <span>Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠÙ</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="edit-feature-fasting">
                                <span>ØªØ°ÙƒÙŠØ± Ø§Ù„ØµÙŠØ§Ù…</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="edit-feature-rosary">
                                <span>Ø§Ù„Ø³Ø¨Ø­Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</span>
                            </label>
                            <label class="feature-checkbox">
                                <input type="checkbox" id="edit-feature-support">
                                <span>Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</span>
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn"
                            style="background: var(--bg-secondary); color: var(--text-main);"
                            onclick="closeModal('edit-plan-modal')">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        .feature-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .feature-checkbox:hover {
            background: var(--border);
        }

        .feature-checkbox input {
            accent-color: var(--primary);
            width: 16px;
            height: 16px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
    </style>

    <!-- Add WhatsApp Session Modal -->
    <div id="add-session-modal" class="modal">
        <div class="modal-content" style="max-width: 500px; border-radius: 24px;">
            <div class="modal-header"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: none; padding-bottom: 0;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 1.4rem;">
                    <div
                        style="width: 40px; height: 40px; background: var(--primary-light); color: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fab fa-whatsapp"></i>
                    </div>
                    Ø¥Ø¶Ø§ÙØ© Ø¬Ù„Ø³Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯Ø©
                </h2>
                <button class="modal-close" onclick="closeModal('add-session-modal')"
                    style="background: var(--bg-secondary); border: none; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-muted); transition: 0.2s;">
                    &times;
                </button>
            </div>

            <form id="add-session-form">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="font-weight: 600; margin-bottom: 8px; display: block;">
                        <i class="fas fa-tag" style="margin-left: 5px; color: var(--primary); opacity: 0.7;"></i>
                        Ø§Ø³Ù… Ø§Ù„Ø¬Ù„Ø³Ø© <span style="color: var(--danger);">*</span>
                    </label>
                    <input type="text" id="session-name" class="form-control" placeholder="Ù…Ø«Ø§Ù„: ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…ØªØ¬Ø±" required
                        style="padding: 12px 15px; border-radius: 12px;">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="font-weight: 600; margin-bottom: 8px; display: block;">
                        <i class="fas fa-phone" style="margin-left: 5px; color: var(--primary); opacity: 0.7;"></i>
                        Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ <span style="color: var(--danger);">*</span>
                    </label>
                    <div style="display: flex; gap: 10px;">
                        <div style="position: relative; width: 140px;">
                            <input type="text" id="country-search" class="form-control" placeholder="Ø¯ÙˆÙ„Ø©..."
                                style="padding-right: 35px; border-radius: 12px; padding-top: 12px; padding-bottom: 12px;"
                                onkeyup="searchCountries()" onfocus="showCountryList()">
                            <div id="selected-flag"
                                style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 1.25rem;">
                                ğŸ‡ªğŸ‡¬</div>
                            <input type="hidden" id="country-code" value="+20">
                            <div id="country-dropdown"
                                style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: var(--shadow-lg); margin-top: 5px;">
                            </div>
                        </div>
                        <div
                            style="flex: 1; position: relative; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; padding: 0 12px;">
                            <span id="display-prefix"
                                style="color: var(--text-muted); font-weight: 600; margin-left: 8px; border-left: 1px solid var(--border); padding-left: 8px; direction: ltr;">+20</span>
                            <input type="tel" id="session-phone" class="form-control" placeholder="123456789" required
                                style="background: transparent; border: none; box-shadow: none; padding: 12px 0; direction: ltr; text-align: left; flex: 1; font-weight: 600;">
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 25px;">
                    <label class="form-label" style="font-weight: 600; margin-bottom: 8px; display: block;">
                        <i class="fas fa-link" style="margin-left: 5px; color: var(--primary); opacity: 0.7;"></i>
                        Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    </label>
                    <input type="url" id="session-webhook" class="form-control"
                        placeholder="https://example.com/webhook" style="padding: 12px 15px; border-radius: 12px;">
                    <small style="color: var(--text-muted); display: block; margin-top: 5px; font-size: 0.8rem;">Ø±Ø§Ø¨Ø·
                        Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</small>
                </div>

                <button type="submit" class="btn"
                    style="width: 100%; padding: 14px; font-size: 1.05rem; font-weight: 700; border-radius: 14px; box-shadow: 0 4px 15px var(--primary-light);">
                    <i class="fas fa-qrcode" style="margin-left: 8px;"></i>
                    Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ø¨Ø· Ø§Ù„Ø¬Ù„Ø³Ø©
                </button>
            </form>
        </div>
    </div>

    <!-- QR Code Popup (User Style) -->
    <!-- SmartWats-style Connection Page Modal -->
    <div id="smartwats-connection-modal" class="modal" style="z-index: 3000;">
        <div class="modal-content" style="max-width: 600px; padding: 0;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border-radius: var(--radius-md) var(--radius-md) 0 0;">
                <h2 style="margin: 0; color: white;">
                    <i class="fab fa-whatsapp" style="margin-left: 8px;"></i>
                    Ø±Ø¨Ø· Ø¬Ù„Ø³Ø© ÙˆØ§ØªØ³Ø§Ø¨
                </h2>
                <button class="modal-close" onclick="closeSmartWatsModal()" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 2rem; background: var(--bg-main);">
                <!-- Instance ID Section -->
                <div
                    style="background: white; padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; border: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-key" style="color: var(--text-muted);"></i>
                        <label style="font-weight: 600; color: var(--text-main);">Instance ID - Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ù…ÙŠØ²:</label>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: var(--radius-sm); font-family: monospace; font-size: 1.1rem; font-weight: 700; color: #25D366; text-align: center; letter-spacing: 2px;"
                        id="smartwats-instance-id">
                        --------
                    </div>
                </div>

                <!-- QR Code Section -->
                <div id="smartwats-qr-section"
                    style="background: white; padding: 2rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; border: 1px solid var(--border); text-align: center;">
                    <h3 style="margin: 0 0 1rem 0; color: var(--text-main); font-size: 1.1rem;">Ø§Ù…Ø³Ø­ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
                        QRCODE</h3>
                    <div style="position: relative; display: inline-block; margin-bottom: 1rem;">
                        <img id="smartwats-qr-image" src=""
                            style="width: 250px; height: 250px; border-radius: var(--radius-md); border: 3px solid var(--border); display: none;">
                        <div id="smartwats-qr-loading" style="padding: 2rem;">
                            <div class="spinner"></div>
                            <p style="margin-top: 1rem; color: var(--text-muted);">Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©...</p>
                        </div>
                    </div>
                    <div
                        style="background: rgba(255, 193, 7, 0.1); border-right: 3px solid #FFC107; padding: 12px; border-radius: var(--radius-sm); text-align: right; margin-top: 1rem;">
                        <p style="margin: 0; font-size: 0.85rem; line-height: 1.6; color: var(--text-main);">
                            <strong>âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙŠØµØ¨Ø­ ØºÙŠØ± ØµØ§Ù„Ø­ Ø¨Ø¹Ø¯ 40 Ø«Ø§Ù†ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø·.<br>
                            Ù‚Ù… Ø¨Ø¹Ù…Ù„ ØªØ­Ø¯ÙŠØ« Ù„Ù„ØµÙØ­Ø© ÙˆÙ‚Ù… Ø¨Ø¹Ù…Ù„ Ù…Ø³Ø­ Ù„Ù„Ø±Ù…Ø² Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
                        </p>
                        <button onclick="refreshSmartWatsQR(currentSmartWatsSessionId)"
                            style="margin-top: 10px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-size: 0.85rem; width: 100%;">
                            <i class="fas fa-sync-alt" style="margin-left: 5px;"></i> ØªØ­Ø¯ÙŠØ« Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
                        </button>
                    </div>
                </div>

                <!-- Pairing Code Section -->
                <div
                    style="background: white; padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; border: 2px dashed #f44336;">
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; color: #f44336; font-size: 1rem;">
                            <i class="fas fa-mobile-alt" style="margin-left: 5px;"></i>
                            Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¨Ø· / Ø±Ù…Ø² Ø§Ù„Ø§Ù‚ØªØ±Ø§Ù†
                        </h3>
                    </div>

                    <!-- Pairing Code Display -->
                    <div id="smartwats-pairing-code-display"
                        style="display: none; text-align: center; margin-bottom: 1rem;">
                        <div
                            style="background: rgba(37, 211, 102, 0.1); border: 2px solid #25D366; padding: 15px; border-radius: var(--radius-md); margin-bottom: 1rem;">
                            <p
                                style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--text-main); font-weight: 600;">
                                <i class="fab fa-whatsapp" style="color: #25D366; margin-left: 5px;"></i>
                                ÙŠØ¬Ø¨ Ø£Ù† ÙŠØµÙ„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ÙŠØ·Ù„Ø¨ Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø²
                            </p>
                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">
                                ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ø®Ù„ - Ø§ÙØªØ­ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§Ø¶ØºØ· "ØªØ£ÙƒÙŠØ¯"
                            </p>
                        </div>
                        <div
                            style="background: var(--bg-secondary); padding: 20px; border-radius: var(--radius-md); margin-bottom: 1rem;">
                            <p style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--text-muted);">ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¨Ø·:</p>
                            <div style="font-size: 2rem; font-weight: 800; letter-spacing: 8px; color: var(--primary); font-family: monospace; user-select: all; cursor: pointer;"
                                id="smartwats-pairing-code-value" onclick="copySmartWatsPairingCode()">
                                --------
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 10px; justify-content: center;">
                                <button onclick="copySmartWatsPairingCode()"
                                    style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-size: 0.85rem;">
                                    <i class="fas fa-copy" style="margin-left: 5px;"></i> Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯
                                </button>
                                <button
                                    onclick="document.getElementById('smartwats-pairing-code-display').style.display='none'; document.getElementById('smartwats-pairing-form').style.display='block';"
                                    style="padding: 8px 16px; background: var(--bg-secondary); color: var(--text-main); border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; font-size: 0.85rem;">
                                    <i class="fas fa-redo" style="margin-left: 5px;"></i> Ø·Ù„Ø¨ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Pairing Code Form -->
                    <div id="smartwats-pairing-form">
                        <div style="display: flex; gap: 8px; margin-bottom: 1rem;">
                            <input type="tel" id="smartwats-phone-input" placeholder="+201066284516 Ø£Ùˆ 201066284516"
                                style="flex: 1; padding: 12px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--bg-main); direction: ltr; text-align: left;">
                            <button onclick="requestSmartWatsPairingCode()" id="smartwats-get-code-btn" class="btn"
                                style="white-space: nowrap; padding: 12px 20px;">
                                <i class="fas fa-key" style="margin-left: 5px;"></i> Ø·Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯
                            </button>
                        </div>
                        <div
                            style="background: rgba(33, 150, 243, 0.1); border-right: 3px solid #2196F3; padding: 10px; border-radius: var(--radius-sm); text-align: right; margin-bottom: 1rem;">
                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-main); line-height: 1.5;">
                                ğŸ’¡ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ <strong>Ø¨Ù†ÙØ³ Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</strong> ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ.
                            </p>
                        </div>
                        <div
                            style="background: rgba(37, 211, 102, 0.1); border: 1px solid rgba(37, 211, 102, 0.3); padding: 10px; border-radius: var(--radius-sm); text-align: right;">
                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-main); line-height: 1.5;">
                                <strong>ğŸ“± Ø¨Ø¹Ø¯ Ø·Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯:</strong><br>
                                1. Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ø®Ù„<br>
                                2. Ø§ÙØªØ­ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§Ø¶ØºØ· "ØªØ£ÙƒÙŠØ¯" Ù„Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø²<br>
                                3. Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 8 Ø£Ø±Ù‚Ø§Ù… ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Instructions Section -->
                <div
                    style="background: rgba(37, 211, 102, 0.1); border: 1px solid rgba(37, 211, 102, 0.3); border-radius: var(--radius-md); padding: 1.5rem; text-align: right;">
                    <p style="margin: 0 0 10px 0; font-weight: 600; color: var(--text-main);">
                        <i class="fab fa-whatsapp" style="color: #25D366; margin-left: 5px;"></i>
                        Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø±Ø¨Ø·:
                    </p>
                    <ol
                        style="margin: 0; padding: 0 20px 0 0; font-size: 0.9rem; line-height: 2; color: var(--text-main);">
                        <li>Ø§ÙØªØ­ <strong>ÙˆØ§ØªØ³Ø§Ø¨</strong> Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„</li>
                        <li>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰: <strong>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âš™ï¸ â† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© ğŸ“±</strong></li>
                        <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ <strong>"Ø±Ø¨Ø· Ø¬Ù‡Ø§Ø²"</strong></li>
                        <li>Ø§Ù…Ø³Ø­ Ø±Ù…Ø² QR Ø£Ùˆ Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¨Ø· (8 Ø£Ø±Ù‚Ø§Ù…)</li>
                        <li>âœ… Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹!</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div id="qr-popup" class="qr-popup">
        <div class="qr-content" style="border-radius: 32px; overflow: hidden; color: white;">
            <button onclick="closeQRPopup()"
                style="position:absolute; top:20px; right:20px; background: rgba(255,255,255,0.1); border:none; cursor:pointer; width: 36px; height: 36px; border-radius: 50%; color: inherit; display: flex; align-items: center; justify-content: center; z-index: 10; transition: 0.2s;">
                <i class="fas fa-times"></i>
            </button>

            <div id="status-waiting" style="padding: 20px 0;">
                <div class="spinner"></div>
                <h3 style="margin-top: 20px; font-weight: 600;">Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø§ØªØµØ§Ù„</h3>
                <p style="opacity: 0.7; font-size: 0.95rem;">Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©...</p>
            </div>

            <div id="status-connecting" style="display:none; padding: 10px 0;">
                <div style="margin-bottom: 25px;">
                    <h3 id="display-device" style="margin: 0 0 5px 0; font-size: 1.5rem; font-weight: 700;">Android</h3>
                    <div
                        style="display: inline-flex; align-items: center; gap: 6px; background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                        <i class="fas fa-link"></i> <span id="display-session-name">Session</span>
                    </div>
                </div>

                <div
                    style="position: relative; padding: 15px; background: white; border-radius: 24px; display: inline-block; box-shadow: 0 10px 25px rgba(0,0,0,0.2); margin-bottom: 25px;">
                    <img id="qr-popup-image" src="" style="width:230px; height:230px; display: block;">
                </div>

                <div
                    style="background: rgba(var(--primary-rgb), 0.1); padding: 15px; border-radius: 16px; margin-bottom: 20px; color: var(--text-main); text-align: right;">
                    <p style="margin: 0; font-weight: 600; font-size: 0.95rem; margin-bottom: 8px;">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø±Ø¨Ø·:</p>
                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.85rem; opacity: 0.9;">
                        <li style="margin-bottom: 5px;"><i class="fas fa-circle"
                                style="font-size: 0.4rem; vertical-align: middle; margin-left: 8px;"></i>Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù„Ù‰
                            Ù‡Ø§ØªÙÙƒ</li>
                        <li style="margin-bottom: 5px;"><i class="fas fa-circle"
                                style="font-size: 0.4rem; vertical-align: middle; margin-left: 8px;"></i>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰
                            Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ùˆ Ø§Ù„Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø·</li>
                        <li><i class="fas fa-circle"
                                style="font-size: 0.4rem; vertical-align: middle; margin-left: 8px;"></i>Ø§Ø®ØªØ± "Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
                            Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©" Ø«Ù… "Ø±Ø¨Ø· Ø¬Ù‡Ø§Ø²"</li>
                    </ul>
                </div>

                <div style="margin-top: 20px; text-align: center;">
                    <p style="font-size: 0.85rem; margin-bottom: 12px; opacity: 0.8;">Ø£Ùˆ</p>
                    <button id="toggle-phone-link-btn-admin" onclick="togglePhoneLinkAdmin()"
                        style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; opacity: 1; width: 100%; font-weight: 600; margin-bottom: 12px;">
                        <i class="fas fa-mobile-alt" style="margin-left: 5px;"></i> Ø±Ø¨Ø· Ø¨ÙˆØ§Ø³Ø·Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
                    </button>

                    <div id="phone-link-form-admin"
                        style="display: none; margin-top: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; text-align: right;">
                        <p style="font-size: 0.9rem; margin-bottom: 8px; font-weight: 600;">ğŸ“ Ø§Ù„Ø±Ø¨Ø· Ø¹Ø¨Ø± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</p>
                        <p style="font-size: 0.8rem; margin-bottom: 12px; opacity: 0.8; line-height: 1.5;">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…
                            Ø§Ù„Ù‡Ø§ØªÙ <strong>Ø¨Ù†ÙØ³ Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</strong> ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ:</p>
                        <div
                            style="background: rgba(255, 193, 7, 0.1); border-right: 3px solid #FFC107; padding: 8px; border-radius: 6px; margin-bottom: 10px;">
                            <p style="font-size: 0.75rem; margin: 0; line-height: 1.4;">
                                âš ï¸ <strong>Ù…Ù‡Ù…:</strong> Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ â†’ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ<br>
                                ÙˆØ§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø§Ù„Ø¶Ø¨Ø· ÙƒÙ…Ø§ ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯Ùƒ (Ù…Ø¹ Ø£Ùˆ Ø¨Ø¯ÙˆÙ† +20)
                            </p>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                            <button onclick="requestPairingCodeAdmin()" id="get-code-btn-admin" class="btn"
                                style="white-space: nowrap; padding: 10px 18px; font-size: 0.9rem; font-weight: 600;">
                                <i class="fas fa-key" style="margin-left: 5px;"></i> ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯
                            </button>
                            <input type="tel" id="pairing-phone-admin"
                                placeholder="+201066284516 Ø£Ùˆ 201066284516 Ø£Ùˆ 01066284516"
                                style="flex: 1; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; direction: ltr; text-align: left; font-size: 0.95rem;">
                        </div>
                        <div
                            style="background: rgba(33, 150, 243, 0.1); border-right: 3px solid #2196F3; padding: 10px; border-radius: 6px; margin-top: 10px;">
                            <p style="font-size: 0.75rem; margin: 0; opacity: 0.9;">ğŸ’¡ Ø³ÙŠØ¸Ù‡Ø± ÙƒÙˆØ¯ Ù…ÙƒÙˆÙ† Ù…Ù† 8 Ø£Ø±Ù‚Ø§Ù… ØªØ¯Ø®Ù„Ù‡
                                ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨</p>
                        </div>
                    </div>

                    <div id="pairing-code-display-admin"
                        style="display: none; margin-top: 15px; text-align: center; animation: fadeIn 0.3s ease;">
                        <p style="font-size: 0.9rem; margin-bottom: 10px; font-weight: 600;">âœ… ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¨Ø· Ø¬Ø§Ù‡Ø²:</p>
                        <div style="background: white; color: #333; font-size: 2rem; font-weight: 800; letter-spacing: 8px; padding: 20px; border-radius: 12px; user-select: all; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin-bottom: 15px; display: flex; justify-content: center; gap: 5px;"
                            onclick="copyPairingCodeAdmin()">
                            <span id="pairing-code-value-admin">------</span>
                            <i class="fas fa-copy"
                                style="font-size: 1rem; color: #999; align-self: flex-start; margin-top: 5px;"></i>
                        </div>
                        <div
                            style="background: rgba(37, 211, 102, 0.15); border: 1px solid rgba(37, 211, 102, 0.3); border-radius: 12px; padding: 15px; margin-bottom: 15px; text-align: right;">
                            <p style="font-size: 0.9rem; margin: 0 0 8px 0; font-weight: 600;">ğŸ“± Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø±Ø¨Ø·:</p>
                            <ol style="font-size: 0.82rem; margin: 0; padding: 0 20px 0 0; line-height: 1.7;">
                                <li>Ø§ÙØªØ­ <strong>ÙˆØ§ØªØ³Ø§Ø¨</strong> Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„</li>
                                <li>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰: <strong>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âš™ï¸ â† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© ğŸ“±</strong></li>
                                <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ <strong>"Ø±Ø¨Ø· Ø¬Ù‡Ø§Ø²"</strong></li>
                                <li>ÙÙŠ Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©ØŒ Ø§Ø¶ØºØ· <strong>"Ø±Ø¨Ø· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ"</strong></li>
                                <li>Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ø£Ø¹Ù„Ø§Ù‡ (<strong>8 Ø£Ø±Ù‚Ø§Ù…</strong>)</li>
                                <li>âœ… Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹!</li>
                            </ol>
                        </div>
                        <button onclick="requestPairingCodeAdmin()" class="btn"
                            style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); margin-bottom: 15px;">Ø·Ù„Ø¨
                            ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</button>
                        <div
                            style="background: rgba(244, 67, 54, 0.1); border-right: 3px solid #f44336; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                            <p style="font-size: 0.75rem; margin: 0; line-height: 1.4;">
                                âš ï¸ <strong>Ø¥Ø°Ø§ Ø¸Ù‡Ø±Øª Ø±Ø³Ø§Ù„Ø© "ØªØ¹Ø°Ø± Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø²":</strong><br>
                                â€¢ ØªØ£ÙƒØ¯ Ø£Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…ÙØ¯Ø®Ù„ Ù…Ø·Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ø§Ù‹ Ù„Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨<br>
                                â€¢ Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ â†’ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ<br>
                                â€¢ Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù… Ø¨Ø§Ù„Ø¶Ø¨Ø· ÙƒÙ…Ø§ ÙŠØ¸Ù‡Ø± ÙˆØ§Ø·Ù„Ø¨ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯
                            </p>
                        </div>
                        <div
                            style="font-size: 0.8rem; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                            <p style="margin: 0;">ğŸ’¡ Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§ØªØ³Ø§Ø¨</p>
                        </div>
                    </div>
                </div>

                <button onclick="refreshQRCode()" class="btn btn-sm"
                    style="margin-top:10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                    <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù…Ø²
                </button>
            </div>

            <div id="status-connected" style="display:none; padding: 40px 0; color: #25D366;">
                <div
                    style="width: 100px; height: 100px; background: #25D366; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; box-shadow: 0 0 30px rgba(37, 211, 102, 0.4);">
                    <i class="fas fa-check" style="font-size: 3.5rem;"></i>
                </div>
                <h2 style="margin: 0 0 10px 0; font-weight: 800; color: white;">ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!</h2>
                <p style="opacity: 0.8; color: white;">ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¢Ù†</p>
            </div>

            <div id="status-error" style="display:none; padding: 40px 0;">
                <div
                    style="width: 80px; height: 80px; background: #f44336; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <i class="fas fa-exclamation" style="font-size: 2.5rem;"></i>
                </div>
                <h3 id="error-message" style="margin: 0 0 15px 0;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</h3>
                <button onclick="closeQRPopup()" class="btn"
                    style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <!-- Content Library Tab -->
    <div id="content_library-tab" class="tab-content">
        <div class="content-header">
            <div>
                <h2 class="content-title">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ</h2>
                <p class="text-muted">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø°ÙƒØ§Ø± ÙˆØ§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯ÙŠÙ†ÙŠ</p>
            </div>
            <button class="btn btn-primary" onclick="openContentModal()">
                <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯
            </button>
        </div>

        <!-- Filters -->
        <div class="filters-bar" style="margin-bottom: 20px;">
            <div class="filter-group">
                <button class="filter-btn active" onclick="filterContent('all')" data-content-filter="all">Ø§Ù„ÙƒÙ„</button>
                <button class="filter-btn" onclick="filterContent('adhkar')"
                    data-content-filter="adhkar">Ø§Ù„Ø£Ø°ÙƒØ§Ø±</button>
                <button class="filter-btn" onclick="filterContent('hadith')"
                    data-content-filter="hadith">Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«</button>
            </div>
        </div>

        <div class="card">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                            <th>Ø§Ù„Ù…Ø­ØªÙˆÙ‰</th>
                            <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="content-library-tbody">
                        <!-- Content will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Content Modal -->
    <div id="content-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-book-open"></i> <span id="content-modal-title">Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰</span></h2>
                <button class="modal-close" onclick="closeContentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="content-id">
                <div class="form-group">
                    <label>Ø§Ù„Ù†ÙˆØ¹</label>
                    <select id="content-type" class="form-control">
                        <option value="adhkar">Ø£Ø°ÙƒØ§Ø±</option>
                        <option value="hadith">Ø­Ø¯ÙŠØ« Ù†Ø¨ÙˆÙŠ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                    <input type="text" id="content-category" class="form-control"
                        placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ØµØ¨Ø§Ø­ØŒ Ø§Ù„Ù…Ø³Ø§Ø¡ØŒ Ø¹Ø§Ù…">
                </div>
                <div class="form-group">
                    <label>Ù†Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
                    <textarea id="content-text" class="form-control" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§..."></textarea>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…ØµØ¯Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="text" id="content-source" class="form-control" placeholder="Ù…Ø«Ø§Ù„: ØµØ­ÙŠØ­ Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ">
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeContentModal()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button class="btn btn-primary" onclick="saveContent()">Ø­ÙØ¸</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- TOAST NOTIFICATION SYSTEM ---


        // Override native alert
        window.alert = function (msg) {
            const type = (msg.includes('Ù†Ø¬Ø§Ø­') || msg.includes('ØªÙ…')) ? 'success' : 'error';
            showToast(msg, type);
        };

        // Sidebar Toggle
        function toggleAdminSidebar() {
            const sidebar = document.querySelector('.admin-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const header = document.getElementById('admin-header');

            sidebar.classList.toggle('open');

            if (sidebar.classList.contains('open')) {
                if (overlay) overlay.style.display = 'block';
                if (header) header.classList.add('sidebar-open');
            } else {
                if (overlay) overlay.style.display = 'none';
                if (header) header.classList.remove('sidebar-open');
            }
        }

        // Close sidebar when clicking outside
        document.addEventListener('click', function (event) {
            const sidebar = document.querySelector('.admin-sidebar');
            const toggleBtn = document.querySelector('#mobile-menu-toggle');
            const sidebarCloseBtn = document.querySelector('.sidebar-close-btn');

            if (window.innerWidth <= 1024 && sidebar.classList.contains('open')) {
                // Check if click is outside sidebar and not on toggle buttons
                const isOutside = !sidebar.contains(event.target) &&
                    !toggleBtn?.contains(event.target) &&
                    !sidebarCloseBtn?.contains(event.target);

                if (isOutside) {
                    sidebar.classList.remove('open');
                }
            }
        });

        // Close sidebar when clicking on a nav item
        document.querySelectorAll('.admin-nav-item').forEach(item => {
            item.addEventListener('click', function () {
                if (window.innerWidth <= 1024) {
                    document.querySelector('.admin-sidebar').classList.remove('open');
                }
            });
        });

        // Sidebar Toggle
        function toggleSidebar() {
            const sidebar = document.querySelector('.admin-sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            const header = document.getElementById('admin-header');

            sidebar.classList.toggle('open');

            if (sidebar.classList.contains('open')) {
                overlay.style.display = 'block';
                if (header) header.classList.add('sidebar-open');
            } else {
                overlay.style.display = 'none';
                if (header) header.classList.remove('sidebar-open');
            }
        }

        // Sidebar Collapse/Expand
        function toggleSidebarCollapse() {
            const sidebar = document.querySelector('.admin-sidebar');
            const collapseBtn = document.querySelector('.sidebar-collapse-btn');

            sidebar.classList.toggle('collapsed');

            // Save collapsed state to localStorage
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);

            // Rotate the icon
            if (collapseBtn) {
                if (isCollapsed) {
                    collapseBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                } else {
                    collapseBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                }
            }

            // Make header respond to sidebar state
            const header = document.getElementById('admin-header');
            if (header) {
                if (isCollapsed) {
                    header.classList.add('sidebar-collapsed');
                } else {
                    header.classList.remove('sidebar-collapsed');
                }
            }
        }

        // Toggle Submenu
        function toggleSubmenu(id) {
            const submenu = document.getElementById(id);
            const trigger = document.querySelector(`[onclick="toggleSubmenu('${id}')"]`);

            if (submenu) {
                submenu.classList.toggle('open');
                if (trigger) {
                    trigger.classList.toggle('open');
                }
            }
        }

        // Load sidebar state from localStorage on page load
        function loadSidebarState() {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            const sidebar = document.querySelector('.admin-sidebar');
            const collapseBtn = document.querySelector('.sidebar-collapse-btn');

            if (isCollapsed) {
                sidebar.classList.add('collapsed');
                if (collapseBtn) {
                    collapseBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                }
                // Reflect in header
                const header = document.getElementById('admin-header');
                if (header) header.classList.add('sidebar-collapsed');
            }
        }

        // Theme Management
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme) {
            document.documentElement.setAttribute('data-theme', currentTheme);
            updateThemeIcon(currentTheme);
        }

        function toggleTheme() {
            let theme = document.documentElement.getAttribute('data-theme');
            let newTheme = theme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.querySelector('.theme-toggle i');
            if (icon) { // Check if icon exists before manipulating classes
                if (theme === 'dark') {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
            }
        }

        // Tab Switching


        // Current filter for activation requests
        let currentActivationFilter = 'all';

        // Load Unified Activation Requests (Payments + Pending Subscriptions)
        async function loadActivationRequests() {
            try {
                const res = await fetch('/api/admin/activation-requests');
                const allRequests = await res.json();
                const tbody = document.getElementById('payments-tbody');

                // Apply filter
                let filteredRequests = allRequests;
                if (currentActivationFilter === 'payments') {
                    filteredRequests = allRequests.filter(r => r.request_type === 'payment');
                } else if (currentActivationFilter === 'subscriptions') {
                    filteredRequests = allRequests.filter(r => r.request_type === 'subscription');
                }

                // Update filter counts
                const paymentsCount = allRequests.filter(r => r.request_type === 'payment').length;
                const subscriptionsCount = allRequests.filter(r => r.request_type === 'subscription').length;
                document.getElementById('filter-all-count').textContent = allRequests.length;
                document.getElementById('filter-payment-count').textContent = paymentsCount;
                document.getElementById('filter-subscription-count').textContent = subscriptionsCount;

                // Also update sidebar badge
                const paymentsBadge = document.getElementById('payments-badge');
                if (paymentsBadge) {
                    paymentsBadge.textContent = paymentsCount;
                    paymentsBadge.style.display = paymentsCount > 0 ? 'flex' : 'none';
                }

                if (filteredRequests.length === 0) {
                    tbody.innerHTML = `<tr>
                        <td colspan="9" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem; display: block;"></i>
                            <div style="font-size: 1.1rem; font-weight: 600;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</div>
                            <div style="font-size: 0.9rem; margin-top: 0.5rem;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§ âœ¨</div>
                        </td>
                    </tr>`;
                    return;
                }

                tbody.innerHTML = filteredRequests.map(req => {
                    const isPayment = req.request_type === 'payment';
                    const typeLabel = isPayment ? 'Ø·Ù„Ø¨ Ø¯ÙØ¹' : 'Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø¹Ù„Ù‚';
                    const typeColor = isPayment ? '#25D366' : '#667eea';

                    return `
                    <tr style="background: #fffbeb;">
                        <td data-label="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                            <div style="font-weight: 600;">${req.user_name}</div>
                            <small style="color: var(--text-muted);">${req.phone}</small>
                        </td>
                        <td data-label="Ø§Ù„Ø¨Ø§Ù‚Ø©">
                            <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem;">
                                ${req.plan_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                            </span>
                        </td>
                        <td data-label="Ø§Ù„Ù…Ø¨Ù„Øº" style="font-weight: bold; color: var(--primary-dark);">${req.amount} Ø¬.Ù…</td>
                        <td data-label="Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©">
                            ${isPayment ?
                            (req.method === 'vodafone_cash' ? 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´' : 'Instapay')
                            : '<span style="color: var(--text-muted);">-</span>'}
                        </td>
                        <td data-label="Ø§Ù„Ù…Ø±Ø¬Ø¹">${req.transaction_ref || '-'}</td>
                        <td data-label="Ø§Ù„Ø¥ÙŠØµØ§Ù„">
                            ${req.receipt_path ?
                            `<a href="${req.receipt_path}" target="_blank" style="color: var(--primary); text-decoration: underline;">Ø¹Ø±Ø¶ Ø§Ù„Ø¥ÙŠØµØ§Ù„ <i class="fas fa-external-link-alt"></i></a>`
                            : '-'}
                        </td>
                        <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®">${new Date(req.created_at).toLocaleDateString('ar-EG')}</td>
                        <td data-label="Ø§Ù„Ù†ÙˆØ¹">
                            <span style="background: ${typeColor}20; color: ${typeColor}; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                                <i class="fas ${isPayment ? 'fa-money-bill-wave' : 'fa-user-clock'}"></i>
                                ${typeLabel}
                            </span>
                        </td>
                        <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                            ${isPayment ? `
                                <button class="action-btn primary" onclick="approvePayment(${req.id})"><i class="fas fa-check"></i> Ù‚Ø¨ÙˆÙ„</button>
                                <button class="action-btn danger" onclick="rejectPayment(${req.id})"><i class="fas fa-times"></i> Ø±ÙØ¶</button>
                            ` : `
                                <button class="action-btn primary" onclick="approveSubscription(${req.id}, '${req.user_name}', '${req.phone}', '${req.plan_name}', ${req.duration_days})"><i class="fas fa-check"></i> ØªÙØ¹ÙŠÙ„</button>
                                <button class="action-btn danger" onclick="rejectSubscription(${req.id}, '${req.user_name}')"><i class="fas fa-times"></i> Ø±ÙØ¶</button>
                            `}
                        </td>
                    </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading activation requests:', error);
            }
        }

        function filterActivationRequests(filter) {
            currentActivationFilter = filter;

            // Update active button
            document.querySelectorAll('.activation-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-activation-filter="${filter}"]`).classList.add('active');

            loadActivationRequests();
        }

        // Helper Functions for UI


        function showConfirm(title, message, onConfirm) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;

            const modal = document.getElementById('confirm-modal');
            modal.classList.add('active');

            // Simple robust handler
            const yesBtn = document.getElementById('confirm-btn-yes');
            // Remove old listeners to prevent stacking
            const newYesBtn = yesBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);

            newYesBtn.onclick = () => {
                closeModal('confirm-modal');
                onConfirm();
            };
        }

        function showRejectModal(onConfirm) {
            const modal = document.getElementById('reject-modal');
            const reasonInput = document.getElementById('reject-reason');
            reasonInput.value = ''; // Reset
            modal.classList.add('active');

            const confirmBtn = document.getElementById('reject-confirm-btn');
            // Remove old listeners
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);

            newBtn.onclick = () => {
                const reason = reasonInput.value.trim();
                closeModal('reject-modal');
                onConfirm(reason);
            };
        }

        async function approvePayment(id) {
            showConfirm('Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹', 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù‚Ø¨ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙØ¹ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŸ', async () => {
                try {
                    const res = await fetch(`/api/admin/payments/${id}/approve`, { method: 'PUT' });
                    if (res.ok) {
                        showToast('ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                        loadActivationRequests();
                        loadStats();
                    } else {
                        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', 'error');
                    }
                } catch (e) { console.error(e); showToast('Ø­Ø¯Ø« Ø®Ø·Ø£', 'error'); }
            });
        }

        async function rejectPayment(id) {
            showRejectModal(async (reason) => {
                try {
                    const res = await fetch(`/api/admin/payments/${id}/reject`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reason: reason })
                    });

                    if (res.ok) {
                        showToast('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¯ÙØ¹ ÙˆØ¥Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….', 'info');
                        loadActivationRequests();
                    } else {
                        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
                    }
                } catch (e) { showToast('Ø­Ø¯Ø« Ø®Ø·Ø£', 'error'); }
            });
        }

        async function deletePayment(id) {
            showConfirm('Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ', async () => {
                try {
                    const res = await fetch(`/api/admin/payments/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        loadPayments();
                    } else {
                        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'error');
                    }
                } catch (e) { showToast('Ø­Ø¯Ø« Ø®Ø·Ø£', 'error'); }
            });
        }






        // Load Stats
        async function loadStats() {
            try {
                const res = await fetch('/api/admin/stats');
                const data = await res.json();
                document.getElementById('stat-users').textContent = data.totalUsers;
                const adminStat = document.getElementById('stat-admins');
                if (adminStat) adminStat.textContent = data.totalAdmins;
                document.getElementById('stat-active').textContent = data.activeSubscriptions;
                document.getElementById('stat-pending').textContent = data.pendingSubscriptions;

                // Load notifications
                loadNotifications();
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load Notifications
        // Security: Escape HTML
        function escapeHtml(text) {
            return text ? text.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") : '';
        }

        // --- Toast System ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-exclamation-circle';
            if (type === 'warning') icon = 'fa-bell';

            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <div style="flex: 1;">${message}</div>
            `;

            container.appendChild(toast);

            // Auto-remove after 5s
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }



        // Load Users
        let allUsers = [];
        let currentFilter = 'all';

        // Load Logs
        async function loadLogs() {
            const tbody = document.getElementById('logs-table-body');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';

            try {
                const res = await fetch('/api/admin/logs?limit=50');
                const logs = await res.json();

                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(log => `
                    <tr>
                        <td data-label="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                            <div class="user-info">
                                <div>${log.user_name || 'System / Unknown'}</div>
                                <div class="text-muted" style="font-size: 0.8rem;">${log.user_email || ''}</div>
                            </div>
                        </td>
                        <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡"><span class="badge badge-info">${log.action}</span></td>
                        <td data-label="Ø§Ù„ØªÙØ§ØµÙŠÙ„" style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(log.details)}">
                            ${escapeHtml(log.details)}
                        </td>
                        <td data-label="IP">${log.ip_address || '-'}</td>
                        <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®" dir="ltr">${new Date(log.created_at).toLocaleString('ar-EG')}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading logs:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</td></tr>';
            }
        }

        // Download Backup
        function downloadBackup() {
            window.location.href = '/api/admin/backup';
        }

        async function loadUsers() {
            try {
                const dateFrom = document.getElementById('date-from')?.value;
                const dateTo = document.getElementById('date-to')?.value;

                let url = '/api/admin/users';
                const params = new URLSearchParams();
                if (dateFrom) params.append('startDate', dateFrom);
                if (dateTo) params.append('endDate', dateTo);

                if (params.toString()) url += '?' + params.toString();

                const res = await fetch(url);
                allUsers = await res.json();

                // Update counts
                updateUserCounts();

                // Display users
                displayUsers();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function updateUserCounts() {
            // Filter out admins from all counts for isolation
            const actualUsers = allUsers.filter(u => u.role !== 'admin');
            const counts = {
                all: actualUsers.length,
                active: actualUsers.filter(u => u.subscription_status === 'active' && !u.plan_name?.includes('ØªØ¬Ø±ÙŠØ¨ÙŠØ©')).length,
                trial: actualUsers.filter(u => u.plan_name?.includes('ØªØ¬Ø±ÙŠØ¨ÙŠØ©')).length,
                pending: actualUsers.filter(u => u.subscription_status === 'pending').length,
                expired: actualUsers.filter(u => !u.subscription_status || u.subscription_status === 'expired').length
            };

            document.getElementById('count-all').textContent = counts.all;
            document.getElementById('count-active').textContent = counts.active;
            document.getElementById('count-trial').textContent = counts.trial;
            document.getElementById('count-pending').textContent = counts.pending;
            document.getElementById('count-expired').textContent = counts.expired;
        }

        function displayUsers() {
            const tbody = document.getElementById('users-tbody');
            if (!tbody) return;

            // Apply filter and hide admins for isolation
            let filteredUsers = allUsers.filter(u => u.role !== 'admin');

            if (currentFilter !== 'all') {
                filteredUsers = filteredUsers.filter(user => {
                    switch (currentFilter) {
                        case 'active':
                            return user.subscription_status === 'active' || user.subscription_status === 'premium_admin';
                        case 'trial':
                            return user.plan_name?.includes('ØªØ¬Ø±ÙŠØ¨ÙŠØ©');
                        case 'pending':
                            return user.subscription_status === 'pending';
                        case 'expired':
                            return !user.subscription_status || user.subscription_status === 'expired';
                        default:
                            return true;
                    }
                });
            }

            if (filteredUsers.length === 0) {
                tbody.innerHTML = `<tr>
                    <td colspan="11" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                        <i class="fas fa-user-slash" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem; display: block; opacity: 0.5;"></i>
                        <div style="font-size: 1.1rem; font-weight: 600;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">Ø¬Ø±Ø¨ ØªØµÙ†ÙŠÙ Ø¢Ø®Ø± Ø£Ùˆ Ø§Ø¨Ø­Ø« Ø¨ÙƒÙ„Ù…Ø© Ù…Ø®ØªÙ„ÙØ©</div>
                    </td>
                </tr>`;
                return;
            }

            tbody.innerHTML = filteredUsers.map(user => {
                const joinDate = new Date(user.created_at).toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                // Generate gradient color based on user name
                const colors = [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(135deg, #30cfd0 0%, #330867 100%)'
                ];
                const colorIndex = user.name.charCodeAt(0) % colors.length;

                // Calculate subscription details
                let startDate = '-';
                let endDate = '-';
                let remainingDays = '-';
                let remainingClass = '';

                if (user.subscription_status === 'active' && user.subscription_end) {
                    const start = new Date(user.subscription_start);
                    const end = new Date(user.subscription_end);
                    const now = new Date();

                    startDate = start.toLocaleDateString('ar-EG');
                    endDate = end.toLocaleDateString('ar-EG');

                    const diffTime = end - now;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays < 0) {
                        remainingDays = 'Ù…Ù†ØªÙ‡ÙŠ';
                        remainingClass = 'text-danger';
                    } else {
                        remainingDays = diffDays + ' ÙŠÙˆÙ…';
                        if (diffDays <= 3) remainingClass = 'text-danger';
                        else if (diffDays <= 7) remainingClass = 'text-warning';
                        else remainingClass = 'text-success';
                    }
                }

                // Premium Admin Logic
                const isAdmin = user.role === 'admin';
                const premiumAdminBadge = isAdmin ?
                    `<span class="badge badge-purple" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #fff; box-shadow: 0 2px 5px rgba(255, 165, 0, 0.4); padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                        <i class="fas fa-crown"></i> Premium Admin
                    </span>` : '';

                return `
                <tr class="user-row" data-user-name="${user.name.toLowerCase()}" data-user-email="${user.email.toLowerCase()}" data-user-phone="${user.phone}">
                    <td data-label="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 45px; height: 45px; border-radius: 50%; background: ${colors[colorIndex]}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                                ${user.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight: 600; font-size: 1rem; color: var(--text-main);">${user.name}</div>
                            </div>
                        </div>
                    </td>
                    <td data-label="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-envelope" style="color: var(--text-muted); font-size: 0.85rem;"></i>
                            <span style="font-size: 0.9rem;">${user.email}</span>
                        </div>
                    </td>
                    <td data-label="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <i class="fab fa-whatsapp" style="color: var(--primary); font-size: 1rem;"></i>
                            <span style="font-weight: 500; direction: ltr; text-align: right; display: block;">${user.phone}</span>
                        </div>
                    </td>
                    <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…">
                        <div style="font-size: 0.85rem; color: var(--text-main); display: flex; align-items: center; gap: 4px;">
                            <i class="fas fa-calendar-alt" style="color: var(--text-muted); font-size: 0.8rem;"></i>
                            ${joinDate}
                        </div>
                    </td>
                    <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡" style="font-size: 0.85rem;">${startDate}</td>
                    <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" style="font-size: 0.85rem;">${endDate}</td>
                    <td data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ">
                        <span class="${remainingClass}" style="font-weight: 600; font-size: 0.85rem;">${remainingDays}</span>
                    </td>
                    <td data-label="Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©">
                        <span class="status-badge ${user.role === 'admin' ? 'status-active' : 'status-pending'}" style="display: inline-flex; align-items: center; gap: 4px;">
                            <i class="fas ${user.role === 'admin' ? 'fa-crown' : 'fa-user'}"></i>
                            ${user.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : 'Ù…Ø³ØªØ®Ø¯Ù…'}
                        </span>
                    </td>
                    <td data-label="Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
                        ${user.plan_name ?
                        `<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600; display: inline-block;">
                                ${user.plan_name}
                            </span>`
                        : '<span style="color: var(--text-muted); font-size: 0.85rem;">-</span>'}
                    </td>
                    <td data-label="Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ">
                        ${isAdmin ? premiumAdminBadge :
                        `<span class="status-badge ${user.subscription_status === 'active' ? 'status-active' : user.subscription_status === 'pending' ? 'status-pending' : 'status-expired'}" style="display: inline-flex; align-items: center; gap: 4px;">
                            <i class="fas ${user.subscription_status === 'active' ? 'fa-check-circle' : user.subscription_status === 'pending' ? 'fa-clock' : 'fa-times-circle'}"></i>
                            ${user.subscription_status === 'active' ? 'Ù†Ø´Ø·' : user.subscription_status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : user.subscription_status === 'expired' ? 'Ù…Ù†ØªÙ‡ÙŠ' : 'Ø¨Ø¯ÙˆÙ† Ø§Ø´ØªØ±Ø§Ùƒ'}
                        </span>`
                    }
                    </td>
                    <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end;">
                            <button class="action-btn info" onclick='viewUserSessions("${user.id}", "${user.name}", ${JSON.stringify(user)})' title="Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¬Ù„Ø³Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                                <i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
                            </button>
                            <button class="action-btn primary" onclick='editUser(${JSON.stringify(user)})' title="ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                                <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
                            </button>
                            ${user.subscription_status && user.role !== 'admin' ? `
                                <button class="action-btn info" onclick='editSubscription(${JSON.stringify(user)})' title="ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ">
                                    <i class="fas fa-calendar-alt"></i> Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
                                </button>
                            ` : ''}
                            <button class="action-btn warning" onclick="toggleRole('${user.id}', '${user.role}')" title="${user.role === 'admin' ? 'Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±' : 'ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Ù…Ø¯ÙŠØ±'}">
                                <i class="fas ${user.role === 'admin' ? 'fa-user-minus' : 'fa-user-shield'}"></i>
                                ${user.role === 'admin' ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©' : 'ØªØ±Ù‚ÙŠØ©'}
                            </button>
                            <button class="action-btn danger" onclick="deleteUser('${user.id}', '${user.name}')" title="Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹">
                                <i class="fas fa-trash-alt"></i> Ø­Ø°Ù
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function filterUsers(filter) {
            currentFilter = filter;

            // Update active button
            document.querySelectorAll('.user-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');

            // Clear search
            document.getElementById('user-search').value = '';

            // Display filtered users
            displayUsers();
        }

        function searchUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const rows = document.querySelectorAll('.user-row');

            rows.forEach(row => {
                const name = row.dataset.userName;
                const email = row.dataset.userEmail;
                const phone = row.dataset.userPhone;

                if (name.includes(searchTerm) || email.includes(searchTerm) || phone.includes(searchTerm)) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            });
        }



        // Load Plans
        async function loadPlans() {
            try {
                const res = await fetch('/api/admin/plans');
                const plans = await res.json();
                const grid = document.getElementById('plans-grid');

                if (plans.length === 0) {
                    grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem 2rem;">
                            <i class="fas fa-box-open" style="font-size: 4rem; color: var(--text-muted); opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                            <h3 style="color: var(--text-main); margin: 1rem 0;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø§Ù‚Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
                            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</p>
                            <button class="btn" onclick="document.getElementById('create-plan-modal').classList.add('active')" style="padding: 12px 24px;">
                                <i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©
                            </button>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = plans.map((plan, index) => {
                    const features = JSON.parse(plan.features || '{}');
                    const colors = [
                        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                        'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                        'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
                    ];
                    const bgGradient = colors[index % colors.length];

                    return `
                    <div class="plan-card" style="
                background: var(--bg-card);
                border: 2px solid transparent;
                border-radius: var(--radius-lg);
                padding: 2rem;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                " onmouseover="this.style.boxShadow = '0 12px 32px rgba(0,0,0,0.15)'; this.style.transform = 'translateY(-8px)'; this.style.borderColor = 'var(--primary)'" onmouseout="this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)'; this.style.transform = 'translateY(0)'; this.style.borderColor = 'transparent'">
                    <!-- Background gradient accent -->
                    <div style="
                position: absolute;
                top: -50%;
                right: -50%;
                width: 200%;
                height: 200%;
                background: ${bgGradient};
                opacity: 0.05;
                border-radius: 50%;
                pointer-events: none;
                "></div>

                    < !--Content -->
                        <div style="position: relative; z-index: 1;">
                            <!-- Header -->
                            <div style="display: flex; align-items: start; justify-content: space-between; margin-bottom: 1.5rem;">
                                <div>
                                    <h3 style="margin: 0; color: var(--text-main); font-size: 1.3rem; font-weight: 700;">
                                        ${plan.name}
                                    </h3>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                                        <i class="fas fa-calendar-alt" style="color: var(--text-muted); font-size: 0.9rem;"></i>
                                        <span style="color: var(--text-muted); font-size: 0.9rem;">${plan.duration_days} ÙŠÙˆÙ…</span>
                                    </div>
                                </div>
                                ${plan.is_trial ? `
                                    <span style="
                                        background: linear-gradient(135deg, var(--accent) 0%, #ff7043 100%);
                                        color: white;
                                        padding: 6px 12px;
                                        border-radius: 20px;
                                        font-size: 0.75rem;
                                        font-weight: 700;
                                        display: inline-flex;
                                        align-items: center;
                                        gap: 4px;
                                        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
                                    ">
                                        <i class="fas fa-star"></i> ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                                    </span>
                                ` : ''}
                            </div>

                            <!-- Price -->
                            <div style="
                                background: ${bgGradient};
                                padding: 1.5rem;
                                border-radius: var(--radius-md);
                                margin-bottom: 1.5rem;
                                text-align: center;
                                color: white;
                            ">
                                <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">Ø§Ù„Ø³Ø¹Ø±</div>
                                <div style="font-size: 2.5rem; font-weight: 800;">
                                    ${plan.price === 0 ? 'Ù…Ø¬Ø§Ù†ÙŠ' : plan.price + ' Ø¬.Ù…'}
                                </div>
                            </div>

                            <!-- Features -->
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="color: var(--text-main); font-size: 0.95rem; margin-bottom: 1rem; font-weight: 600;">
                                    <i class="fas fa-check-circle" style="color: var(--primary); margin-left: 6px;"></i>
                                    Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª
                                </h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${features.prayer_times ? `<span class="badge badge-success">Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</span>` : ''}
                                    ${features.adhkar ? `<span class="badge badge-success">Ø§Ù„Ø£Ø°ÙƒØ§Ø±</span>` : ''}
                                    ${features.morning_evening ? `<span class="badge badge-info">Ø§Ù„ØµØ¨Ø§Ø­/Ø§Ù„Ù…Ø³Ø§Ø¡</span>` : ''}
                                    ${features.before_after_prayer ? `<span class="badge badge-info">Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯ Ø§Ù„ØµÙ„Ø§Ø©</span>` : ''}
                                    ${features.quran ? `<span class="badge badge-warning">Ø§Ù„Ù‚Ø±Ø¢Ù†</span>` : ''}
                                    ${features.hadith ? `<span class="badge badge-warning">Ø§Ù„Ø­Ø¯ÙŠØ«</span>` : ''}
                                    ${features.fasting ? `<span class="badge badge-purple">Ø§Ù„ØµÙŠØ§Ù…</span>` : ''}
                                    ${features.rosary ? `<span class="badge badge-purple">Ø§Ù„Ø³Ø¨Ø­Ø©</span>` : ''}
                                    ${features.support ? `<span class="badge badge-primary">Ø§Ù„Ø¯Ø¹Ù…</span>` : ''}
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                                <button class="action-btn primary" onclick='editPlan(${JSON.stringify(plan)})' style="
                                    flex: 1;
                                    background: ${bgGradient};
                                    color: white;
                                    border: none;
                                    padding: 12px;
                                    font-weight: 600;
                                    transition: all 0.2s;
                                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
                                </button>
                                <button class="action-btn danger" onclick="deletePlan(${plan.id}, '${plan.name.replace(/'/g, "\\'")})" style="
                                flex: 1;
                                padding: 12px;
                                font-weight: 600;
                                transition: all 0.2s;
                                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <i class="fas fa-trash-alt"></i> Ø­Ø°Ù
                            </button>
                        </div>
                        </div>
                    </div> `;
                }).join('');
            } catch (error) {
                console.error('Error loading plans:', error);
                const grid = document.getElementById('plans-grid');
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #f44336;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; display: block; margin-bottom: 1rem;"></i>
                        Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª
                    </div>
                    `;
            }
        }

        // User Actions
        function editUser(user) {
            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-user-name').value = user.name;
            document.getElementById('edit-user-email').value = user.email;
            document.getElementById('edit-user-phone').value = user.phone;
            document.getElementById('edit-user-modal').classList.add('active');
        }

        function editSubscription(user) {
            document.getElementById('sub-edit-user-id').value = user.id;
            document.getElementById('sub-edit-user-name').value = user.name;

            // Format dates for datetime-local input (YYYY-MM-DDTHH:MM)
            const formatDate = (dateUnix) => {
                if (!dateUnix) return '';
                const d = new Date(dateUnix);
                d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                return d.toISOString().slice(0, 16);
            };

            document.getElementById('sub-edit-start').value = formatDate(user.subscription_start);
            document.getElementById('sub-edit-end').value = formatDate(user.subscription_end);
            document.getElementById('sub-edit-status').value = user.subscription_status && user.subscription_status !== 'premium_admin' ? user.subscription_status : 'active';

            document.getElementById('edit-subscription-modal').classList.add('active');
        }

        document.getElementById('edit-subscription-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('sub-edit-user-id').value;
            const startDate = document.getElementById('sub-edit-start').value;
            const endDate = document.getElementById('sub-edit-end').value;
            const status = document.getElementById('sub-edit-status').value;

            try {
                const res = await fetch(`/api/admin/users/${userId}/subscription`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ startDate, endDate, status })
                });

                if (res.ok) {
                    alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
                    closeModal('edit-subscription-modal');
                    loadUsers();
                } else {
                    const data = await res.json();
                    alert('Ø®Ø·Ø£: ' + data.error);
                }
            } catch (err) {
                console.error(err);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«');
            }
        });

        document.getElementById('edit-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-user-id').value;
            const data = {
                name: document.getElementById('edit-user-name').value,
                email: document.getElementById('edit-user-email').value,
                phone: document.getElementById('edit-user-phone').value
            };

            try {
                const res = await fetch(`/api/admin/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeModal('edit-user-modal');
                    loadUsers();
                    showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'error');
                }
            } catch (error) {
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
            }
        });

        async function toggleRole(userId, currentRole) {
            const newRole = currentRole === 'admin' ? 'user' : 'admin';
            const actionText = newRole === 'admin' ? 'ØªØ±Ù‚ÙŠØ©' : 'Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ©';

            showConfirm('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª', `Ù‡Ù„ ØªØ±ÙŠØ¯ ${actionText} Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ`, async () => {
                try {
                    await fetch(`/api/admin/users/${userId}/role`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ role: newRole })
                    });
                    loadUsers();
                    showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } catch (error) {
                    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©', 'error');
                }
            });
        }

        async function deleteUser(userId, userName) {
            // Check if this is the super admin
            const user = allUsers.find(u => u.id == userId);
            if (user && user.email === 'aman01125062943@gmail.com') {
                showToast('ğŸš« Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ! Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø­Ù…ÙŠ. ğŸ‘‘', 'error');
                return;
            }

            const title = 'âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ';
            const message = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${userName}"ØŸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ ÙˆØ§Ø´ØªØ±Ø§ÙƒØ§ØªÙ‡ ÙˆØ¬Ù„Ø³Ø§ØªÙ‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`;

            showConfirm(title, message, async () => {
                try {
                    const res = await fetch(`/api/admin/users/${userId}`, { method: 'DELETE' });
                    const data = await res.json();

                    if (data.protected) {
                        showToast('ğŸš« ' + data.error, 'error');
                        return;
                    }

                    if (res.ok) {
                        loadUsers();
                        loadStats();
                        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    } else {
                        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'error');
                    }
                } catch (error) {
                    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
                }
            });
        }

        // Subscription Actions
        async function approveSubscription(subId, userName, phone, planName, planIdOrDuration) {
            showConfirm('ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', `Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ "${userName}"ØŸ\nØ³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.`, async () => {
                try {
                    let duration = planIdOrDuration;

                    // If planIdOrDuration looks like a planId (assuming duration is < 4000 days and planId might be larger or UUID-like)
                    // In this system, plan IDs seem to be small integers too.
                    // But if it's from activation-requests, it's definitely duration_days.
                    // If it's from subscriptions tab, it's planId.

                    if (planIdOrDuration && planIdOrDuration > 1000) { // Likely an actual ID
                        const planRes = await fetch(`/api/admin/plans`);
                        const plans = await planRes.json();
                        const plan = plans.find(p => p.id == planIdOrDuration);
                        if (plan) duration = plan.duration_days;
                    }

                    const approveRes = await fetch(`/api/admin/subscriptions/${subId}/approve`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sendWhatsApp: true,
                            phone: phone,
                            userName: userName,
                            planName: planName,
                            duration: duration
                        })
                    });

                    if (!approveRes.ok) throw new Error('ÙØ´Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„');

                    showToast(`âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ "${userName}" Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                    if (typeof loadSubscriptions === 'function') loadSubscriptions();
                    if (typeof loadActivationRequests === 'function') loadActivationRequests();
                    loadStats();
                } catch (error) {
                    console.error('Error:', error);
                    showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙØ¹ÙŠÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø¨Ø· Ø¬Ù„Ø³Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨.', 'error');
                }
            });
        }

        async function rejectSubscription(subId, userName = '') {
            const nameMsg = userName ? ` Ø·Ù„Ø¨ "${userName}"` : 'Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨';
            showConfirm('Ø±ÙØ¶ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±ÙØ¶ ${nameMsg}ØŸ`, async () => {
                try {
                    const res = await fetch(`/api/admin/subscriptions/${subId}/reject`, { method: 'PUT' });
                    if (!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø±ÙØ¶');

                    showToast('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'info');
                    if (typeof loadSubscriptions === 'function') loadSubscriptions();
                    if (typeof loadActivationRequests === 'function') loadActivationRequests();
                    loadStats();
                } catch (error) {
                    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¶', 'error');
                }
            });
        }

        async function extendSubscription(subId) {
            const days = prompt('ÙƒÙ… ÙŠÙˆÙ… ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ØŸ', '30');
            if (!days) return;

            try {
                await fetch(`/api/admin/subscriptions/${subId}/extend`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days: parseInt(days) })
                });
                loadSubscriptions();
                alert('ØªÙ… ØªÙ…Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        }

        // Plan Actions
        function showCreatePlanModal() {
            document.getElementById('create-plan-modal').classList.add('active');
        }

        document.getElementById('create-plan-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                name: document.getElementById('plan-name').value,
                duration_days: parseInt(document.getElementById('plan-duration').value),
                price: parseFloat(document.getElementById('plan-price').value),
                is_trial: document.getElementById('plan-trial').checked,
                max_sessions: parseInt(document.getElementById('plan-max-sessions').value) || 1,
                features: {
                    prayer_times: document.getElementById('feature-prayer').checked,
                    adhkar: document.getElementById('feature-adhkar').checked
                }
            };

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.innerHTML : null;
            try {
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';
                }

                const res = await fetch('/api/admin/plans', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡');

                closeModal('create-plan-modal');
                loadPlans();
                alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­');
                e.target.reset();
            } catch (error) {
                console.error('Create plan error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø§Ù‚Ø©');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            }
        });

        async function deletePlan(planId, planName) {
            showConfirm('Ø­Ø°Ù Ø§Ù„Ø¨Ø§Ù‚Ø©', `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¨Ø§Ù‚Ø© "${planName}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ`, async () => {
                try {
                    await fetch(`/api/admin/plans/${planId}`, { method: 'DELETE' });
                    loadPlans();
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } catch (error) {
                    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¨Ø§Ù‚Ø©', 'error');
                }
            });
        }

        // Edit Plan
        function editPlan(plan) {
            try {
                document.getElementById('edit-plan-id').value = plan.id;
                document.getElementById('edit-plan-name').value = plan.name || '';
                document.getElementById('edit-plan-duration').value = plan.duration_days || '';
                document.getElementById('edit-plan-price').value = plan.price || '';
                document.getElementById('edit-plan-trial').checked = !!plan.is_trial;
                document.getElementById('edit-plan-max-sessions').value = plan.max_sessions || 1;

                const features = JSON.parse(plan.features || '{}');
                document.getElementById('edit-feature-prayer').checked = !!features.prayer_times;
                document.getElementById('edit-feature-adhkar').checked = !!features.adhkar;
                document.getElementById('edit-feature-morning-evening').checked = !!features.morning_evening;
                document.getElementById('edit-feature-before-after').checked = !!features.before_after_prayer;
                document.getElementById('edit-feature-quran').checked = !!features.quran;
                document.getElementById('edit-feature-hadith').checked = !!features.hadith;
                document.getElementById('edit-feature-fasting').checked = !!features.fasting;
                document.getElementById('edit-feature-rosary').checked = !!features.rosary;
                document.getElementById('edit-feature-support').checked = !!features.support;

                document.getElementById('edit-plan-modal').classList.add('active');
            } catch (e) {
                console.error('editPlan error', e);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.');
            }
        }

        document.getElementById('edit-plan-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('edit-plan-id').value;
            const data = {
                name: document.getElementById('edit-plan-name').value,
                duration_days: parseInt(document.getElementById('edit-plan-duration').value),
                price: parseFloat(document.getElementById('edit-plan-price').value),
                is_trial: document.getElementById('edit-plan-trial').checked,
                max_sessions: parseInt(document.getElementById('edit-plan-max-sessions').value) || 1,
                features: {
                    prayer_times: document.getElementById('edit-feature-prayer').checked,
                    adhkar: document.getElementById('edit-feature-adhkar').checked,
                    morning_evening: document.getElementById('edit-feature-morning-evening').checked,
                    before_after_prayer: document.getElementById('edit-feature-before-after').checked,
                    quran: document.getElementById('edit-feature-quran').checked,
                    hadith: document.getElementById('edit-feature-hadith').checked,
                    fasting: document.getElementById('edit-feature-fasting').checked,
                    rosary: document.getElementById('edit-feature-rosary').checked,
                    support: document.getElementById('edit-feature-support').checked
                }
            };

            // Basic client-side validation
            if (!data.name || isNaN(data.duration_days) || data.duration_days <= 0 || isNaN(data.price) || data.price < 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Ø§Ù„Ø§Ø³Ù…ØŒ Ù…Ø¯Ø© Ù…ÙˆØ¬Ø¨Ø©ØŒ ÙˆØ³Ø¹Ø± ØµØ§Ù„Ø­).');
                return;
            }

            const submitBtn = document.querySelector('#edit-plan-form button[type="submit"]');
            const originalText = submitBtn ? submitBtn.innerHTML : null;
            try {
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
                }

                const res = await fetch(`/api/admin/plans/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«');

                closeModal('edit-plan-modal');
                loadPlans();
                alert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Error updating plan:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø©');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            }
        });

        // Modal Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // WhatsApp Session Management
        let currentSessionId = null;

        async function viewUserSessions(userId, userName, userDetails = null) {
            document.getElementById('user-sessions-title').textContent = `Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ³Ø¬Ù„: ${userName}`;
            const tbody = document.getElementById('user-sessions-tbody');
            const profileInfo = document.getElementById('user-profile-info');

            // Show profile info if provided (especially for admin)
            if (userDetails) {
                profileInfo.style.display = 'block';
                document.getElementById('prof-email').textContent = userDetails.email || '-';
                document.getElementById('prof-phone').textContent = userDetails.phone || '-';
                document.getElementById('prof-date').textContent = userDetails.created_at ? new Date(userDetails.created_at).toLocaleDateString('ar-EG') : '-';
                document.getElementById('prof-role').textContent = userDetails.role === 'admin' ? 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…' : 'Ù…Ø³ØªØ®Ø¯Ù…';
            } else {
                profileInfo.style.display = 'none';
            }

            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            document.getElementById('user-sessions-modal').classList.add('active');

            try {
                const res = await fetch(`/api/whatsapp/list?userId=${userId}`);
                const sessions = await res.json();

                if (sessions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</td></tr>';
                    return;
                }

                tbody.innerHTML = sessions.map(session => `
                    <tr>
                        <td data-label="Ø§Ù„Ø¬Ù„Ø³Ø©"><strong>${session.name}</strong><br><small>${session.session_id}</small></td>
                        <td data-label="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" style="direction: ltr; text-align: right;">${session.phoneNumber ? '+' + session.phoneNumber : '-'}</td>
                        <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">
                            <span class="status-badge ${session.connected ? 'status-active' : 'status-expired'}">
                                ${session.connected ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„'}
                            </span>
                        </td>
                        <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡">${new Date(session.created_at).toLocaleDateString('ar-EG')}</td>
                        <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                             <div style="display: flex; gap: 5px;">
                                ${session.connected ?
                        `<button class="action-btn warning" onclick="disconnectSession('${session.session_id}'); setTimeout(() => viewUserSessions('${userId}', '${userName}', ${JSON.stringify(userDetails)}), 1000);" title="Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„"><i class="fas fa-unlink"></i></button>` :
                        `<button class="action-btn primary" onclick="openSmartWatsConnectionModal('${session.session_id}')" title="Ø±Ø¨Ø· Ø§Ù„Ø¬Ù„Ø³Ø© (Ø·Ø±ÙŠÙ‚Ø© SmartWats)"><i class="fas fa-link"></i></button>
                            <button class="action-btn" style="background: #25D366; color: white;" onclick="requestPairingCodeForSession('${session.session_id}', '${session.user_phone || session.phoneNumber || ''}'); setTimeout(() => viewUserSessions('${userId}', '${userName}', ${JSON.stringify(userDetails)}), 1000);" title="Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨"><i class="fab fa-whatsapp"></i></button>`
                    }
                                <button class="action-btn danger" onclick="deleteSession('${session.session_id}'); setTimeout(() => viewUserSessions('${userId}', '${userName}', ${JSON.stringify(userDetails)}), 1000);" title="Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading user sessions:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--danger);">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
            }
        }

        async function loadSessions() {
            // Alias for backward compatibility
            window.checkWhatsAppStatus = loadSessions;
            try {
                const res = await fetch('/api/whatsapp/list'); // This now returns only admin sessions by default
                const sessions = await res.json();

                // Update stats
                document.getElementById('stats-total-sessions').textContent = sessions.length;
                document.getElementById('stats-connected-sessions').textContent = sessions.filter(s => s.connected).length;

                // Restrict Add Session for admin if needed (usually 999)
                const adminMaxSessions = "<%= maxSessions %>";
                const addSessionBtnGroup = document.querySelector('[onclick="openAddSessionModal()"]');
                if (addSessionBtnGroup) {
                    if (sessions.length >= adminMaxSessions) {
                        addSessionBtnGroup.disabled = true;
                        addSessionBtnGroup.innerHTML = '<i class="fas fa-lock"></i> ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ (' + adminMaxSessions + ')';
                        addSessionBtnGroup.style.opacity = '0.7';
                    } else {
                        addSessionBtnGroup.disabled = false;
                        addSessionBtnGroup.innerHTML = '<i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©';
                        addSessionBtnGroup.style.opacity = '1';
                    }
                }

                const tbody = document.getElementById('sessions-tbody');

                if (sessions.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                                <i class="fab fa-whatsapp" style="font-size: 3rem; display: block; margin-bottom: 1rem; opacity: 0.3;"></i>
                                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª. Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ© Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ù„Ø¨Ø¯Ø¡.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = sessions.map(session => {
                    const phone = session.phoneNumber ? '+' + session.phoneNumber : '-';
                    const formattedPhone = phone !== '-' ? phone.replace(/(\+\d{1,3})(\d+)/, '$1 $2') : '-';

                    return `
                        <tr>
                            <td data-label="Ø§Ù„Ø¬Ù„Ø³Ø©">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 35px; height: 35px; background: var(--bg-secondary); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--primary);">
                                        <i class="fab fa-whatsapp"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">${session.name}</div>
                                        <small style="font-size: 0.75rem; color: var(--text-muted); font-family: monospace;">${session.session_id.substring(0, 15)}...</small>
                                    </div>
                                </div>
                            </td>
                            <td data-label="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 700;">
                                        ${session.user_name ? session.user_name.charAt(0).toUpperCase() : '?'}
                                    </div>
                                    <div>
                                        <div style="font-weight: 500;">${session.user_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</div>
                                        <small style="color: var(--text-muted); font-family: monospace;">${session.user_phone || ''}</small>
                                    </div>
                                </div>
                            </td>
                            <td data-label="Ø§Ù„Ø¬Ù‡Ø§Ø²"><span style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem;">${session.device_type}</span></td>
                            <td data-label="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" style="direction: ltr; text-align: right; font-weight: 600;">${formattedPhone}</td>
                            <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">
                                <span class="status-badge ${session.connected ? 'status-active' : 'status-expired'}">
                                    ${session.connected ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„'}
                                </span>
                            </td>
                            <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡"><span style="color: var(--text-muted); font-size: 0.85rem;">${new Date(session.created_at).toLocaleDateString('ar-EG')}</span></td>
                            <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                                <div style="display: flex; gap: 5px;">
                                    <button class="action-btn" style="background: var(--bg-secondary);" onclick="sendTestMessageModal('${session.session_id}')" title="Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©" ${!session.connected ? 'disabled' : ''}>
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                    ${session.connected ?
                        `<button class="action-btn warning" onclick="disconnectSession('${session.session_id}')" title="Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„"><i class="fas fa-unlink"></i></button>` :
                        `<button class="action-btn primary" onclick="reconnectSingleSession('${session.session_id}')" title="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„"><i class="fas fa-plug"></i></button>`
                    }
                                    <button class="action-btn danger" onclick="deleteSession('${session.session_id}')" title="Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        // Function to reconnect a single session
        async function reconnectSingleSession(sessionId) {
            try {
                // Get session details first
                const sessionsRes = await fetch('/api/whatsapp/list');
                const sessions = await sessionsRes.json();
                const session = sessions.find(s => s.session_id === sessionId);

                if (!session) {
                    alert('Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    return;
                }

                // Trigger reconnection
                const res = await fetch('/api/whatsapp/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        userId: session.user_id,
                        deviceType: session.device_type,
                        sessionName: session.name,
                        webhookUrl: session.webhook_url
                    })
                });

                const data = await res.json();
                if (data.success) {
                    showToast('Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù„Ø³Ø©...', 'info');
                } else {
                    showToast('ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø¨Ø·: ' + (data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
                }
            } catch (error) {
                console.error('Reconnect error:', error);
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø¨Ø·: ' + error.message, 'error');
            }
        }

        // Function to reconnect all disconnected sessions
        async function reconnectAllSessions() {
            try {
                // Get all sessions
                const res = await fetch('/api/whatsapp/list');
                const sessions = await res.json();
                
                // Filter disconnected sessions
                const disconnectedSessions = sessions.filter(session => !session.connected);
                
                if (disconnectedSessions.length === 0) {
                    showToast('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ù…ØªØµÙ„Ø© Ø¨Ø§Ù„ÙØ¹Ù„', 'info');
                    return;
                }
                
                const confirmMsg = `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ ${disconnectedSessions.length} Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ØªØµÙ„Ø©ØŸ`;
                if (!confirm(confirmMsg)) return;
                
                showToast(`Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ ${disconnectedSessions.length} Ø¬Ù„Ø³Ø©...`, 'info');
                
                let reconnectedCount = 0;
                for (const session of disconnectedSessions) {
                    try {
                        // Trigger reconnection for each disconnected session
                        const reconnectRes = await fetch('/api/whatsapp/connect', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                sessionId: session.session_id,
                                userId: session.user_id,
                                deviceType: session.device_type,
                                sessionName: session.name,
                                webhookUrl: session.webhook_url
                            })
                        });
                        
                        const reconnectData = await reconnectRes.json();
                        
                        if (reconnectData.success) {
                            reconnectedCount++;
                            
                            // Small delay between reconnections to prevent overload
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    } catch (error) {
                        console.error(`Error reconnecting session ${session.session_id}:`, error);
                    }
                }
                
                showToast(`ØªÙ…Øª Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ ${reconnectedCount} Ù…Ù† ${disconnectedSessions.length} Ø¬Ù„Ø³Ø©`, 'success');
                
                // Refresh sessions list after a short delay
                setTimeout(() => {
                    loadSessions();
                }, 2000);
                
            } catch (error) {
                console.error('Error in reconnectAllSessions:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù„Ø³Ø§Øª', 'error');
            }
        }

        let allCountries = [];

        function openAddSessionModal() {
            // Initialize countries
            allCountries = [
                { code: '+20', name: 'Ù…ØµØ±', flag: 'ğŸ‡ªğŸ‡¬' },
                { code: '+966', name: 'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', flag: 'ğŸ‡¸ğŸ‡¦' },
                { code: '+971', name: 'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª', flag: 'ğŸ‡¦ğŸ‡ª' },
                { code: '+965', name: 'Ø§Ù„ÙƒÙˆÙŠØª', flag: 'ğŸ‡°ğŸ‡¼' },
                { code: '+974', name: 'Ù‚Ø·Ø±', flag: 'ğŸ‡¶ğŸ‡¦' },
                { code: '+963', name: 'Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†', flag: 'ğŸ‡§ğŸ‡­' },
                { code: '+968', name: 'Ø¹Ù…Ø§Ù†', flag: 'ğŸ‡´ğŸ‡²' },
                { code: '+962', name: 'Ø§Ù„Ø£Ø±Ø¯Ù†', flag: 'ğŸ‡¯ğŸ‡´' },
                { code: '+961', name: 'Ù„Ø¨Ù†Ø§Ù†', flag: 'ğŸ‡±ğŸ‡§' },
                { code: '+963', name: 'Ø³ÙˆØ±ÙŠØ§', flag: 'ğŸ‡¸ğŸ‡¾' },
                { code: '+964', name: 'Ø§Ù„Ø¹Ø±Ø§Ù‚', flag: 'ğŸ‡®ğŸ‡¶' },
                { code: '+967', name: 'Ø§Ù„ÙŠÙ…Ù†', flag: 'ğŸ‡¾ğŸ‡ª' },
                { code: '+218', name: 'Ù„ÙŠØ¨ÙŠØ§', flag: 'ğŸ‡±ğŸ‡¾' },
                { code: '+213', name: 'Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±', flag: 'ğŸ‡©ğŸ‡¿' },
                { code: '+212', name: 'Ø§Ù„Ù…ØºØ±Ø¨', flag: 'ğŸ‡²ğŸ‡¦' },
                { code: '+216', name: 'ØªÙˆÙ†Ø³', flag: 'ğŸ‡¹ğŸ‡³' },
                { code: '+249', name: 'Ø§Ù„Ø³ÙˆØ¯Ø§Ù†', flag: 'ğŸ‡¸ğŸ‡©' },
                { code: '+90', name: 'ØªØ±ÙƒÙŠØ§', flag: 'ğŸ‡¹ğŸ‡·' },
                { code: '+1', name: 'Ø£Ù…Ø±ÙŠÙƒØ§', flag: 'ğŸ‡ºğŸ‡¸' },
                { code: '+44', name: 'Ø¨Ø±ÙŠØ·Ø§Ù†ÙŠØ§', flag: 'ğŸ‡¬ğŸ‡§' },
                { code: '+49', name: 'Ø£Ù„Ù…Ø§Ù†ÙŠØ§', flag: 'ğŸ‡©ğŸ‡ª' },
                { code: '+33', name: 'ÙØ±Ù†Ø³Ø§', flag: 'ğŸ‡«ğŸ‡·' },
                { code: '+34', name: 'Ø¥Ø³Ø¨Ø§Ù†ÙŠØ§', flag: 'ğŸ‡ªğŸ‡¸' },
                { code: '+39', name: 'Ø¥ÙŠØ·Ø§Ù„ÙŠØ§', flag: 'ğŸ‡®ğŸ‡¹' }
            ];

            // Reset form
            document.getElementById('session-name').value = '';
            document.getElementById('session-phone').value = '';
            document.getElementById('session-webhook').value = '';

            // Set Egypt as default
            document.getElementById('country-search').value = 'Ù…ØµØ±';
            document.getElementById('country-code').value = '+20';
            document.getElementById('selected-flag').textContent = 'ğŸ‡ªğŸ‡¬';
            document.getElementById('display-prefix').textContent = '+20';

            document.getElementById('add-session-modal').classList.add('active');
        }

        function searchCountries() {
            const searchTerm = document.getElementById('country-search').value.toLowerCase();
            const dropdown = document.getElementById('country-dropdown');

            if (searchTerm.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            const filtered = allCountries.filter(country =>
                country.name.toLowerCase().includes(searchTerm) ||
                country.code.includes(searchTerm) ||
                (typeof country.name_en !== 'undefined' && country.name_en.toLowerCase().includes(searchTerm))
            );

            dropdown.innerHTML = filtered.map(country => `
                <div onclick="selectCountry('${country.code}', '${country.name}', '${country.flag}')" 
                     style="padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border);" 
                     onmouseover="this.style.background='var(--bg-secondary)'" 
                     onmouseout="this.style.background='transparent'">
                    <span style="font-size: 1.3rem;">${country.flag}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 0.95rem;">${country.name}</div>
                    </div>
                    <span style="color: var(--text-muted); font-weight: 700; font-family: monospace;">${country.code}</span>
                </div>
            `).join('');

            dropdown.style.display = 'block';
        }

        function showCountryList() {
            const dropdown = document.getElementById('country-dropdown');
            dropdown.innerHTML = allCountries.map(country => `
                <div onclick="selectCountry('${country.code}', '${country.name}', '${country.flag}')" 
                     style="padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border);" 
                     onmouseover="this.style.background='var(--bg-secondary)'" 
                     onmouseout="this.style.background='transparent'">
                    <span style="font-size: 1.3rem;">${country.flag}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 0.95rem;">${country.name}</div>
                    </div>
                    <span style="color: var(--text-muted); font-weight: 700; font-family: monospace;">${country.code}</span>
                </div>
            `).join('');
            dropdown.style.display = 'block';
        }

        function selectCountry(code, name, flag) {
            document.getElementById('country-search').value = name;
            document.getElementById('country-code').value = code;
            document.getElementById('selected-flag').textContent = flag;
            document.getElementById('display-prefix').textContent = code;
            document.getElementById('country-dropdown').style.display = 'none';
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', function (e) {
            if (!e.target.closest('#country-search') && !e.target.closest('#country-dropdown')) {
                document.getElementById('country-dropdown').style.display = 'none';
            }
        });

        async function disconnectSession(sessionId) {
            showConfirm('Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ØŸ Ø³ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….', async () => {
                try {
                    await fetch(`/api/whatsapp/${sessionId}/disconnect`, { method: 'POST' });
                    loadSessions();
                    showToast('ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } catch (e) {
                    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
                }
            });
        }

        async function deleteSession(sessionId) {
            showConfirm('Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©', 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§.', async () => {
                try {
                    await fetch(`/api/whatsapp/${sessionId}`, { method: 'DELETE' });
                    loadSessions();
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } catch (e) {
                    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©', 'error');
                }
            });
        }

        function reconnectSession(sessionId) {
            // For reconnect, we need to trigger a new connection
            connectExistingSession(sessionId);
        }

        async function connectExistingSession(sessionId) {
            try {
                // Get session details first
                const sessionsRes = await fetch('/api/whatsapp/list');
                const sessions = await sessionsRes.json();
                const session = sessions.find(s => s.session_id === sessionId);

                if (!session) {
                    alert('Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    return;
                }

                // Trigger reconnection
                const res = await fetch('/api/whatsapp/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        userId: session.user_id,
                        deviceType: session.device_type,
                        sessionName: session.name,
                        webhookUrl: session.webhook_url
                    })
                });

                const data = await res.json();
                if (data.success) {
                    currentSessionId = sessionId;
                    showQRPopup(session.device_type, session.name);
                    startQRMonitoring(sessionId);
                } else {
                    alert('ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø¨Ø·: ' + (data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            } catch (error) {
                console.error('Reconnect error:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø¨Ø·: ' + error.message);
            }
        }

        async function showQRForSession(sessionId) {
            currentSessionId = sessionId;
            showQRPopup('WhatsApp', 'Connecting...');

            // Check if we have a QR code
            try {
                const res = await fetch(`/api/whatsapp/status/${sessionId}`);
                const data = await res.json();
                if (data.hasQR) {
                    // Fetch QR specifically
                    try {
                        const qrRes = await fetch(`/api/whatsapp/qr/${sessionId}`);
                        const qrData = await qrRes.json();
                        if (qrData.success && qrData.qrCode) {
                            document.getElementById('qr-popup-image').src = qrData.qrCode;
                        }
                    } catch (qrErr) {
                        console.error('Error fetching QR:', qrErr);
                    }
                    startQRMonitoring(sessionId);
                } else {
                    refreshQRCode(sessionId);
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function refreshQRCode(sessionId) {
            try {
                showQRConnecting();
                alert('Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø¨Ø·ØŒ ÙŠØ±Ø¬Ù‰ Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ù…Ù† Ø¬Ø¯ÙŠØ¯ (Ù„Ù„Ø¶Ù…Ø§Ù†).');
                closeQRPopup();
            } catch (error) {
                showQRError('ÙØ´Ù„');
            }
        }

        // Modal Functions (Keep existing)
        // ...

        // WhatsApp Session Management
        let qrMonitoringInterval = null;

        function showQRPopup(device, sessionName) {
            // Update session info
            document.getElementById('display-device').textContent = device;
            document.getElementById('display-session-name').textContent = sessionName;

            // Reset status
            document.getElementById('status-waiting').style.display = 'block';
            document.getElementById('status-connecting').style.display = 'none';
            document.getElementById('status-connected').style.display = 'none';
            document.getElementById('status-error').style.display = 'none';
            document.getElementById('error-message').textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';

            // Show popup
            document.getElementById('qr-popup').classList.add('active');
        }

        function closeQRPopup() {
            document.getElementById('qr-popup').classList.remove('active');
            stopQRMonitoring();
            loadSessions(); // Reload list
        }

        function startQRMonitoring(sessionId) {
            if (qrMonitoringInterval) clearInterval(qrMonitoringInterval);

            qrMonitoringInterval = setInterval(async () => {
                try {
                    const res = await fetch(`/api/whatsapp/status/${sessionId}`);
                    const data = await res.json();
                    console.log('QR Monitor Check:', { sessionId, connected: data.connected, hasQR: data.hasQR, qrLength: data.qrCode ? data.qrCode.length : 0 });

                    if (data.connected) {
                        showQRConnected();
                        stopQRMonitoring();
                        setTimeout(closeQRPopup, 2000);
                        return;
                    }

                    if (data.hasQR) {
                        // We have a QR available signal
                        let finalQR = data.qrCode;

                        // If not included in status, fetch it explicitly
                        if (!finalQR) {
                            try {
                                console.log('Fetching QR separately for:', sessionId);
                                const qrRes = await fetch(`/api/whatsapp/qr/${sessionId}`);
                                const qrData = await qrRes.json();
                                console.log('QR Response:', { success: qrData.success, hasQrCode: !!qrData.qrCode, qrLength: qrData.qrCode ? qrData.qrCode.length : 0 });
                                if (qrData.success && qrData.qrCode) {
                                    finalQR = qrData.qrCode;
                                } else {
                                    console.warn('QR fetch returned no code:', qrData);
                                }
                            } catch (err) {
                                console.error('Error fetching separate QR:', err);
                            }
                        }

                        // Update UI completely
                        if (finalQR) {
                            const img = document.getElementById('qr-popup-image');
                            if (img.src !== finalQR) {
                                img.src = finalQR;
                            }
                            // Force display update
                            document.getElementById('status-waiting').style.display = 'none';
                            document.getElementById('status-connecting').style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.error('QR Monitoring Error:', error);
                }
            }, 2000);
        }

        function stopQRMonitoring() {
            if (qrMonitoringInterval) {
                clearInterval(qrMonitoringInterval);
                qrMonitoringInterval = null;
            }
        }

        function togglePhoneLinkAdmin() {
            const form = document.getElementById('phone-link-form-admin');
            const btn = document.getElementById('toggle-phone-link-btn-admin');
            const display = document.getElementById('pairing-code-display-admin');

            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
                display.style.display = 'none';
                btn.textContent = 'âŒ Ø¥ØºÙ„Ø§Ù‚';
            } else {
                form.style.display = 'none';
                display.style.display = 'none';
                btn.textContent = 'ğŸ“± Ø±Ø¨Ø· Ø¨ÙˆØ§Ø³Ø·Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ';
            }
        }

        async function requestPairingCodeAdmin() {
            const phoneId = 'pairing-phone-admin';
            const btnId = 'get-code-btn-admin';
            const formId = 'phone-link-form-admin';
            const displayId = 'pairing-code-display-admin';
            const codeValueId = 'pairing-code-value-admin';

            const phoneInput = document.getElementById(phoneId);
            if (!phoneInput) {
                showToast('Ø®Ø·Ø£: Ø¹Ù†ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }

            let phone = phoneInput.value.trim();
            if (!phone) {
                showToast('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }

            // Remove spaces, hyphens, and parentheses
            phone = phone.replace(/[\s\-\(\)]/g, '');

            // Remove + if exists
            if (phone.startsWith('+')) {
                phone = phone.substring(1);
            }

            // Validate minimum length
            if (phone.length < 10) {
                showToast('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ (10 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)', 'error');
                return;
            }

            console.log('[Frontend] Original phone:', phoneInput.value, 'Cleaned:', phone);

            if (!currentSessionId) {
                showToast('Ø®Ø·Ø£: Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
                return;
            }

            const btn = document.getElementById(btnId);
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

            try {
                const res = await fetch('/api/whatsapp/send-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: currentSessionId,
                        phoneNumber: phone
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¨Ø·');
                }

                if (!data.code) {
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¨Ø· Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…');
                }

                console.log('[Frontend] Successfully received pairing code:', data.code);
                document.getElementById(formId).style.display = 'none';
                document.getElementById(displayId).style.display = 'block';
                document.getElementById(codeValueId).textContent = data.code;

                showToast('âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¨Ø·! Ø£Ø¯Ø®Ù„Ù‡ ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ', 'success');

            } catch (error) {
                console.error('[Frontend] Error in requestPairingCodeAdmin:', error);
                showToast('âŒ ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Request pairing code for a session directly from sessions list
        async function requestPairingCodeForSession(sessionId, phoneNumber) {
            try {
                // Get session details
                const sessionsRes = await fetch('/api/whatsapp/list');
                const sessions = await sessionsRes.json();
                const session = sessions.find(s => s.session_id === sessionId);

                if (!session) {
                    showToast('Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                    return;
                }

                // Set as current session
                currentSessionId = sessionId;

                // If session is not connected, we need to initialize it first
                if (!session.connected) {
                    // Initialize session first
                    const initRes = await fetch('/api/whatsapp/connect', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionId: sessionId,
                            userId: session.user_id,
                            deviceType: session.device_type || 'Android',
                            sessionName: session.name,
                            webhookUrl: session.webhook_url || '',
                            phoneNumber: phoneNumber
                        })
                    });

                    const initData = await initRes.json();
                    if (!initData.success) {
                        showToast('ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ù„Ø³Ø©: ' + (initData.error || 'Ø®Ø·Ø£'), 'error');
                        return;
                    }

                    // Wait a bit for session to initialize (2 seconds instead of 5 for speed)
                    showToast('Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'info');
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    // Verify session is ready by checking status
                    let retries = 0;
                    let sessionReady = false;

                    while (retries < 3 && !sessionReady) {
                        try {
                            const statusRes = await fetch(`/api/whatsapp/status/${sessionId}`);
                            const statusData = await statusRes.json();

                            // Session is ready if it has QR or is not in error state
                            if (statusData.hasQR || statusData.connected) {
                                sessionReady = true;
                                console.log('[Frontend] Session is ready for pairing code');
                            } else {
                                console.log(`[Frontend] Retry ${retries + 1}/3 - waiting for session...`);
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                retries++;
                            }
                        } catch (err) {
                            console.error('[Frontend] Error checking status:', err);
                            retries++;
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                    }

                    if (!sessionReady) {
                        showToast('Ø§Ù„Ø¬Ù„Ø³Ø© ØªØ­ØªØ§Ø¬ ÙˆÙ‚ØªØ§Ù‹ Ø£Ø·ÙˆÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„.', 'warning');
                        return;
                    }
                }

                // Get phone number
                let phone = phoneNumber || session.phoneNumber || session.phone_number || '';

                if (!phone || phone.trim() === '') {
                    phone = prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±Ø¨Ø·Ù‡ (Ø¨Ø¯ÙˆÙ† +):');
                    if (!phone || phone.trim() === '') {
                        showToast('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'warning');
                        return;
                    }
                }

                // Clean phone number
                phone = phone.replace(/[\s\-\(\)]/g, '');
                if (phone.startsWith('+')) {
                    phone = phone.substring(1);
                }

                // Validate minimum length
                if (phone.length < 10) {
                    showToast('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ (10 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)', 'error');
                    return;
                }

                // Show loading
                showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø¨Ø·...', 'info');

                // Request pairing code
                const res = await fetch('/api/whatsapp/send-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        phoneNumber: phone
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¨Ø·');
                }

                if (!data.code) {
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¨Ø· Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…');
                }

                // Show success message with code
                const codeDisplay = "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!\n\n1. Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ > Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª > Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©.\n2. Ø§Ø¶ØºØ· 'Ø±Ø¨Ø· Ø¬Ù‡Ø§Ø²' Ø«Ù… 'Ø§Ù„Ø±Ø¨Ø· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ'.\n3. Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¶Ø­ Ø£Ø¯Ù†Ø§Ù‡.\n\nØ§Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:";

                prompt(codeDisplay, data.code);
                showToast('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨! ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ§ØªØ³Ø§Ø¨', 'success');

                // Start monitoring in background to refresh list when connected
                startQRMonitoring(sessionId);

            } catch (error) {
                console.error('[Frontend] Error in requestPairingCodeForSession:', error);
                showToast('âŒ ' + error.message, 'error');
            }
        }

        // SmartWats-style connection modal functions
        let currentSmartWatsSessionId = null;

        let smartWatsMonitoringInterval = null;

        function openSmartWatsConnectionModal(sessionId) {
            currentSmartWatsSessionId = sessionId;

            // Set Instance ID
            document.getElementById('smartwats-instance-id').textContent = sessionId.substring(0, 13).toUpperCase();

            // Reset UI
            document.getElementById('smartwats-qr-image').style.display = 'none';
            document.getElementById('smartwats-qr-loading').style.display = 'block';
            document.getElementById('smartwats-pairing-code-display').style.display = 'none';
            document.getElementById('smartwats-pairing-form').style.display = 'block';
            document.getElementById('smartwats-phone-input').value = '';

            // Show modal
            document.getElementById('smartwats-connection-modal').classList.add('active');

            // Load QR code
            loadSmartWatsQR(sessionId);

            // Start monitoring connection status
            startSmartWatsMonitoring(sessionId);
        }

        function startSmartWatsMonitoring(sessionId) {
            if (smartWatsMonitoringInterval) {
                clearInterval(smartWatsMonitoringInterval);
            }

            smartWatsMonitoringInterval = setInterval(async () => {
                try {
                    const res = await fetch(`/api/whatsapp/status/${sessionId}`);
                    const data = await res.json();

                    if (data.connected) {
                        // Connection successful!
                        clearInterval(smartWatsMonitoringInterval);
                        smartWatsMonitoringInterval = null;

                        showToast('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                        setTimeout(() => {
                            closeSmartWatsModal();
                            loadSessions(); // Refresh sessions list
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Error monitoring connection:', error);
                }
            }, 2000);
        }

        function stopSmartWatsMonitoring() {
            if (smartWatsMonitoringInterval) {
                clearInterval(smartWatsMonitoringInterval);
                smartWatsMonitoringInterval = null;
            }
        }

        function closeSmartWatsModal() {
            stopSmartWatsMonitoring();
            if (smartWatsQRRefreshInterval) {
                clearInterval(smartWatsQRRefreshInterval);
                smartWatsQRRefreshInterval = null;
            }
            document.getElementById('smartwats-connection-modal').classList.remove('active');
            currentSmartWatsSessionId = null;
        }

        let smartWatsQRRefreshInterval = null;

        async function loadSmartWatsQR(sessionId) {
            try {
                // Check if QR is available
                const statusRes = await fetch(`/api/whatsapp/status/${sessionId}`);
                const statusData = await statusRes.json();

                if (statusData.hasQR && statusData.qrCode) {
                    document.getElementById('smartwats-qr-image').src = statusData.qrCode;
                    document.getElementById('smartwats-qr-image').style.display = 'block';
                    document.getElementById('smartwats-qr-loading').style.display = 'none';

                    // Start auto-refresh every 40 seconds (as per SmartWats)
                    if (smartWatsQRRefreshInterval) {
                        clearInterval(smartWatsQRRefreshInterval);
                    }
                    smartWatsQRRefreshInterval = setInterval(() => {
                        refreshSmartWatsQR(sessionId);
                    }, 40000); // 40 seconds
                } else {
                    // Try to fetch QR separately
                    const qrRes = await fetch(`/api/whatsapp/qr/${sessionId}`);
                    const qrData = await qrRes.json();

                    if (qrData.success && qrData.qrCode) {
                        document.getElementById('smartwats-qr-image').src = qrData.qrCode;
                        document.getElementById('smartwats-qr-image').style.display = 'block';
                        document.getElementById('smartwats-qr-loading').style.display = 'none';

                        // Start auto-refresh
                        if (smartWatsQRRefreshInterval) {
                            clearInterval(smartWatsQRRefreshInterval);
                        }
                        smartWatsQRRefreshInterval = setInterval(() => {
                            refreshSmartWatsQR(sessionId);
                        }, 40000);
                    } else {
                        document.getElementById('smartwats-qr-loading').innerHTML = '<p style="color: var(--text-muted);">Ù„Ù… ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¨Ø¹Ø¯. Ø¬Ø±Ø¨ Ø·Ø±ÙŠÙ‚Ø© ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¨Ø·.</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading QR:', error);
                document.getElementById('smartwats-qr-loading').innerHTML = '<p style="color: #f44336;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©</p>';
            }
        }

        async function refreshSmartWatsQR(sessionId) {
            try {
                if (!sessionId) {
                    console.error('No sessionId provided for QR refresh');
                    return;
                }

                console.log('[SmartWats] Refreshing QR for session:', sessionId);
                document.getElementById('smartwats-qr-loading').style.display = 'block';
                document.getElementById('smartwats-qr-image').style.display = 'none';

                // First, try to get session details to reconnect if needed
                const sessionsRes = await fetch('/api/whatsapp/list');
                const sessions = await sessionsRes.json();
                const session = sessions.find(s => s.session_id === sessionId);

                if (!session) {
                    console.error('Session not found:', sessionId);
                    document.getElementById('smartwats-qr-loading').innerHTML = '<p style="color: #f44336;">Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</p>';
                    return;
                }

                // If session is connected, we can't refresh QR
                if (session.connected) {
                    document.getElementById('smartwats-qr-loading').innerHTML = '<p style="color: var(--text-muted);">Ø§Ù„Ø¬Ù„Ø³Ø© Ù…ØªØµÙ„Ø© Ø¨Ø§Ù„ÙØ¹Ù„</p>';
                    return;
                }

                // Try to reconnect to get new QR
                try {
                    const res = await fetch('/api/whatsapp/connect', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionId: sessionId,
                            userId: session.user_id,
                            deviceType: session.device_type || 'Android',
                            sessionName: session.name,
                            webhookUrl: session.webhook_url || ''
                        })
                    });

                    const data = await res.json();
                    if (data.success) {
                        console.log('[SmartWats] Reconnect successful, waiting for new QR...');
                        // Wait a bit for QR to be generated, then reload
                        setTimeout(() => {
                            loadSmartWatsQR(sessionId);
                        }, 3000);
                    } else {
                        console.error('[SmartWats] Failed to reconnect:', data.error);
                        // Even if reconnect fails, try to load existing QR
                        setTimeout(() => {
                            loadSmartWatsQR(sessionId);
                        }, 1000);
                    }
                } catch (reconnectError) {
                    console.error('[SmartWats] Reconnect error, trying to load existing QR:', reconnectError);
                    // If reconnect fails, just try to reload existing QR
                    setTimeout(() => {
                        loadSmartWatsQR(sessionId);
                    }, 1000);
                }
            } catch (error) {
                console.error('[SmartWats] Error refreshing QR:', error);
                document.getElementById('smartwats-qr-loading').innerHTML = '<p style="color: #f44336;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©</p>';
            }
        }

        async function requestSmartWatsPairingCode() {
            const phoneInput = document.getElementById('smartwats-phone-input');
            const btn = document.getElementById('smartwats-get-code-btn');

            if (!currentSmartWatsSessionId) {
                showToast('Ø®Ø·Ø£: Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±', 'error');
                return;
            }

            let phone = phoneInput.value.trim();
            if (!phone) {
                showToast('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }

            // Clean phone number
            phone = phone.replace(/[\s\-\(\)]/g, '');
            if (phone.startsWith('+')) {
                phone = phone.substring(1);
            }

            if (phone.length < 10) {
                showToast('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹', 'error');
                return;
            }

            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

            try {
                const res = await fetch('/api/whatsapp/send-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: currentSmartWatsSessionId,
                        phoneNumber: phone
                    })
                });

                const data = await res.json();

                if (!res.ok || !data.code) {
                    throw new Error(data.error || 'ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¨Ø·');
                }

                // Show pairing code
                document.getElementById('smartwats-pairing-code-value').textContent = data.code;
                document.getElementById('smartwats-pairing-code-display').style.display = 'block';
                document.getElementById('smartwats-pairing-form').style.display = 'none';

                // Show notification message
                showToast('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø¨Ø·! ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ø®Ù„ - ÙŠØ¬Ø¨ Ø£Ù† ÙŠØµÙ„ Ø¥Ø´Ø¹Ø§Ø± ÙŠØ·Ù„Ø¨ Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø²', 'success');

            } catch (error) {
                console.error('Error requesting pairing code:', error);
                showToast('âŒ ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function copySmartWatsPairingCode() {
            const codeElement = document.getElementById('smartwats-pairing-code-value');
            const code = codeElement.textContent.trim();

            if (code === '--------') {
                showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ¯ Ù„Ù„Ù†Ø³Ø®', 'warning');
                return;
            }

            navigator.clipboard.writeText(code).then(() => {
                showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯', 'success');
                codeElement.style.color = '#25D366';
                setTimeout(() => {
                    codeElement.style.color = 'var(--primary)';
                }, 1000);
            }).catch(err => {
                showToast('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯', 'error');
            });
        }

        // Show pairing code modal
        function showPairingCodeModal(sessionId, code, phoneNumber) {
            // Set current session ID
            currentSessionId = sessionId;

            // Update modal content
            document.getElementById('pairing-code-value-admin').textContent = code;
            document.getElementById('pairing-code-display-admin').style.display = 'block';
            document.getElementById('phone-link-form-admin').style.display = 'none';

            // Hide QR code section and show pairing code section
            document.getElementById('status-waiting').style.display = 'none';
            document.getElementById('status-connecting').style.display = 'block'; // Show this section to display pairing code
            document.getElementById('status-connected').style.display = 'none';
            document.getElementById('status-error').style.display = 'none';

            // Hide QR image and show pairing code instead
            const qrImage = document.getElementById('qr-popup-image');
            if (qrImage) {
                qrImage.style.display = 'none';
            }

            // Update session info
            fetch('/api/whatsapp/list').then(res => res.json()).then(sessions => {
                const session = sessions.find(s => s.session_id === sessionId);
                if (session) {
                    document.getElementById('display-device').textContent = session.device_type || 'WhatsApp';
                    document.getElementById('display-session-name').textContent = session.name || 'Ø¬Ù„Ø³Ø© ÙˆØ§ØªØ³Ø§Ø¨';
                }
            }).catch(err => console.error('Error fetching session:', err));

            // Update phone number in input if provided
            if (phoneNumber) {
                const phoneInput = document.getElementById('pairing-phone-admin');
                if (phoneInput) {
                    phoneInput.value = phoneNumber;
                }
            }

            // Show the popup
            document.getElementById('qr-popup').classList.add('active');
        }

        // ... (Keep helper functions like showQRConnected, showQRError etc)

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Handle hash-based or query-based tab switching
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');
            const hash = window.location.hash ? window.location.hash.substring(1) : null;
            const targetTab = hash || tabParam;

            if (targetTab) {
                if (targetTab === 'whatsapp') {
                    switchTab('whatsapp');
                } else if (targetTab === 'overview' || targetTab === 'dashboard' || targetTab === 'stats') {
                    switchTab('stats'); // Admin dashboard uses 'stats' for overview
                } else if (targetTab === 'users' || targetTab === 'plans' || targetTab === 'payments' || targetTab === 'logs') {
                    switchTab(targetTab);
                }
            }

            // Request Browser Notification status
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }

            loadSidebarState();
            loadStats();
            loadUsers();

            loadPlans();

            if (document.getElementById('whatsapp-tab')) {
                loadSessions();
                setInterval(loadSessions, 10000);
            }

            // Handle add session form
            const addSessionForm = document.getElementById('add-session-form');
            if (addSessionForm) {
                addSessionForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const sessionName = document.getElementById('session-name').value;
                    const countryCode = document.getElementById('country-code').value;
                    const phoneNumber = document.getElementById('session-phone').value;
                    const webhookUrl = document.getElementById('session-webhook').value;

                    if (!sessionName || !countryCode || !phoneNumber) {
                        alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                        return;
                    }

                    const fullPhoneNumber = countryCode + phoneNumber;

                    closeModal('add-session-modal');

                    // 1. Call connect to get session ID
                    try {
                        console.log('Sending connect request with data:', { sessionName, phoneNumber: fullPhoneNumber, webhookUrl });

                        const res = await fetch('/api/whatsapp/connect', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            credentials: 'same-origin',
                            body: JSON.stringify({
                                userId: '<%= user.id %>', // Current admin user
                                phoneNumber: fullPhoneNumber,
                                deviceType: 'Android',
                                sessionName,
                                webhookUrl
                            })
                        });

                        console.log('Response status:', res.status);
                        console.log('Response headers:', res.headers);

                        const contentType = res.headers.get('content-type');
                        console.log('Content-Type:', contentType);

                        if (!contentType || !contentType.includes('application/json')) {
                            const text = await res.text();
                            console.error('Non-JSON response:', text.substring(0, 500));
                            alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„ÙŠØ³Øª JSON. ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.');
                            return;
                        }

                        const data = await res.json();
                        console.log('Response data:', data);

                        if (data.success) {
                            currentSessionId = data.sessionId;
                            console.log('Set currentSessionId:', currentSessionId);
                            showQRPopup('Android', sessionName);
                            startQRMonitoring(data.sessionId);
                        } else {
                            alert('âŒ ÙØ´Ù„ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©: ' + (data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                        }
                    } catch (e) {
                        console.error('Connect request error:', e);
                        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + e.message);
                    }
                });
            }
        });

        function showQRConnecting() {
            document.getElementById('status-waiting').style.display = 'none';
            document.getElementById('status-connecting').style.display = 'block';
        }

        function showQRConnected() {
            document.getElementById('status-waiting').style.display = 'none';
            document.getElementById('status-connecting').style.display = 'none';
            document.getElementById('status-connected').style.display = 'block';
        }

        function showQRError(msg) {
            document.getElementById('status-error').style.display = 'block';
            document.getElementById('error-message').textContent = msg;
        }

        // Phone Linking Functions
        function togglePhoneLink() {
            const form = document.getElementById('phone-link-form');
            const btn = document.getElementById('toggle-phone-link-btn');

            if (form.style.display === 'none') {
                form.style.display = 'block';
                btn.style.opacity = '0.5';

                // Pre-fill phone if available in current session context (need to pass it or store it)
                // For now, let user enter it.
            } else {
                form.style.display = 'none';
                btn.style.opacity = '0.9';
            }
        }

        async function requestPairingCode() {
            const phoneInput = document.getElementById('pairing-phone');
            const phone = phoneInput.value.trim();
            const btn = document.getElementById('get-code-btn');

            if (!phone) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ');
                return;
            }

            // Loading state
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø·Ù„Ø¨...';
            btn.disabled = true;

            try {
                // We need currentSessionId which is set in showQRForSession
                if (!currentSessionId) {
                    throw new Error('No active session selected');
                }

                const res = await fetch(`/api/whatsapp/${currentSessionId}/pairing-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phoneNumber: phone })
                });

                const data = await res.json();

                if (data.success && data.code) {
                    // Show code
                    document.getElementById('phone-link-form').style.display = 'none';
                    document.getElementById('pairing-code-display').style.display = 'block';

                    // Format code (ABC-DEF-GHI or similar, Baileys usually returns string)
                    // Let's split it if it's long for readability, but usually it's short enough.
                    // Baileys returns formatted string usually? Or just raw?
                    // Let's display as is.
                    document.getElementById('pairing-code-value').textContent = data.code;

                    // Hide QR image to reduce confusion? Or keep it?
                    // Maybe hide it.
                    document.getElementById('qr-popup-image').style.opacity = '0.3';
                } else {
                    alert('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯: ' + (data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            } catch (error) {
                console.error('Pairing code error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯', 'success');
            }).catch(err => console.error('Failed to copy:', err));
        }

        function copyPairingCodeAdmin() {
            const codeElement = document.getElementById('pairing-code-value-admin');
            if (!codeElement) return;

            const text = codeElement.innerText;
            navigator.clipboard.writeText(text).then(() => {
                const originalColor = codeElement.style.color;
                codeElement.style.color = '#25D366';
                showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯', 'success');
                setTimeout(() => codeElement.style.color = originalColor, 500);
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®', 'error');
            });
        }

        // Redirect checkWhatsAppStatus to loadSessions for backward compatibility if called elsewhere
        function checkWhatsAppStatus() { loadSessions(); }

        // Send Test Message Modal
        function sendTestMessageModal(sessionId) {
            document.getElementById('test-session-id').value = sessionId;
            document.getElementById('test-phone-number').value = '';
            document.getElementById('test-message-text').value = 'Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ù† Ù†Ø¸Ø§Ù… ÙˆØ§ØµÙ„';
            document.getElementById('test-message-modal').classList.add('active');
        }

        function closeTestModal() {
            document.getElementById('test-message-modal').classList.remove('active');
        }

        async function submitTestMessage() {
            const sessionId = document.getElementById('test-session-id').value;
            const phone = document.getElementById('test-phone-number').value;
            const message = document.getElementById('test-message-text').value;

            if (!phone || !message) {
                // Use toast if available
                if (typeof showToast === 'function') {
                    showToast('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
                } else {
                    alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
                }
                return;
            }

            // Show sending state
            const btn = document.querySelector('#test-message-modal .action-btn.primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/whatsapp/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        phoneNumber: phone,
                        message: message
                    })
                });

                const result = await res.json();

                if (result.success) {
                    closeTestModal();
                    if (typeof showToast === 'function') {
                        showToast('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    } else {
                        alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                    }
                } else {
                    if (typeof showToast === 'function') {
                        showToast('âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
                    } else {
                        alert('âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                    }
                }
            } catch (error) {
                console.error('Send message error:', error);
                if (typeof showToast === 'function') {
                    showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + error.message, 'error');
                } else {
                    alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + error.message);
                }
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Send Test Message Function
        async function sendTestMessage(sessionId, phone, message) {
            try {
                const res = await fetch('/api/whatsapp/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        phoneNumber: phone,
                        message: message
                    })
                });

                const result = await res.json();

                if (result.success) {
                    alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            } catch (error) {
                console.error('Send message error:', error);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + error.message);
            }
        }

        // Header Functions
        function toggleNotifications() {
            const dropdown = document.getElementById('notifications-dropdown');
            const profileDropdown = document.getElementById('profile-dropdown');
            profileDropdown.style.display = 'none';
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        function toggleAdminProfile() {
            const dropdown = document.getElementById('profile-dropdown');
            const notificationsDropdown = document.getElementById('notifications-dropdown');
            notificationsDropdown.style.display = 'none';
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (event) {
            const profileBtn = event.target.closest('[onclick*="toggleAdminProfile"]');
            const notificationBtn = event.target.closest('[onclick*="toggleNotifications"]');
            const profileDropdown = document.getElementById('profile-dropdown');
            const notificationsDropdown = document.getElementById('notifications-dropdown');

            if (!profileBtn && !profileDropdown.contains(event.target)) {
                profileDropdown.style.display = 'none';
            }
            if (!notificationBtn && !notificationsDropdown.contains(event.target)) {
                notificationsDropdown.style.display = 'none';
            }
        });

        // Update current date
        function updateCurrentDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const today = new Date().toLocaleDateString('ar-EG', options);
            const dateElement = document.getElementById('current-date');
            if (dateElement) {
                dateElement.textContent = today;
            }
        }

        // Update notification badge count
        function updateNotificationBadge(count) {
            const badge = document.getElementById('notification-badge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'flex' : 'none';
            }
        }

        // Fetch and display notifications from API
        let lastNotificationId = 0;
        let isInitialLoad = true;

        async function loadNotifications() {
            try {
                const res = await fetch('/api/admin/notifications');
                if (!res.ok) return;

                const notifications = await res.json();
                const unreadNotifs = notifications.filter(n => !n.is_read);
                const unreadCount = unreadNotifs.length;

                updateNotificationBadge(unreadCount);

                // Update Sidebar Payments Badge (Filter for unread payment-related notifications)
                const paymentsBadge = document.getElementById('payments-badge');
                if (paymentsBadge) {
                    const pendingPaymentNotifs = notifications.filter(n => !n.is_read && n.type === 'warning').length;
                    paymentsBadge.textContent = pendingPaymentNotifs;
                    paymentsBadge.style.display = pendingPaymentNotifs > 0 ? 'flex' : 'none';
                }

                const notificationsList = document.getElementById('notifications-list');
                if (notifications.length === 0) {
                    notificationsList.innerHTML = `
                        <div style="padding: 1.5rem; text-align: center; color: var(--text-muted);">
                            <i class="fas fa-bell-slash" style="font-size: 2rem; opacity: 0.2; display: block; margin-bottom: 10px;"></i>
                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹
                        </div>
                    `;
                    return;
                }

                // Detect NEW notifications for Sound, Toast & Browser Notification
                if (notifications.length > 0) {
                    const latestId = Math.max(...notifications.map(n => n.id));

                    if (!isInitialLoad && latestId > lastNotificationId) {
                        const newOnes = notifications.filter(n => n.id > lastNotificationId).reverse();
                        newOnes.forEach(n => {
                            // 1. Show In-App Toast
                            if (typeof showToast === 'function') {
                                showToast(`${n.title}: ${n.message}`, n.type === 'warning' ? 'warning' : 'info');
                            }

                            // 2. Trigger Browser Notification
                            if ('Notification' in window && Notification.permission === 'granted' && !document.hasFocus()) {
                                const notification = new Notification(n.title, {
                                    body: n.message,
                                    icon: '/favicon.png',
                                    dir: 'rtl'
                                });
                                notification.onclick = () => {
                                    window.focus();
                                    if (n.type === 'warning') switchTab('payments');
                                    markAsRead(n.id, n.type);
                                };
                            }
                        });

                        // 3. Play sound alert
                        try {
                            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');
                            audio.volume = 0.5;
                            audio.play().catch(e => console.log('Audio play blocked'));
                        } catch (e) { }
                    }
                    lastNotificationId = latestId;
                }
                isInitialLoad = false;

                notificationsList.innerHTML = notifications.map(n => `
                    <div style="padding: 1rem; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; position: relative; ${!n.is_read ? 'background: var(--primary-light);' : ''}" 
                         onmouseover="this.style.background='var(--bg-secondary)'" 
                         onmouseout="this.style.background='${!n.is_read ? 'var(--primary-light)' : 'transparent'}'"
                         onclick="markAsRead('${n.id}', '${n.type}')">
                        <div style="display: flex; gap: 12px; align-items: flex-start;">
                            <div style="width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: ${n.type === 'warning' ? '#fff3e0' : '#e3f2fd'}; color: ${n.type === 'warning' ? '#fb8c00' : '#1e88e5'};">
                                <i class="fas ${n.type === 'warning' ? 'fa-money-bill-wave' : 'fa-info-circle'}"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                    <span style="color: var(--text-main); font-weight: 600; font-size: 0.9rem;">${n.title}</span>
                                    <span style="color: var(--text-muted); font-size: 0.75rem;">${formatTimeAgo(n.created_at)}</span>
                                </div>
                                <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0; line-height: 1.4;">${n.message}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        async function markAsRead(id, type) {
            try {
                await fetch(`/api/admin/notifications/${id}/read`, { method: 'POST' });
                loadNotifications();

                // If it's a payment notification, go to payments tab
                if (type === 'warning') {
                    switchTab('payments');
                    document.getElementById('notifications-dropdown').style.display = 'none';
                }
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }

        async function markAllNotificationsAsRead() {
            try {
                await fetch('/api/admin/notifications/read-all', { method: 'POST' });
                loadNotifications();
            } catch (error) {
                console.error('Error marking all as read:', error);
            }
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);

            if (diffInSeconds < 60) return 'Ø§Ù„Ø¢Ù†';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}Ø¯`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}Ø³`;
            return date.toLocaleDateString('ar-EG');
        }

        // Request browser notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Initialize header on page load
        document.addEventListener('DOMContentLoaded', function () {
            console.log('âœ… DOM Content Loaded - Starting admin initialization');

            updateCurrentDate();
            loadNotifications();

            // Delay dynamic tabs loading to ensure DOM is fully ready
            setTimeout(() => {
                loadAdminTabs().catch(err => {
                    console.warn('Failed to load dynamic tabs, using static navigation:', err);
                });
            }, 500);

            // Reload notifications every 30 seconds
            setInterval(loadNotifications, 30000);
        });

        // ==================== DYNAMIC TABS MANAGEMENT ====================

        // Load admin tabs dynamically
        async function loadAdminTabs() {
            try {
                console.log('ğŸ”„ Fetching admin tabs from /api/admin/tabs...');

                const res = await fetch('/api/admin/tabs');

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const tabs = await res.json();
                console.log('ğŸ“‹ Received tabs:', tabs);

                if (!tabs || tabs.length === 0) {
                    console.warn('âš ï¸ No tabs returned from server');
                    return;
                }

                const sidebarNav = document.querySelector('.admin-nav');

                if (!sidebarNav) {
                    console.error('âŒ Sidebar nav element not found');
                    return;
                }

                // Build sidebar navigation items
                const navHTML = tabs.map(tab => `
                    <div class="admin-nav-item ${tab.name === 'dashboard' ? 'active' : ''}" 
                         onclick="switchTab('${tab.name}')" 
                         data-tooltip="${tab.label}"
                         data-tab-name="${tab.name}">
                        <i class="${tab.icon}"></i>
                        <span>${tab.label}</span>
                    </div>
                `).join('');

                // Add logout button at the end
                const logoutButton = `
                    <div class="admin-nav-item" onclick="window.location.href='/logout'" 
                         data-tooltip="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"
                         style="margin-top: 2rem; color: #f44336;">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                    </div>
                `;

                // Replace the static navigation with dynamic one
                sidebarNav.innerHTML = navHTML + logoutButton;
                console.log('âœ… Sidebar navigation updated dynamically');

                // Attach click handlers to nav items for mobile
                document.querySelectorAll('.admin-nav-item').forEach(item => {
                    item.addEventListener('click', function (e) {
                        if (window.innerWidth <= 1024 && !this.textContent.includes('ØªØ³Ø¬ÙŠÙ„')) {
                            const sidebar = document.querySelector('.admin-sidebar');
                            if (sidebar) {
                                sidebar.classList.remove('open');
                            }
                        }
                    });
                });

                console.log('âœ… Admin tabs loaded and initialized successfully');
            } catch (error) {
                console.error('âŒ Error loading admin tabs:', error);
                console.warn('âš ï¸ Using static navigation (dynamic tabs unavailable)');
                // Don't crash - the static HTML tabs will be used as fallback
            }
        }

        // Switch tab function (updated to work with dynamic tabs)
        function switchTab(tabName) {
            // Special handling for settings tab - redirect to settings page
            if (tabName === 'settings') {
                window.location.href = '/dashboard/settings';
                return;
            }
            if (tabName === 'islamic_reminders') {
                window.location.href = '/dashboard/islamic-reminders';
                return;
            }

            const allTabs = document.querySelectorAll('.tab-content');
            const allNavItems = document.querySelectorAll('.admin-nav-item');
            const adminHeader = document.getElementById('admin-header');

            allTabs.forEach(tab => tab.classList.remove('active'));
            allNavItems.forEach(item => item.classList.remove('active'));

            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Set active nav item
            const selectedNav = document.querySelector(`[data-tab-name="${tabName}"]`);
            if (selectedNav) {
                selectedNav.classList.add('active');
            }

            // Show/hide header based on tab
            if (adminHeader) {
                if (tabName === 'dashboard') {
                    adminHeader.style.display = 'flex';
                } else {
                    adminHeader.style.display = 'none';
                }
            }

            // Load data when switching tabs
            if (tabName === 'users') loadUsers();

            if (tabName === 'plans') loadPlans();
            if (tabName === 'payments') loadActivationRequests();
            if (tabName === 'whatsapp') loadSessions();
            if (tabName === 'dashboard') loadStats();
            if (tabName === 'content_library') loadContentLibrary();
        }

        // ==================== CONTENT LIBRARY SCRIPTS ====================

        async function loadContentLibrary() {
            try {
                const res = await fetch('/api/admin/content');
                const content = await res.json();
                displayContent(content);
            } catch (error) {
                console.error('Error loading content:', error);
            }
        }

        let allContent = [];

        function displayContent(contentList) {
            allContent = contentList;
            const tbody = document.getElementById('content-library-tbody');
            if (!tbody) return;

            if (contentList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù…Ø¶Ø§Ù.</td></tr>`;
                return;
            }

            tbody.innerHTML = contentList.map(item => `
                <tr>
                    <td>
                        <span class="badge ${item.type === 'adhkar' ? 'badge-info' : 'badge-success'}">
                            ${item.type === 'adhkar' ? 'Ø£Ø°ÙƒØ§Ø±' : 'Ø­Ø¯ÙŠØ«'}
                        </span>
                    </td>
                    <td>${item.category || '-'}</td>
                    <td style="max-width: 400px; white-space: pre-wrap;">${item.content_ar.substring(0, 100)}${item.content_ar.length > 100 ? '...' : ''}</td>
                    <td>${item.source || '-'}</td>
                    <td>
                        <button class="action-btn primary" onclick='editContent(${JSON.stringify(item)})'><i class="fas fa-edit"></i></button>
                        <button class="action-btn danger" onclick="deleteContent('${item.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function filterContent(type) {
            document.querySelectorAll('[data-content-filter]').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-content-filter="${type}"]`).classList.add('active');

            if (type === 'all') {
                loadContentLibrary();
            } else {
                fetch(`/api/admin/content?type=${type}`)
                    .then(res => res.json())
                    .then(data => displayContent(data));
            }
        }

        function openContentModal(content = null) {
            const modal = document.getElementById('content-modal');
            const title = document.getElementById('content-modal-title');

            if (content) {
                title.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰';
                document.getElementById('content-id').value = content.id;
                document.getElementById('content-type').value = content.type;
                document.getElementById('content-category').value = content.category || '';
                document.getElementById('content-text').value = content.content_ar;
                document.getElementById('content-source').value = content.source || '';
            } else {
                title.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰';
                document.getElementById('content-id').value = '';
                document.getElementById('content-type').value = 'adhkar';
                document.getElementById('content-category').value = '';
                document.getElementById('content-text').value = '';
                document.getElementById('content-source').value = '';
            }

            modal.style.display = 'flex';
        }

        function closeContentModal() {
            document.getElementById('content-modal').style.display = 'none';
        }

        function editContent(content) {
            openContentModal(content);
        }

        async function saveContent() {
            const id = document.getElementById('content-id').value;
            const data = {
                type: document.getElementById('content-type').value,
                category: document.getElementById('content-category').value,
                content_ar: document.getElementById('content-text').value,
                source: document.getElementById('content-source').value
            };

            if (!data.content_ar) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰');
                return;
            }

            try {
                const url = id ? `/api/admin/content/${id}` : '/api/admin/content';
                const method = id ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
                    closeContentModal();
                    loadContentLibrary();
                } else {
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£');
                }
            } catch (error) {
                console.error(error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        async function deleteContent(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) return;
            try {
                await fetch(`/api/admin/content/${id}`, { method: 'DELETE' });
                loadContentLibrary();
            } catch (error) {
                console.error(error);
            }
        }
    </script>
    <!-- Test Message Modal -->
    <div id="test-message-modal" class="modal" style="z-index: 10001;">
        <div class="modal-content"
            style="max-width: 500px; background: var(--bg-card); border-radius: 16px; padding: 24px;">
            <div class="modal-header" style="justify-content: space-between; margin-bottom: 20px;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-paper-plane" style="color: var(--primary);"></i>
                    Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                </h3>
                <span class="close-modal" onclick="closeTestModal()"
                    style="cursor: pointer; font-size: 1.5rem;">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="test-session-id">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="text" id="test-phone-number" class="form-control"
                        placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 010xxxxxxx)" dir="ltr"
                        style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                    <small style="display: block; margin-top: 5px; color: var(--text-muted); font-size: 0.85rem;">
                        <i class="fas fa-info-circle"></i> Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠØ© (010x) Ø¥Ù„Ù‰ Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ø¯ÙˆÙ„ÙŠØ©
                        ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
                    </small>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                    <textarea id="test-message-text" class="form-control" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."
                        style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ù† Ù†Ø¸Ø§Ù… ÙˆØ§ØµÙ„</textarea>
                </div>
                <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="action-btn danger" onclick="closeTestModal()"
                        style="padding: 10px 20px; border-radius: 8px;">Ø¥Ù„ØºØ§Ø¡</button>
                    <button class="action-btn primary" onclick="submitTestMessage()"
                        style="padding: 10px 20px; border-radius: 8px;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Modal CSS -->
    <style>
        .modal.active {
            display: flex !important;
        }
    </style>
    <div id="toast-container" class="toast-container"></div>
</body>

</html>