<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>التذكيرات الإسلامية | واصل</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
            --sal: env(safe-area-inset-left);
            --sar: env(safe-area-inset-right);
        }

        /* --- SweetAlert2 Theme Integration --- */
        div:where(.swal2-container) div:where(.swal2-popup) {
            background: var(--bg-card) !important;
            color: var(--text-main) !important;
            border: 1px solid var(--border);
        }

        div:where(.swal2-container) .swal2-title,
        div:where(.swal2-container) .swal2-html-container,
        div:where(.swal2-container) .swal2-close {
            color: var(--text-main) !important;
        }

        div:where(.swal2-container) .swal2-input,
        div:where(.swal2-container) .swal2-textarea,
        div:where(.swal2-container) .swal2-select {
            background: var(--bg-secondary) !important;
            color: var(--text-main) !important;
            border-color: var(--border) !important;
        }

        div:where(.swal2-container) .swal2-confirm {
            background-color: var(--primary) !important;
            color: #fff !important;
        }

        div:where(.swal2-container) .swal2-cancel {
            background-color: var(--bg-secondary) !important;
            color: var(--text-main) !important;
        }

        div:where(.swal2-container) .swal2-icon.swal2-success {
            border-color: var(--primary) !important;
            color: var(--primary) !important;
        }
        
        div:where(.swal2-container) .swal2-icon.swal2-success .swal2-success-line-tip,
        div:where(.swal2-container) .swal2-icon.swal2-success .swal2-success-line-long {
            background-color: var(--primary) !important;
            color: var(--primary) !important;
        }
        
        div:where(.swal2-container) .swal2-icon.swal2-success .swal2-success-ring {
            border-color: rgba(37, 211, 102, 0.3) !important;
        }

        /* Dark Mode specific backdrop adjustment */
        [data-theme="dark"] div:where(.swal2-container).swal2-backdrop-show {
            background: rgba(0,0,0,0.8) !important;
        }

        /* --- Admin Layout Styles (Copied from User Dashboard for Consistency) --- */
        .admin-layout {
            display: flex;
            min-height: 100vh;
            background: var(--bg-main);
            padding-left: var(--sal);
            padding-right: var(--sar);
            padding-bottom: var(--sab);
        }

        .admin-sidebar {
            width: 280px;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            padding: 2rem 0;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            transition: width 0.3s ease;
            z-index: 100;
        }

        .admin-sidebar.collapsed {
            width: 80px;
        }

        .admin-sidebar.collapsed .admin-brand h2 span,
        .admin-sidebar.collapsed .admin-brand p,
        .admin-sidebar.collapsed .nav-text {
            display: none;
        }

        .admin-sidebar.collapsed .admin-nav-item {
            justify-content: center;
            padding: 12px;
        }

        .admin-sidebar.collapsed .admin-nav-item i {
            margin: 0;
        }

        .collapse-btn,
        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            width: 40px !important;
            height: 40px !important;
            min-width: 40px !important;
            min-height: 40px !important;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
            color: var(--text-muted);
            flex-shrink: 0;
            padding: 0;
            margin: 0;
        }

        .collapse-btn:hover,
        .theme-toggle:hover {
            background: var(--primary-light);
            color: var(--primary-dark);
            border-color: var(--primary);
        }

        .admin-sidebar.collapsed .collapse-btn i {
            transform: rotate(180deg);
        }

        .admin-brand {
            padding: 1.5rem 1rem 2rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .brand-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .admin-sidebar.collapsed .brand-header {
            flex-direction: column;
            gap: 12px;
        }

        .admin-brand h2 {
            color: var(--primary-dark);
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-nav {
            padding: 0 1rem;
        }

        .admin-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 6px;
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            transition: 0.2s;
            font-weight: 600;
            text-decoration: none;
        }

        .admin-nav-item:hover {
            background: var(--bg-secondary);
            color: var(--primary);
        }

        .admin-nav-item.active {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .admin-nav-item i {
            width: 20px;
            text-align: center;
        }

        .admin-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            height: 100vh;
        }

        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            font-size: 1.2rem;
        }

        @media (max-width: 1024px) {
            .admin-sidebar {
                position: fixed;
                right: -280px;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: right 0.3s ease;
                box-shadow: var(--shadow-lg);
            }

            .admin-sidebar.open {
                right: 0;
            }

            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .admin-content {
                padding: 5rem 1rem 2rem;
            }
        }

        /* --- Islamic Reminders Specific Styles --- */
        .content-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-main);
            /* Ensure background for sticky */
            padding: 10px 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 900;
        }

        /* Mobile specific adjustments for header */
        @media (max-width: 1024px) {
            .content-header {
                display: none;
                /* Hide header on mobile/tablet */
                position: sticky;
                top: 0;
                padding: 15px 5px;
                margin-bottom: 20px;
                border-bottom: 1px solid var(--border);
                margin-top: -3rem;
                background: var(--bg-main);
                /* Add solid background */
                z-index: 100;
                /* Ensure it stays above content */
                /* Pull up into the padding area */
            }

            .content-header.header-hidden {
                transform: translateY(-100%);
                opacity: 0;
                pointer-events: none;
            }
        }

        .content-header h1 {
            color: var(--text-main);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .content-header h1 i {
            color: var(--primary);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 25px;
        }

        @media (max-width: 900px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 24px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .card h2 {
            color: var(--text-main);
            font-size: 1.2rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }

        .card h2 i {
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-main);
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-card);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary-light);
        }

        .btn-danger {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            padding: 5px 10px;
        }

        .btn-danger:hover {
            background: rgba(231, 76, 60, 0.2);
        }

        /* Hero Card for Next Prayer - Premium Design */
        .next-prayer-card {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            /* Default dynamic gradient */
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            color: white;
            text-align: center;
            padding: 40px 20px;
            border: none;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: all 0.5s ease;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .next-prayer-card.prayer-fajr {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
        }

        .next-prayer-card.prayer-dhuhr {
            background: linear-gradient(135deg, #2980b9, #6dd5fa, #ffffff);
            color: #2c3e50;
        }

        .next-prayer-card.prayer-asr {
            background: linear-gradient(135deg, #f8b500, #fceabb);
            color: #2c3e50;
        }

        .next-prayer-card.prayer-maghrib {
            background: linear-gradient(135deg, #4b6cb7, #182848);
        }

        .next-prayer-card.prayer-isha {
            background: linear-gradient(135deg, #000428, #004e92);
        }

        .next-prayer-card h3 {
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 0.85rem;
            margin-bottom: 5px;
            font-weight: 700;
            opacity: 0.8;
        }

        .next-prayer-card h1 {
            font-size: 4rem;
            margin: 5px 0;
            font-weight: 900;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.3));
        }

        .next-prayer-card p {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 0;
        }

        .countdown-badge {
            margin-top: 25px;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 12px 30px;
            border-radius: 50px;
            display: inline-block;
            font-size: 1.1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
            }
        }

        .next-prayer-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        /* Prayer List & New Smart Cards */
        .prayer-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .prayer-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            padding: 0;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .prayer-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .prayer-card.active-glow {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(var(--primary-rgb), 0.15);
        }

        .prayer-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .prayer-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .prayer-info i {
            font-size: 1.2rem;
            color: var(--primary);
        }

        .prayer-info h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .status-badge {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .prayer-body {
            padding: 20px;
        }

        .time-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .main-time {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            line-height: 1;
        }

        .btn-edit-time {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--primary);
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-edit-time:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .time-elapsed-counter {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 5px;
            display: block;
            font-family: monospace;
        }

        .quick-settings {
            margin-bottom: 20px;
        }

        .quick-settings label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .pill-group {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .pill-btn {
            background: var(--bg-main);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pill-btn:hover {
            background: var(--bg-secondary);
        }

        .pill-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .athkar-section {
            background: var(--bg-secondary);
            padding: 15px;
            margin: 0 20px 20px;
            border-radius: var(--radius-sm);
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .athkar-section h4 {
            margin: 0 0 10px;
            font-size: 0.9rem;
            color: var(--text-muted);
            border-bottom: 1px dashed var(--border);
            padding-bottom: 5px;
        }

        .athkar-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .athkar-item {
            font-size: 0.9rem;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
            display: flex;
            justify-content: space-between;
        }
        
        .athkar-item:last-child {
            border-bottom: none;
        }

        .prayer-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-top: 1px solid var(--border);
        }

        .action-btn {
            background: none;
            border: none;
            padding: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-muted);
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn:hover {
            background: var(--bg-secondary);
            color: var(--primary);
        }

        .action-btn:first-child {
            border-left: 1px solid var(--border);
        }

        .prayer-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            transition: 0.2s;
        }

        .prayer-list-item:last-child {
            border-bottom: none;
        }

        .prayer-list-item:hover {
            background: var(--bg-secondary);
        }

        .prayer-name {
            font-weight: 600;
            color: var(--text-main);
        }

        .prayer-time {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-weight: 700;
            color: var(--primary-dark);
            background: linear-gradient(135deg, var(--primary-light), rgba(var(--primary-rgb), 0.2));
            padding: 6px 14px;
            border-radius: 12px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            font-size: 1.05rem;
        }

        .prayer-list-item.current-prayer {
            background: rgba(var(--primary-rgb), 0.05);
            border-right: 4px solid var(--primary);
            box-shadow: inset 5px 0 15px rgba(var(--primary-rgb), 0.03);
        }

        .prayer-list-item.current-prayer .prayer-name {
            color: var(--primary-dark);
            font-weight: 800;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: var(--primary);
        }

        input:checked+.toggle-slider:before {
            transform: translateX(24px);
        }

        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: rgba(33, 150, 243, 0.1);
            color: #2196F3;
            border: 1px solid rgba(33, 150, 243, 0.2);
        }

        .alert-warning {
            background: rgba(255, 152, 0, 0.1);
            color: #F57C00;
            border: 1px solid rgba(255, 152, 0, 0.2);
        }

        /* Recipient Item */
        .recipient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
        }

        .recipient-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .recipient-icon {
            width: 45px;
            height: 45px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            box-shadow: var(--shadow-sm);
            font-size: 1.2rem;
        }

        .recipient-item:hover {
            transform: translateX(-5px);
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        /* Submenu Styles */
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(0, 0, 0, 0.02);
            border-radius: var(--radius-sm);
        }

        .submenu.open {
            max-height: 500px;
            /* Arbitrary large height */
            transition: max-height 0.5s ease-in;
        }

        .submenu .admin-nav-item {
            padding-right: 2.5rem;
            /* Indent submenu items */
            font-size: 0.9em;
        }

        .submenu-arrow {
            margin-right: auto;
            transition: transform 0.3s;
            font-size: 0.8em;
        }

        .admin-nav-item.submenu-trigger.open .submenu-arrow {
            transform: rotate(-180deg);
        }

        /* Glassmorphism for cards */
        .card {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            background: rgba(var(--bg-card-rgb), 0.9);
            border: 1px solid rgba(var(--border-rgb), 0.5);
        }

        /* Mode Switcher Buttons */
        .mode-btn {
            flex: 1;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .mode-btn-active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .mode-btn-inactive {
            background: var(--bg-card);
            color: var(--text-main);
        }

        .media-options {
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .hidden {
            display: none !important;
        }

        /* --- Horizontal Tabs Styles --- */
        .nav-tabs-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            overflow-x: auto;
            padding-bottom: 5px;
            /* For scrollbar */
            border-bottom: 1px solid var(--border);
        }

        .nav-tab {
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            color: var(--text-muted);
            border: 1px solid transparent;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: var(--bg-hover);
            color: var(--text-main);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(var(--primary-rgb), 0.3);
            border-color: var(--primary);
        }

        .tab-pane {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Mobile Responsiveness --- */

        /* Small Mobile (320px - 480px) */
        @media (max-width: 480px) {
            .admin-content {
                padding: 4rem 0.75rem 1.5rem;
            }

            .nav-tab {
                padding: 8px 12px;
                font-size: 0.85rem;
                gap: 5px;
            }

            .nav-tab i {
                font-size: 0.9rem;
            }

            .card {
                padding: 12px;
                margin-bottom: 15px;
            }

            .card h2 {
                font-size: 1rem;
                gap: 8px;
            }

            .prayer-list-item {
                padding: 10px;
                gap: 10px;
            }

            .form-control {
                padding: 8px;
                font-size: 0.9rem;
            }

            .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
        }

        /* Mobile (481px - 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            .nav-tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .card {
                padding: 15px;
            }
        }

        /* Tablet and below (max-width: 768px) */
        @media (max-width: 768px) {
            .nav-tabs-container {
                -ms-overflow-style: none;
                scrollbar-width: none;
                padding-bottom: 0;
                gap: 8px;
            }

            .nav-tabs-container::-webkit-scrollbar {
                display: none;
            }

            /* Stack items in Adhkar list if needed */
            .prayer-list-item {
                flex-wrap: wrap;
            }

            /* Stack recipients actions */
            .recipient-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .recipient-item>div:last-child {
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
                border-top: 1px solid var(--border);
                padding-top: 10px;
            }

            /* Optimize next prayer card for mobile */
            .next-prayer-card h1 {
                font-size: 1.5rem;
            }

            .next-prayer-card h3 {
                font-size: 1rem;
            }
        }

        /* Tablet (769px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .admin-content {
                padding: 3rem 1.5rem;
            }

            .nav-tab {
                padding: 11px 18px;
                font-size: 0.95rem;
            }
        }

        .adhkar-layout {
            display: grid;
            grid-template-columns: 1.25fr 0.75fr;
            gap: 20px;
        }

        .adhkar-layout.single-column {
            grid-template-columns: 1fr;
        }

        .adhkar-card {
            overflow: hidden;
        }

        .adhkar-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 14px;
        }

        .adhkar-card-header h2 {
            margin: 0;
            border: none;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .adhkar-muted {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .adhkar-tabs {
            margin: 14px 0 18px 0;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 6px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .adhkar-tabs .tab-btn {
            border: none;
            background: transparent;
            padding: 10px 12px;
            border-radius: 12px;
            color: var(--text-muted);
            flex: 1 1 160px;
            font-weight: 700;
            transition: 0.2s;
            white-space: nowrap;
        }

        .adhkar-tabs .tab-btn.active {
            background: var(--bg-card);
            color: var(--text-main);
            border: 1px solid var(--border);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
        }

        .adhkar-inline-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .adhkar-preview-box {
            background: var(--bg-secondary);
            padding: 14px;
            border-radius: 14px;
            border: 1px solid var(--border);
        }

        .adhkar-source-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }

        .adhkar-actions-row {
            margin-top: 14px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .adhkar-schedule-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .adhkar-schedule-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .adhkar-schedule-left {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 240px;
        }

        .adhkar-icon {
            width: 40px;
            height: 40px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .adhkar-schedule-meta {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .adhkar-title {
            margin: 0;
            font-weight: 800;
            font-size: 1rem;
            color: var(--text-main);
        }

        .adhkar-sub {
            color: var(--text-muted);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .adhkar-schedule-actions {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
        }

        .adhkar-side-sticky {
            position: sticky;
            top: 90px;
        }

        @media (max-width: 1024px) {
            .adhkar-layout {
                grid-template-columns: 1fr;
            }

            .adhkar-side-sticky {
                position: static;
            }
        }

        @media (max-width: 576px) {
            .adhkar-schedule-item {
                flex-direction: column;
                align-items: stretch;
            }

            .adhkar-schedule-left {
                min-width: 0;
            }

            .adhkar-schedule-actions {
                justify-content: space-between;
            }

            .adhkar-actions-row {
                justify-content: stretch;
            }

            .adhkar-actions-row .btn {
                width: 100%;
            }

            .adhkar-source-row {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>

<body>
    <input type="hidden" id="config-session-id" value="<%= config.session_id %>">
    <!-- Mobile Sidebar Toggle -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" onclick="toggleSidebar()"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;">
    </div>

    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="adminSidebar">
            <div class="admin-brand">
                <div class="brand-header">
                    <h2>
                        <img src="/favicon.png" alt="واصل" style="width: 35px; height: 35px; border-radius: 8px;"
                            onerror="this.style.display='none'">
                        <span>واصل</span>
                    </h2>
                    <div style="display: flex; gap: 10px; align-items: center;" class="toolbar-btns">
                        <button class="theme-toggle" onclick="toggleTheme()" title="تبديل الوضع الليلي">
                            <i class="fas fa-moon"></i>
                        </button>
                        <button class="collapse-btn" onclick="collapseSidebar()" title="طي/فرد القائمة">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 8px;">مرحباً، <%= user.name %>
                </p>
            </div>

            <nav class="admin-nav">
                <% if (user.role==='admin' ) { %>
                    <div class="admin-nav-item" onclick="window.location.href='/dashboard?tab=dashboard'">
                        <i class="fas fa-chart-line"></i>
                        <span class="nav-text">لوحة المعلومات</span>
                    </div>
                    <div class="admin-nav-item" onclick="window.location.href='/dashboard?tab=whatsapp'">
                        <i class="fab fa-whatsapp"></i>
                        <span class="nav-text">جلساتي</span>
                    </div>
                    <div class="admin-nav-item" onclick="window.location.href='/dashboard?tab=payments'">
                        <i class="fas fa-money-bill-wave"></i>
                        <span class="nav-text">طلبات التفعيل</span>
                    </div>
                    <div class="admin-nav-item" onclick="window.location.href='/dashboard?tab=users'">
                        <i class="fas fa-users"></i>
                        <span class="nav-text">إدارة المستخدمين</span>
                    </div>
                    <div class="admin-nav-item" onclick="window.location.href='/dashboard?tab=plans'">
                        <i class="fas fa-box"></i>
                        <span class="nav-text">إدارة الباقات</span>
                    </div>
                    <div class="admin-nav-item" onclick="window.location.href='/dashboard?tab=logs'">
                        <i class="fas fa-history"></i>
                        <span class="nav-text">سجل النشاط</span>
                    </div>

                    <!-- User Systems Submenu -->
                    <div class="admin-nav-item submenu-trigger" onclick="window.toggleSubmenu('user-systems-submenu')"
                        data-tooltip="أنظمة المستخدمين">
                        <i class="fas fa-cubes"></i>
                        <span class="nav-text">أنظمة المستخدمين</span>
                        <i class="fas fa-chevron-down submenu-arrow"></i>
                    </div>
                    <div id="user-systems-submenu" class="submenu">
                        <a href="/dashboard/islamic-reminders" class="admin-nav-item active">
                            <i class="fas fa-mosque"></i> <span class="nav-text">التذكيرات الإسلامية</span>
                        </a>
                    </div>

                    <div class="admin-nav-item" onclick="window.location.href='/dashboard/settings'">
                        <i class="fas fa-cog"></i>
                        <span class="nav-text">الإعدادات</span>
                    </div>

                    <% } else { %>
                        <a href="/dashboard" class="admin-nav-item">
                            <i class="fas fa-home"></i> <span class="nav-text">نظرة عامة</span>
                        </a>
                        <a href="/dashboard?tab=whatsapp" class="admin-nav-item">
                            <i class="fab fa-whatsapp"></i> <span class="nav-text">جلسات واتساب</span>
                        </a>
                        <a href="/dashboard/islamic-reminders" class="admin-nav-item active">
                            <i class="fas fa-mosque"></i> <span class="nav-text">التذكيرات الإسلامية</span>
                        </a>
                        <% } %>
                            <a href="/logout" class="admin-nav-item" style="margin-top: 2rem; color: #f44336;">
                                <i class="fas fa-sign-out-alt"></i> <span class="nav-text">تسجيل خروج</span>
                            </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <header class="content-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <a href="/dashboard" class="btn btn-outline"
                        style="display: inline-flex; align-items: center; gap: 8px; text-decoration: none;">
                        <i class="fas fa-arrow-right"></i>
                        <span class="back-btn-text">رجوع</span>
                    </a>
                    <h1><i class="fas fa-mosque"></i> نظام التذكيرات الإسلامية</h1>
                </div>
            </header>

            <!-- Tabs Navigation -->
            <div class="nav-tabs-container">
                <button class="nav-tab" onclick="switchTab('tab-location')">
                    <i class="fas fa-map-marker-alt"></i> الموقع
                </button>
                <button class="nav-tab active" onclick="switchTab('tab-prayers')">
                    <i class="fas fa-mosque"></i> مواقيت الصلاة
                </button>
                <button class="nav-tab" onclick="switchTab('tab-adhkar')">
                    <i class="fas fa-book-open"></i> الأذكار والمحتوى
                </button>
                <button class="nav-tab" onclick="switchTab('tab-recipients')">
                    <i class="fas fa-users"></i> المستلمين والإتصال
                </button>
            </div>

            <div class="tab-content-wrapper">
                <!-- Tab: Prayers -->
                <div id="tab-prayers" class="tab-pane active">
                    <!-- Next Prayer Hero Card -->
                    <% if (locals.nextPrayer) { %>
                        <div class="card next-prayer-card">
                            <h3>الصلاة القادمة</h3>
                            <h1 id="next-prayer-name">
                                <%= nextPrayer.nameAr %>
                            </h1>
                            <p id="next-prayer-time">
                                <i class="far fa-clock"></i>
                                <script>
                                    (function () {
                                        const time24 = '<%= nextPrayer.time %>';
                                        const [hours, minutes] = time24.split(':');
                                        const hour = parseInt(hours);
                                        const period = hour >= 12 ? 'م' : 'ص';
                                        const hour12 = hour % 12 || 12;
                                        document.write(`${hour12}:${minutes} ${period}`);
                                    })();
                                </script>
                                <% if (nextPrayer.isTomorrow) { %> (غداً) <% } %>
                            </p>
                            <div id="prayer-countdown" class="countdown-badge">
                                جاري التحميل...
                            </div>
                            <!-- Qibla Hint -->
                            <div id="qibla-hint"
                                style="margin-top: 15px; font-size: 0.85rem; opacity: 0.7; font-weight: 500;">
                                <i class="fas fa-compass"></i> اتجاه القبلة: <span id="qibla-degree">--</span>°
                            </div>
                        </div>
                        <script>
                            function updateCountdown() {
                                const nextTimeStr = "<%= nextPrayer.time %>";
                                const nextName = "<%= nextPrayer.name %>".toLowerCase();
                                const isTomorrow = "<%= (locals.nextPrayer && nextPrayer.isTomorrow) ? '1' : '0' %>" === '1';
                                const [hours, minutes] = nextTimeStr.split(':').map(Number);

                                // Update Theme
                                const card = document.querySelector('.next-prayer-card');
                                if (card) {
                                    card.className = 'card next-prayer-card prayer-' + nextName;
                                }

                                const now = new Date();
                                let target = new Date();
                                target.setHours(hours, minutes, 0, 0);

                                if (isTomorrow) {
                                    target.setDate(target.getDate() + 1);
                                } else if (target < now) {
                                    return;
                                }

                                const diff = target - now;
                                if (diff <= 0) {
                                    document.getElementById('prayer-countdown').innerText = "حان وقت الأذان";
                                    return;
                                }

                                const h = Math.floor(diff / (1000 * 60 * 60));
                                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                                const s = Math.floor((diff % (1000 * 60)) / 1000);

                                // Arabic numerals for a touch of class? No, stick to global for clear readability
                                document.getElementById('prayer-countdown').innerHTML =
                                    `<i class="fas fa-hourglass-half"></i> متبقي: ` +
                                    (h > 0 ? `<span>${h}</span> س ` : '') +
                                    `<span>${m}</span> د <span>${s}</span> ث`;
                            }

                            setInterval(updateCountdown, 1000);
                            updateCountdown();
                        </script>
                        <% } %>

                            <!-- Prayer Times List -->
                            <div class="card">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h2 style="border: none; margin: 0; padding: 0;"><i class="fas fa-pray"></i> مواقيت
                                        الصلاة</h2>
                                    <% if (locals.prayerTimes) { %>
                                        <span
                                            style="background: var(--bg-secondary); color: var(--primary-dark); padding: 5px 10px; border-radius: 20px; font-size: 0.9rem;">
                                            <i class="far fa-calendar-alt"></i>
                                            <%= prayerTimes.hijri_date %>
                                        </span>
                                        <% } %>
                                </div>

                                <!-- Location & Mode Status Bar -->
                                <style>
                                    .location-status-bar {
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                        background: linear-gradient(to right, var(--bg-secondary), var(--bg-card));
                                        padding: 15px 20px;
                                        border-radius: 12px;
                                        margin-bottom: 25px;
                                        border: 1px solid var(--border);
                                        flex-wrap: wrap;
                                        gap: 15px;
                                    }
                                    .location-info {
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                        flex: 1;
                                    }
                                    .location-icon {
                                        width: 40px;
                                        height: 40px;
                                        border-radius: 50%;
                                        background: var(--primary-light);
                                        color: var(--primary);
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 1.1rem;
                                        flex-shrink: 0;
                                    }
                                    .location-icon.manual-mode {
                                        background: var(--warning-light);
                                        color: var(--warning);
                                    }
                                    .location-details h4 {
                                        margin: 0;
                                        font-size: 1rem;
                                        font-weight: 700;
                                        color: var(--text-main);
                                    }
                                    .location-details p {
                                        margin: 2px 0 0;
                                        font-size: 0.85rem;
                                        color: var(--text-muted);
                                    }
                                    
                                    .location-actions {
                                        display: flex;
                                        align-items: center;
                                        gap: 10px;
                                    }

                                    .mode-toggle-group {
                                        display: flex;
                                        background: var(--bg-main); /* Slightly darker than card */
                                        padding: 4px;
                                        border-radius: 8px;
                                        border: 1px solid var(--border);
                                    }
                                    .mode-btn {
                                        border: none;
                                        background: transparent;
                                        padding: 6px 14px;
                                        border-radius: 6px;
                                        font-size: 0.85rem;
                                        cursor: pointer;
                                        color: var(--text-muted);
                                        font-weight: 600;
                                        transition: all 0.2s;
                                    }
                                    .mode-btn:hover {
                                        color: var(--text-main);
                                    }
                                    .mode-btn.active {
                                        background: var(--bg-card); /* White/Card bg */
                                        color: var(--primary);
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                                    }

                                    .btn-change-loc {
                                        background: transparent;
                                        border: 1px solid var(--border);
                                        color: var(--text-main);
                                        padding: 8px 12px;
                                        border-radius: 8px;
                                        font-size: 0.9rem;
                                        cursor: pointer;
                                        transition: all 0.2s;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                    }
                                    .btn-change-loc:hover {
                                        background: var(--bg-hover);
                                        border-color: var(--primary);
                                        color: var(--primary);
                                    }
                                </style>

                                <div class="location-status-bar">
                                    <div class="location-info">
                                        <div class="location-icon <%= config.prayer_time_mode === 'manual' ? 'manual-mode' : '' %>">
                                            <i class="fas <%= config.prayer_time_mode === 'manual' ? 'fa-user-clock' : 'fa-map-marker-alt' %>"></i>
                                        </div>
                                        <div class="location-details">
                                            <% if (config.prayer_time_mode === 'manual') { %>
                                                <h4>نظام التوقيت اليدوي</h4>
                                                <p>تستخدم المواقيت المخصصة يدوياً</p>
                                            <% } else if (config.location_city) { %>
                                                <h4><%= config.location_city %>، <%= config.location_country %></h4>
                                                <p>حساب تلقائي حسب الموقع</p>
                                            <% } else { %>
                                                <h4>لم يتم تحديد الموقع</h4>
                                                <p>يرجى تحديد الموقع للحساب التلقائي</p>
                                            <% } %>
                                        </div>
                                    </div>

                                    <div class="location-actions">
                                        <div class="mode-toggle-group">
                                            <button onclick="setPrayerTimeMode('auto')" 
                                                    class="mode-btn <%= config.prayer_time_mode !== 'manual' ? 'active' : '' %>" 
                                                    title="تفعيل التوقيت التلقائي">
                                                تلقائي
                                            </button>
                                            <button onclick="setPrayerTimeMode('manual')" 
                                                    class="mode-btn <%= config.prayer_time_mode === 'manual' ? 'active' : '' %>" 
                                                    title="تفعيل التوقيت اليدوي">
                                                يدوي
                                            </button>
                                        </div>

                                        <% if (config.prayer_time_mode !== 'manual') { %>
                                            <button class="btn-change-loc" onclick="switchTab('tab-location')" title="إعدادات الموقع">
                                                <i class="fas fa-cog"></i>
                                            </button>
                                        <% } %>
                                    </div>
                                </div>

                                <!-- Manual Prayer Times Input (REMOVED - Integrated into Settings Modal) -->
                                <div id="manual-prayer-times-container" style="display: none;"></div>

                                <% if (!locals.prayerTimes) { %>
                                    <div class="alert alert-warning">
                                        <i class="fas fa-map-marker-alt"></i> يرجى تحديد موقعك الجغرافي أولاً لعرض
                                        مواقيت الصلاة.
                                    </div>
                                    <% } else { %>
                                        <div class="prayer-list">
                                            <% prayerSettings.forEach(prayer => { %>
                                                <% 
                                                    const time = prayerTimes[prayer.prayer_name.toLowerCase()]; 
                                                    const isActive = locals.nextPrayer && nextPrayer.name.toLowerCase() === prayer.prayer_name.toLowerCase();
                                                    const prayerNameAr = { 'fajr': 'الفجر', 'dhuhr': 'الظهر', 'asr': 'العصر', 'maghrib': 'المغرب', 'isha': 'العشاء' }[prayer.prayer_name.toLowerCase()] || prayer.prayer_name; 
                                                    const prayerIcon = { 'fajr': 'fa-cloud-sun', 'dhuhr': 'fa-sun', 'asr': 'fa-cloud-sun-open', 'maghrib': 'fa-sunset', 'isha': 'fa-moon' }[prayer.prayer_name.toLowerCase()] || 'fa-clock';
                                                    
                                                    // Time Formatting Logic (Inline for EJS)
                                                    let time12 = time;
                                                    try {
                                                        const [h, m] = time.split(':');
                                                        const hour = parseInt(h);
                                                        const period = hour >= 12 ? 'م' : 'ص';
                                                        const h12 = hour % 12 || 12;
                                                        time12 = `${h12}:${m} ${period}`;
                                                    } catch(e) {}
                                                    
                                                    const reminderTime = prayer.reminder_before_minutes || 0;
                                                %>
                                                
                                                <div class="prayer-card <%= isActive ? 'active-glow' : '' %>" id="card-<%= prayer.id %>">
                                                    <!-- Header -->
                                                    <div class="prayer-header">
                                                        <div class="prayer-info">
                                                            <i class="fas <%= prayerIcon %>"></i>
                                                            <h3><%= prayerNameAr %></h3>
                                                            <% if (isActive) { %>
                                                                <span class="status-badge">الآن</span>
                                                            <% } %>
                                                        </div>
                                                        <div class="prayer-controls">
                                                            <label class="toggle-switch" title="تفعيل/تعطيل التذكير">
                                                                <input type="checkbox" onchange="togglePrayer('<%= prayer.id %>', this.checked)" <%= prayer.enabled ? 'checked' : '' %>>
                                                                <span class="toggle-slider"></span>
                                                            </label>
                                                        </div>
                                                    </div>

                                                    <!-- Body -->
                                                    <div class="prayer-body">
                                                        <div class="time-display">
                                                            <div class="main-time">
                                                                <%= time12 %>
                                                                <% if (config.prayer_time_mode === 'manual') { %>
                                                                    <button class="btn-edit-time" 
                                                                            title="تعديل التوقيت يدوياً"
                                                                            onclick="openPrayerSettings('<%= prayer.id %>', '<%= prayer.prayer_name %>', '<%= reminderTime %>')">
                                                                        <i class="fas fa-pen"></i>
                                                                    </button>
                                                                <% } %>
                                                            </div>
                                                            <span class="time-elapsed-counter" data-prayer-time="<%= time %>" data-prayer-name="<%= prayer.prayer_name %>">--:--:--</span>
                                                        </div>

                                                        <!-- Quick Settings -->
                                                        <div class="quick-settings">
                                                            <label><i class="fas fa-bell"></i> التنبيه قبل الأذان:</label>
                                                            <div class="pill-group">
                                                                <% [0, 5, 10, 15].forEach(mins => { %>
                                                                    <button class="pill-btn <%= reminderTime == mins ? 'active' : '' %>" 
                                                                            data-id="<%= prayer.id %>"
                                                                            data-mins="<%= mins %>"
                                                                            onclick="updateReminderDirectly(this.dataset.id, this.dataset.mins)">
                                                                        <%= mins === 0 ? 'لا يوجد' : mins + ' دقيقة' %>
                                                                    </button>
                                                                <% }); %>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Athkar Section -->
                                                    <div class="athkar-section">
                                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                            <h4 style="margin:0;"><i class="fas fa-scroll"></i> أذكار بعد الصلاة</h4>
                                                            <label class="toggle-switch" title="تفعيل/تعطيل أذكار بعد الصلاة">
                                                                <input type="checkbox" onchange="updatePrayerSetting('<%= prayer.id %>', 'post_prayer_adhkar_enabled', this.checked ? 1 : 0)" <%= prayer.post_prayer_adhkar_enabled ? 'checked' : '' %>>
                                                                <span class="toggle-slider"></span>
                                                            </label>
                                                        </div>
                                                        
                                                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; background: var(--bg-main); padding: 8px 12px; border-radius: var(--radius-sm);">
                                                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                                                <i class="fas fa-clock"></i> إرسال بعد: <strong><%= prayer.post_prayer_adhkar_delay || 5 %> دقيقة</strong>
                                                            </div>
                                                            <button class="btn btn-sm btn-outline" 
                                                                    onclick="openPostPrayerAdhkarSettings('<%= prayer.id %>', '<%= prayer.prayer_name %>', '<%= prayer.post_prayer_adhkar_delay || 5 %>', '<%= prayer.post_prayer_adhkar_show_link !== undefined ? prayer.post_prayer_adhkar_show_link : 1 %>')"
                                                                    title="إعدادات الأذكار">
                                                                <i class="fas fa-cog"></i> إعدادات
                                                            </button>
                                                        </div>

                                                        <ul class="athkar-list">
                                                            <li class="athkar-item">
                                                                <span>أستغفر الله</span>
                                                                <span class="badge" style="background:var(--bg-main); color:var(--text-muted)">3x</span>
                                                            </li>
                                                            <li class="athkar-item">
                                                                <span>اللهم أنت السلام</span>
                                                                <span class="badge" style="background:var(--bg-main); color:var(--text-muted)">1x</span>
                                                            </li>
                                                            <li class="athkar-item">
                                                                <span>آية الكرسي</span>
                                                                <span class="badge" style="background:var(--bg-main); color:var(--text-muted)">1x</span>
                                                            </li>
                                                            <li class="athkar-item">
                                                                <span>سبحان الله</span>
                                                                <span class="badge" style="background:var(--bg-main); color:var(--text-muted)">33x</span>
                                                            </li>
                                                        </ul>
                                                    </div>

                                                    <!-- Actions -->
                                                    <div class="prayer-actions">
                                                        <button class="action-btn" onclick="openTestModal('<%= prayer.prayer_name %>', 'athkar')">
                                                            <i class="fas fa-paper-plane"></i> اختبار الأذكار
                                                        </button>
                                                        <button class="action-btn" onclick="openTestModal('<%= prayer.prayer_name %>', 'prayer_time')">
                                                            <i class="fas fa-paper-plane"></i> اختبار وقت الصلاة
                                                        </button>
                                                    </div>
                                                </div>
                                            <% }) %>
                                        </div>
                                        <% } %>
                            </div>
                            
                            <!-- Save Button for Prayer Tab -->
                            <div style="margin-top: 20px; text-align: center; padding-bottom: 20px;">
                                <button onclick="Swal.fire({title: 'تم الحفظ!', text: 'تم حفظ إعدادات الصلاة بنجاح. يتم حفظ التغييرات تلقائياً عند التعديل.', icon: 'success', timer: 2000, showConfirmButton: false})" 
                                        class="btn btn-primary" 
                                        style="padding: 12px 30px; font-size: 1.1rem; width: 100%; max-width: 300px; box-shadow: 0 4px 15px rgba(var(--primary-rgb), 0.3);">
                                    <i class="fas fa-save"></i> حفظ إعدادات الصلاة
                                </button>
                            </div>

                </div> <!-- End Tab Prayers -->

                <div id="tab-adhkar" class="tab-pane"
                    data-text-length="<%= adhkarSettings.text_length || 'full' %>"
                    data-media-preference="<%= adhkarSettings.media_preference || 'mixed' %>">
                    <% 
                        const formatTime12 = (timeStr) => {
                            try {
                                const parts = String(timeStr || '').split(':');
                                const h = parseInt(parts[0], 10);
                                const m = parts[1] || '00';
                                const period = h >= 12 ? 'م' : 'ص';
                                const h12 = (h % 12) || 12;
                                return `${h12}:${m} ${period}`;
                            } catch (e) {
                                return timeStr;
                            }
                        };
                    %>
                    <div class="card" style="margin-bottom: 20px;">
                        <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px;">
                            <h4 style="margin: 0 0 10px 0;">نمط التجربة المفضل:</h4>
                            <input type="hidden" id="experience_mode_input" value="<%= adhkarSettings.morning_source === 'manual' ? 'manual' : 'auto' %>">
                            <div style="display: flex; gap: 10px;">
                                <button onclick="setExperienceMode('manual')" id="btn-mode-manual"
                                    class="btn mode-btn <%= adhkarSettings.morning_source === 'manual' ? 'mode-btn-active' : 'mode-btn-inactive' %>">
                                    📖 وضع القراءة (نص كامل)
                                </button>
                                <button onclick="setExperienceMode('auto')" id="btn-mode-auto"
                                    class="btn mode-btn <%= adhkarSettings.morning_source !== 'manual' ? 'mode-btn-active' : 'mode-btn-inactive' %>">
                                    🖼️ وضع المشاهدة (صور/فيديو)
                                </button>
                            </div>
                            <small style="color: var(--text-muted); display: block; margin-top: 10px; font-size: 0.9rem;">
                                يحدد هذا الإعداد طريقة عرض أذكار الصباح، المساء، وحديث اليوم.
                            </small>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <button onclick="saveAdhkarTabSettings()" class="btn btn-primary" style="width: 100%; padding: 12px 14px; font-size: 1.05rem;">
                            <i class="fas fa-save"></i> حفظ جميع الإعدادات
                        </button>
                    </div>

                    <div class="adhkar-layout" id="adhkar-layout">
                        <div class="adhkar-main">
                            <div class="tabs adhkar-tabs" style="margin-top: 0;">
                                <button onclick="switchAdhkarHubTab('morning-evening')" id="hub-btn-morning-evening" class="tab-btn active" style="flex:1;">
                                    <i class="fas fa-sun"></i> الصباح والمساء
                                </button>
                                <button onclick="switchAdhkarHubTab('hadith')" id="hub-btn-hadith" class="tab-btn" style="flex:1;">
                                    <i class="fas fa-book-open"></i> الأحاديث
                                </button>
                                <button onclick="switchAdhkarHubTab('selected')" id="hub-btn-selected" class="tab-btn" style="flex:1;">
                                    <i class="fas fa-praying-hands"></i> أذكار مختارة
                                </button>
                                <button onclick="switchAdhkarHubTab('custom')" id="hub-btn-custom" class="tab-btn" style="flex:1;">
                                    <i class="fas fa-calendar-check"></i> جدولة خاصة
                                </button>
                                <button onclick="switchAdhkarHubTab('fasting')" id="hub-btn-fasting" class="tab-btn" style="flex:1;">
                                    <i class="fas fa-moon"></i> الصيام
                                </button>
                            </div>

                            <div class="card adhkar-card" id="hub-panel-instant">
                                <div class="adhkar-card-header">
                                    <h2><i class="fas fa-paper-plane"></i> أدوات النشر الفوري</h2>
                                    <div class="adhkar-muted">إرسال حديث أو ذكر أو رسالة خاصة فوراً</div>
                                </div>

                                <div id="content-panel-hadith" class="adhkar-inline-controls">
                                    <select id="hadith-book-select" class="form-control" style="flex: 2; min-width: 180px;">
                                        <%
                                            const hadithBookSetting = ['bukhari', 'muslim', 'mixed'].includes(adhkarSettings.hadith_source) ? adhkarSettings.hadith_source : 'mixed';
                                            const hadithMediaModeSetting = (adhkarSettings.hadith_media_mode || 'text');
                                            const hadithShowSourceTextSetting = (adhkarSettings.hadith_show_source_text != null ? Number(adhkarSettings.hadith_show_source_text) : 1);
                                            const hadithShowImageSourceTextSetting = (adhkarSettings.hadith_show_image_source_text != null ? Number(adhkarSettings.hadith_show_image_source_text) : 1);
                                            const hadithShowLinkSetting = (adhkarSettings.hadith_show_link != null ? Number(adhkarSettings.hadith_show_link) : 1);
                                            const hadithImageSourceSetting = (adhkarSettings.hadith_image_source || 'islamic_backgrounds');
                                            const hadithImageThemeSetting = (adhkarSettings.hadith_image_theme || 'mosques');
                                        %>
                                        <option value="mixed" <%= hadithBookSetting === 'mixed' ? 'selected' : '' %>>عشوائي (البخاري + مسلم)</option>
                                        <option value="bukhari" <%= hadithBookSetting === 'bukhari' ? 'selected' : '' %>>صحيح البخاري</option>
                                        <option value="muslim" <%= hadithBookSetting === 'muslim' ? 'selected' : '' %>>صحيح مسلم</option>
                                    </select>
                                    <button onclick="fetchRandomHadith(true)" class="btn btn-secondary" style="flex: 1; min-width: 160px;">
                                        <i class="fas fa-random"></i> حديث جديد
                                    </button>
                                    <button onclick="hadithPrev()" class="btn btn-outline" style="min-width: 90px;">
                                        السابق
                                    </button>
                                    <button onclick="hadithNext()" class="btn btn-outline" style="min-width: 90px;">
                                        التالي
                                    </button>
                                </div>

                                <div id="content-panel-selected" class="adhkar-inline-controls" style="display:none;">
                                    <select id="selected-adhkar-category" class="form-control" style="flex: 2; min-width: 180px;">
                                        <option value="general">أذكار مختارة</option>
                                        <option value="istighfar">استغفار</option>
                                        <option value="tasbeeh">تسبيح</option>
                                        <option value="hamd">حمد</option>
                                        <option value="tahleel">تهليل</option>
                                        <option value="takbeer">تكبير</option>
                                        <option value="salat">الصلاة على النبي ﷺ</option>
                                        <option value="dua">دعاء مختار</option>
                                    </select>
                                    <button onclick="fetchRandomSelectedAdhkar(true)" class="btn btn-secondary" style="flex: 1; min-width: 160px;">
                                        <i class="fas fa-random"></i> ذكر جديد
                                    </button>
                                </div>

                                <div id="hadith-media-controls" style="margin: 10px 0 12px 0; display: none;">
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                        <label style="display:flex; align-items:center; gap:8px; background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px 10px; border-radius: 12px;">
                                            <input type="radio" name="hadith_send_mode" value="text" <%= hadithMediaModeSetting !== 'image' ? 'checked' : '' %> onchange="updateHadithInstantUI()">
                                            <span>حديث فقط</span>
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px 10px; border-radius: 12px;">
                                            <input type="radio" name="hadith_send_mode" value="image" <%= hadithMediaModeSetting === 'image' ? 'checked' : '' %> onchange="updateHadithInstantUI()">
                                            <span>حديث + صورة</span>
                                        </label>
                                        <select id="hadith_image_source" class="form-control" style="min-width: 210px; padding: 8px 10px;" onchange="onHadithImageSourceChanged()">
                                            <option value="islamic_backgrounds" <%= hadithImageSourceSetting === 'islamic_backgrounds' ? 'selected' : '' %>>صور مساجد احترافية</option>
                                        </select>
                                        <select id="hadith_image_theme" class="form-control" style="min-width: 180px; padding: 8px 10px; display:none;" onchange="onHadithImageSourceChanged()">
                                            <option value="mosques" <%= hadithImageThemeSetting === 'mosques' ? 'selected' : '' %>>مساجد</option>
                                        </select>
                                        <label style="display:flex; align-items:center; gap:8px; background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px 10px; border-radius: 12px;">
                                            <input type="checkbox" id="hadith_include_source" <%= hadithShowSourceTextSetting === 1 ? 'checked' : '' %> onchange="onHadithSettingChanged()">
                                            <span>إظهار المصدر</span>
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px 10px; border-radius: 12px;">
                                            <input type="checkbox" id="hadith_include_image_source" <%= hadithShowImageSourceTextSetting === 1 ? 'checked' : '' %> onchange="onHadithSettingChanged()">
                                            <span>مصدر الصورة</span>
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px 10px; border-radius: 12px;">
                                            <input type="checkbox" id="hadith_include_more_link" <%= hadithShowLinkSetting === 1 ? 'checked' : '' %> onchange="onHadithSettingChanged()">
                                            <span>للمزيد</span>
                                        </label>
                                        <button id="hadith-change-image-btn" onclick="fetchHadithBackground()" class="btn btn-outline" style="display:none;">
                                            <i class="fas fa-image"></i> تغيير الصورة
                                        </button>
                                        <button id="hadith-save-btn" onclick="saveHadithTabNow()" class="btn btn-primary" style="padding: 8px 12px;">
                                            <i class="fas fa-save"></i> حفظ
                                        </button>
                                    </div>
                                </div>

                                <div id="selected-media-controls" style="margin: 10px 0 12px 0; display: none;">
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                        <label style="display:flex; align-items:center; gap:8px; background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px 10px; border-radius: 12px;">
                                            <input type="radio" name="selected_send_mode" value="text" checked onchange="updateSelectedInstantUI()">
                                            <span>ذكر فقط</span>
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px 10px; border-radius: 12px;">
                                            <input type="radio" name="selected_send_mode" value="image" onchange="updateSelectedInstantUI()">
                                            <span>ذكر + صورة</span>
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px 10px; border-radius: 12px;">
                                            <input type="checkbox" id="selected_include_source" checked onchange="updateSelectedInstantPreview()">
                                            <span>إظهار المصدر</span>
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; background: var(--bg-secondary); border: 1px solid var(--border); padding: 8px 10px; border-radius: 12px;">
                                            <input type="checkbox" id="selected_include_more_link" checked onchange="updateSelectedInstantPreview()">
                                            <span>للمزيد</span>
                                        </label>
                                        <button id="selected-change-image-btn" onclick="fetchSelectedBackground(true)" class="btn btn-outline" style="display:none;">
                                            <i class="fas fa-image"></i> تغيير الصورة
                                        </button>
                                    </div>
                                </div>

                                <div id="selected-inline-schedule" style="display:none; margin-top: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 14px; padding: 12px;">
                                    <%
                                        let selectedTimes = [];
                                        try { selectedTimes = JSON.parse(adhkarSettings.selected_times_json || '[]'); } catch (e) { selectedTimes = []; }
                                        if (!Array.isArray(selectedTimes)) selectedTimes = [];
                                        selectedTimes = selectedTimes.map(t => String(t || '').trim()).filter(Boolean);
                                        if (!selectedTimes.length) selectedTimes = ['12:00'];
                                        const selectedTimesCount = Math.min(5, Math.max(1, Number(adhkarSettings.selected_times_count || selectedTimes.length || 1)));
                                        while (selectedTimes.length < selectedTimesCount) selectedTimes.push(selectedTimes[selectedTimes.length - 1] || '12:00');
                                        selectedTimes = selectedTimes.slice(0, 5);
                                        const selectedEnabled = Number(adhkarSettings.selected_enabled || 0) === 1;
                                        const selectedMediaMode = (adhkarSettings.selected_media_mode || 'text');
                                        const selectedShowSource = (adhkarSettings.selected_show_source_text != null ? Number(adhkarSettings.selected_show_source_text) : 1);
                                        const selectedShowLink = (adhkarSettings.selected_show_link != null ? Number(adhkarSettings.selected_show_link) : 1);
                                    %>
                                    <div style="display:flex; align-items:center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
                                        <div>
                                            <div style="font-weight: 800;">🗓️ جدولة الأذكار المختارة</div>
                                            <div style="color: var(--text-muted); font-size: 0.85rem;">الإرسال يتم لك أنت فقط</div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="selected_schedule_enabled" <%= selectedEnabled ? 'checked' : '' %> onchange="saveSelectedScheduleInline(false)">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>

                                    <div style="margin-top: 10px; display:flex; align-items:center; gap: 10px; flex-wrap: wrap;">
                                        <span style="color: var(--text-muted);">عدد المرات:</span>
                                        <select id="selected_schedule_count" class="form-control" style="width: 170px; padding: 8px 10px;" onchange="onSelectedScheduleCountChanged()">
                                            <% for (let i = 1; i <= 5; i++) { %>
                                                <option value="<%= i %>" <%= selectedTimesCount === i ? 'selected' : '' %>><%= i %> مرة يوميًا</option>
                                            <% } %>
                                        </select>
                                    </div>

                                    <div style="margin-top: 10px; display:flex; align-items:center; gap: 10px; flex-wrap: wrap;">
                                        <span style="color: var(--text-muted);">طريقة الإرسال:</span>
                                        <select id="selected_schedule_media_mode" class="form-control" style="width: 200px; padding: 8px 10px;" onchange="saveSelectedScheduleInline(false)">
                                            <option value="text" <%= selectedMediaMode !== 'image' ? 'selected' : '' %>>نص فقط</option>
                                            <option value="image" <%= selectedMediaMode === 'image' ? 'selected' : '' %>>نص + صورة</option>
                                        </select>
                                        <label style="display:flex; align-items:center; gap:8px; background: var(--bg-card); border: 1px solid var(--border); padding: 8px 10px; border-radius: 12px;">
                                            <input type="checkbox" id="selected_schedule_show_source" <%= selectedShowSource === 1 ? 'checked' : '' %> onchange="saveSelectedScheduleInline(false)">
                                            <span>إظهار المصدر</span>
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; background: var(--bg-card); border: 1px solid var(--border); padding: 8px 10px; border-radius: 12px;">
                                            <input type="checkbox" id="selected_schedule_show_link" <%= selectedShowLink === 1 ? 'checked' : '' %> onchange="saveSelectedScheduleInline(false)">
                                            <span>للمزيد</span>
                                        </label>
                                    </div>

                                    <div id="selected_schedule_times_wrap" style="margin-top: 10px; display:flex; flex-direction: column; gap: 8px;">
                                        <% for (let i = 1; i <= 5; i++) { %>
                                            <div class="selected-schedule-time-row <%= i <= selectedTimesCount ? '' : 'hidden' %>" data-index="<%= i %>" style="display:flex; align-items:center; gap: 10px; flex-wrap: wrap;">
                                                <span style="color: var(--text-muted); width: 95px;">وقت <%= i %>:</span>
                                                <input type="time" id="selected_schedule_time_<%= i %>" class="form-control" style="width: 150px; padding: 8px 10px;" value="<%= selectedTimes[i - 1] || '12:00' %>" onchange="saveSelectedScheduleInline(false)">
                                            </div>
                                        <% } %>
                                    </div>

                                    <div style="margin-top: 12px; display:flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                                        <button onclick="saveSelectedScheduleInline(true)" class="btn btn-primary" style="min-width: 160px; padding: 9px 12px;">
                                            <i class="fas fa-save"></i> حفظ من الأسفل
                                        </button>
                                        <button onclick="testSelectedAdhkarNow()" class="btn btn-outline" style="min-width: 160px; padding: 9px 12px;">
                                            <i class="fas fa-vial"></i> اختبار الذكر
                                        </button>
                                    </div>
                                </div>

                                <div class="adhkar-preview-box">
                                    <label style="display:block; margin-bottom: 8px; color: var(--text-muted);">معاينة المحتوى:</label>
                                    <div id="preview-media-wrap" style="display:none; margin-bottom: 10px;">
                                        <img id="preview-media" alt="preview" style="width: 100%; max-height: 260px; object-fit: cover; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-main);" />
                                        <div style="margin-top: 6px; color: var(--text-muted); font-size: 0.85rem;" id="preview-media-source"></div>
                                    </div>
                                    <textarea id="preview-text" class="form-control" rows="6" readonly style="background: var(--bg-main); color: var(--text-main); font-family: 'Amiri', serif; font-size: 1.1rem; line-height: 1.8;"></textarea>

                                    <div class="adhkar-source-row">
                                        <label style="color: var(--text-muted); white-space: nowrap;">المصدر:</label>
                                        <input type="text" id="preview-source" class="form-control" readonly style="background: var(--bg-main); font-weight: bold; color: var(--primary);">
                                    </div>
                                </div>

                                <div class="adhkar-actions-row">
                                    <button onclick="sendInstantMessage()" class="btn btn-primary" style="min-width: 150px;">
                                        <i class="fab fa-whatsapp"></i> إرسال الآن
                                    </button>
                                </div>

                                <div id="hadith-inline-schedule" style="display:none; margin-top: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 14px; padding: 12px;">
                                    <%
                                        let hadithTimes = [];
                                        try { hadithTimes = JSON.parse(adhkarSettings.hadith_times_json || '[]'); } catch (e) { hadithTimes = []; }
                                        if (!Array.isArray(hadithTimes)) hadithTimes = [];
                                        hadithTimes = hadithTimes.map(t => String(t || '').trim()).filter(Boolean);
                                        if (!hadithTimes.length) hadithTimes = [adhkarSettings.hadith_time || '12:00'];
                                        const hadithTimesCount = Math.min(5, Math.max(1, Number(adhkarSettings.hadith_times_count || hadithTimes.length || 1)));
                                        while (hadithTimes.length < hadithTimesCount) hadithTimes.push(hadithTimes[hadithTimes.length - 1] || (adhkarSettings.hadith_time || '12:00'));
                                        hadithTimes = hadithTimes.slice(0, 5);
                                    %>
                                    <div style="display:flex; align-items:center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
                                        <div>
                                            <div style="font-weight: 800;">🗓️ الجدولة اليومية</div>
                                            <div style="color: var(--text-muted); font-size: 0.85rem;">الإرسال يتم حسب إعدادات الحديث بالأعلى</div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="hadith_schedule_enabled" <%= adhkarSettings.hadith_enabled ? 'checked' : '' %> onchange="saveHadithScheduleInline()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    <div style="margin-top: 10px; display:flex; align-items:center; gap: 10px; flex-wrap: wrap;">
                                        <span style="color: var(--text-muted);">عدد المرات:</span>
                                        <select id="hadith_schedule_count" class="form-control" style="width: 170px; padding: 8px 10px;" onchange="onHadithScheduleCountChanged()">
                                            <% for (let i = 1; i <= 5; i++) { %>
                                                <option value="<%= i %>" <%= hadithTimesCount === i ? 'selected' : '' %>><%= i %> مرة يوميًا</option>
                                            <% } %>
                                        </select>
                                    </div>
                                    <div id="hadith_schedule_times_wrap" style="margin-top: 10px; display:flex; flex-direction: column; gap: 8px;">
                                        <% for (let i = 1; i <= 5; i++) { %>
                                            <div class="hadith-schedule-time-row <%= i <= hadithTimesCount ? '' : 'hidden' %>" data-index="<%= i %>" style="display:flex; align-items:center; gap: 10px; flex-wrap: wrap;">
                                                <span style="color: var(--text-muted); width: 95px;">وقت <%= i %>:</span>
                                                <input type="time" id="hadith_schedule_time_<%= i %>" class="form-control" style="width: 150px; padding: 8px 10px;" value="<%= hadithTimes[i - 1] || (adhkarSettings.hadith_time || '12:00') %>" onchange="saveHadithScheduleInline()">
                                            </div>
                                        <% } %>
                                    </div>
                                </div>

                                <div id="custom-schedule-builder" style="display:none; margin-top: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 14px; padding: 12px;">
                                    <div style="display:flex; align-items:center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
                                        <div>
                                            <div style="font-weight: 800;">📅 الجدولة الخاصة</div>
                                            <div style="color: var(--text-muted); font-size: 0.85rem;">هذه الرسائل تُرسل لك أنت فقط</div>
                                        </div>
                                        <button onclick="loadCustomScheduleJobs()" class="btn btn-outline" style="padding: 8px 12px;">
                                            <i class="fas fa-sync"></i> تحديث
                                        </button>
                                    </div>

                                    <div style="margin-top: 12px; display:grid; grid-template-columns: 1fr; gap: 10px;">
                                        <input id="custom-job-id" type="hidden" value="">

                                        <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                                            <input id="custom-title" class="form-control" style="flex: 2; min-width: 220px;" placeholder="عنوان الجدولة">
                                            <select id="custom-kind" class="form-control" style="flex: 1; min-width: 180px;" onchange="onCustomKindChanged()">
                                                <option value="text">نص</option>
                                                <option value="image">صورة</option>
                                                <option value="video">فيديو</option>
                                                <option value="audio">صوت</option>
                                            </select>
                                            <label style="display:flex; align-items:center; gap:8px; background: var(--bg-card); border: 1px solid var(--border); padding: 8px 10px; border-radius: 12px;">
                                                <input type="checkbox" id="custom-enabled" checked>
                                                <span>تفعيل</span>
                                            </label>
                                        </div>

                                        <textarea id="custom-text" class="form-control" rows="4" placeholder="اكتب الرسالة..."></textarea>

                                        <div id="custom-media-controls" class="hidden" style="display:flex; gap: 10px; flex-wrap: wrap; align-items:center;">
                                            <input id="custom-media-url" class="form-control" style="flex: 2; min-width: 260px;" placeholder="رابط (اختياري) أو ارفع ملف">
                                            <input id="custom-media-file" type="file" class="form-control" style="flex: 1; min-width: 220px; padding: 8px 10px;" accept="image/*,video/*,audio/*">
                                            <button onclick="uploadCustomMediaFile()" class="btn btn-outline" style="padding: 8px 12px;">
                                                <i class="fas fa-upload"></i> رفع
                                            </button>
                                        </div>

                                        <div style="display:flex; gap: 10px; flex-wrap: wrap; align-items:center;">
                                            <select id="custom-schedule-mode" class="form-control" style="min-width: 220px;" onchange="onCustomScheduleModeChanged()">
                                                <option value="weekly">يوم من الأسبوع + وقت</option>
                                                <option value="date">تاريخ محدد + وقت</option>
                                            </select>
                                            <div id="custom-weekly-wrap" style="display:flex; gap: 10px; flex-wrap: wrap; align-items:center;">
                                                <select id="custom-weekday" class="form-control" style="min-width: 160px;">
                                                    <option value="0">الأحد</option>
                                                    <option value="1">الإثنين</option>
                                                    <option value="2">الثلاثاء</option>
                                                    <option value="3">الأربعاء</option>
                                                    <option value="4">الخميس</option>
                                                    <option value="5">الجمعة</option>
                                                    <option value="6">السبت</option>
                                                </select>
                                            </div>
                                            <div id="custom-date-wrap" class="hidden" style="display:flex; gap: 10px; flex-wrap: wrap; align-items:center;">
                                                <input id="custom-date" type="date" class="form-control" style="min-width: 200px; padding: 8px 10px;">
                                            </div>
                                            <input type="time" id="custom-time" class="form-control" style="width: 160px; padding: 8px 10px;" value="12:00">
                                        </div>

                                        <div style="display:flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                                            <button onclick="resetCustomJobForm()" class="btn btn-outline" style="padding: 8px 12px;">تفريغ</button>
                                            <button onclick="saveCustomJob()" class="btn btn-primary" style="padding: 8px 12px;">حفظ الجدولة</button>
                                        </div>
                                    </div>

                                    <div style="margin-top: 14px; border-top: 1px solid var(--border); padding-top: 12px;">
                                        <div style="font-weight: 800; margin-bottom: 10px;">📋 جدولاتي</div>
                                        <div id="custom-jobs-list" style="display:flex; flex-direction: column; gap: 10px;"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="card adhkar-card" id="hub-panel-schedule">
                                <div class="adhkar-card-header">
                                    <h2><i class="fas fa-clock"></i> الجدولة اليومية</h2>
                                    <div class="adhkar-muted" id="hub-schedule-subtitle">تفعيل/إيقاف وتعديل الوقت والرابط لكل قسم</div>
                                </div>

                                <div class="adhkar-schedule-list">
                                    <div class="adhkar-schedule-item" data-schedule-group="morning-evening">
                                        <div class="adhkar-schedule-left">
                                            <div class="adhkar-icon" style="background: rgba(255, 193, 7, 0.12); color: #FFC107;">
                                                <i class="fas fa-sun"></i>
                                            </div>
                                            <div class="adhkar-schedule-meta">
                                                <div class="adhkar-title">أذكار الصباح</div>
                                                <div class="adhkar-sub"><i class="far fa-clock"></i><span><%= formatTime12(adhkarSettings.morning_time || '07:00') %></span></div>
                                            </div>
                                        </div>
                                        <div class="adhkar-schedule-actions">
                                            <button onclick="testScheduler('adhkar', 'morning')" class="btn btn-sm btn-outline-primary" title="إرسال الآن" style="padding: 5px 10px;">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                            <button onclick="openDailyAdhkarSettingsFromButton(this)"
                                                    data-daily-key="morning"
                                                    data-daily-name="أذكار الصباح"
                                                    data-daily-time="<%= adhkarSettings.morning_time || '07:00' %>"
                                                    data-daily-enabled="<%= adhkarSettings.morning_enabled ? 1 : 0 %>"
                                                    data-daily-show-link="<%= adhkarSettings.morning_show_link != null ? adhkarSettings.morning_show_link : 1 %>"
                                                    data-daily-source="<%= adhkarSettings.morning_source || 'auto' %>"
                                                    class="btn btn-sm btn-outline" title="إعدادات" style="padding: 5px 10px;">
                                                <i class="fas fa-cog"></i>
                                            </button>
                                            <label class="toggle-switch">
                                                <input type="checkbox" onchange="updateAdhkar('morning_enabled', this.checked)" <%=adhkarSettings.morning_enabled ? 'checked' : '' %>>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="adhkar-schedule-item" data-schedule-group="morning-evening">
                                        <div class="adhkar-schedule-left">
                                            <div class="adhkar-icon" style="background: rgba(63, 81, 181, 0.12); color: #3F51B5;">
                                                <i class="fas fa-moon"></i>
                                            </div>
                                            <div class="adhkar-schedule-meta">
                                                <div class="adhkar-title">أذكار المساء</div>
                                                <div class="adhkar-sub"><i class="far fa-clock"></i><span><%= formatTime12(adhkarSettings.evening_time || '17:00') %></span></div>
                                            </div>
                                        </div>
                                        <div class="adhkar-schedule-actions">
                                            <button onclick="testScheduler('adhkar', 'evening')" class="btn btn-sm btn-outline-primary" title="إرسال الآن" style="padding: 5px 10px;">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                            <button onclick="openDailyAdhkarSettingsFromButton(this)"
                                                    data-daily-key="evening"
                                                    data-daily-name="أذكار المساء"
                                                    data-daily-time="<%= adhkarSettings.evening_time || '17:00' %>"
                                                    data-daily-enabled="<%= adhkarSettings.evening_enabled ? 1 : 0 %>"
                                                    data-daily-show-link="<%= adhkarSettings.evening_show_link != null ? adhkarSettings.evening_show_link : 1 %>"
                                                    data-daily-source="<%= adhkarSettings.evening_source || 'auto' %>"
                                                    class="btn btn-sm btn-outline" title="إعدادات" style="padding: 5px 10px;">
                                                <i class="fas fa-cog"></i>
                                            </button>
                                            <label class="toggle-switch">
                                                <input type="checkbox" onchange="updateAdhkar('evening_enabled', this.checked)" <%=adhkarSettings.evening_enabled ? 'checked' : '' %>>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="adhkar-schedule-item" data-schedule-group="selected" style="display:none;"></div>
                                </div>
                            </div>

                            <div class="card adhkar-card" id="content-schedule-card">
                                <div class="adhkar-card-header">
                                    <h2><i class="fas fa-photo-video"></i> منوعات إسلامية</h2>
                                    <div class="adhkar-muted">جدولة مستقلة للمنوعات (صور/فيديو)</div>
                                </div>

                                <div class="adhkar-schedule-item" style="margin: 0;">
                                    <div class="adhkar-schedule-left">
                                        <div class="adhkar-icon" style="background: rgba(156, 39, 176, 0.12); color: #9c27b0;">
                                            <i class="fas fa-photo-video"></i>
                                        </div>
                                        <div class="adhkar-schedule-meta">
                                            <div class="adhkar-title">منوعات إسلامية</div>
                                            <div class="adhkar-sub"><i class="far fa-clock"></i><span><%= formatTime12(adhkarSettings.content_time || '21:00') %></span></div>
                                        </div>
                                    </div>
                                    <div class="adhkar-schedule-actions">
                                        <button onclick="testScheduler('content', 'general')" class="btn btn-sm btn-outline-primary" title="إرسال الآن" style="padding: 5px 10px;">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                        <button onclick="openDailyAdhkarSettingsFromButton(this)"
                                                data-daily-key="content"
                                                data-daily-name="منوعات إسلامية"
                                                data-daily-time="<%= adhkarSettings.content_time || '21:00' %>"
                                                data-daily-enabled="<%= adhkarSettings.content_enabled ? 1 : 0 %>"
                                                data-daily-show-link="<%= adhkarSettings.content_show_link != null ? adhkarSettings.content_show_link : 1 %>"
                                                data-daily-content-type="<%= adhkarSettings.content_type || 'mixed' %>"
                                                class="btn btn-sm btn-outline" title="إعدادات" style="padding: 5px 10px;">
                                            <i class="fas fa-cog"></i>
                                        </button>
                                        <label class="toggle-switch">
                                            <input type="checkbox" onchange="updateAdhkar('content_enabled', this.checked)" <%= adhkarSettings.content_enabled ? 'checked' : '' %>>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="card adhkar-card" id="hub-panel-fasting">
                                <div class="adhkar-card-header">
                                    <h2><i class="fas fa-moon"></i> تذكيرات الصيام</h2>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <small style="color: var(--text-muted);">وقت التنبيه:</small>
                                        <input type="time" class="form-control" id="fasting_reminder_time" style="width: 110px; padding: 6px;" value="<%= fastingSettings.reminder_time || '20:00' %>">
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px;">
                                    <% const fastingTypes=[ { id: 'monday_thursday' , label: 'الإثنين والخميس' }, { id: 'white_days' , label: 'الأيام البيض' }, { id: 'ashura' , label: 'عاشوراء' }, { id: 'ramadan_alerts' , label: 'تنبيهات رمضان' } ]; %>
                                    <% fastingTypes.forEach(type=> { %>
                                        <div class="prayer-list-item" style="flex-direction: column; align-items: flex-start; gap: 10px; margin: 0;">
                                            <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
                                                <h4 style="margin: 0; font-size: 0.95rem;"><%= type.label %></h4>
                                                <div style="display:flex; gap: 8px; align-items: center;">
                                                    <button onclick="testFastingReminder('<%= type.id %>')" class="btn btn-sm btn-outline-primary" title="إرسال اختبار" style="padding: 5px 10px;">
                                                        <i class="fas fa-paper-plane"></i>
                                                    </button>
                                                    <label class="toggle-switch">
                                                        <input type="checkbox" id="fasting_<%= type.id %>" <%=(locals.fastingSettings && locals.fastingSettings[type.id]) ? 'checked' : '' %>>
                                                        <span class="toggle-slider"></span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    <% }) %>
                                </div>

                                <div style="margin-top: 14px;">
                                    <button onclick="saveAdhkarTabSettings()" class="btn btn-primary" style="width: 100%; padding: 12px 14px; font-size: 1.05rem;">
                                        <i class="fas fa-save"></i> حفظ جميع الإعدادات
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="adhkar-side" id="adhkar-side">
                            <div class="card adhkar-card" style="background: linear-gradient(rgba(var(--primary-rgb), 0.1), transparent); border-right: 4px solid var(--primary);">
                                <div class="adhkar-card-header" style="margin-bottom: 10px;">
                                    <h2 style="font-size: 1.05rem;"><i class="fas fa-quote-right" style="color: var(--primary);"></i> دعاء اليوم</h2>
                                </div>
                                <p id="daily-dua" style="font-style: italic; color: var(--text-main); line-height: 1.8; font-size: 1rem; margin-bottom: 0; font-weight: 500;">
                                    "اللهم إني أسألك علماً نافعاً، ورزقاً طيباً، وعملاً متقبلاً"
                                </p>
                            </div>
                        </div>
                    </div>
                </div> <!-- End Tab Adhkar -->

                <!-- Tab: Location & Session -->
                <div id="tab-location" class="tab-pane">
                    <!-- Session Selector -->
                    <div class="card">
                        <h2><i class="fab fa-whatsapp"></i> ربط الجلسة</h2>
                        <% if (sessions.length===0) { %>
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                لا توجد جلسات واتساب متصلة. يرجى إنشاء جلسة جديدة أولاً.
                            </div>
                            <a href="/dashboard?tab=whatsapp" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-plus"></i> إدارة الجلسات
                            </a>
                            <% } else { %>
                                <div class="form-group">
                                    <label>اختر الجلسة للإرسال عبرها:</label>
                                    <select id="sessionSelect" class="form-control" onchange="linkSession()">
                                        <option value="">-- اختر جلسة --</option>
                                        <% sessions.forEach(session=> { %>
                                            <option value="<%= session.session_id %>"
                                                <%=config.session_id===session.session_id ? 'selected' : '' %>>
                                                <%= session.name || session.phone_number || session.session_id %>
                                                    <%= session.connected ? '✅' : '⚠️' %>
                                            </option>
                                            <% }) %>
                                    </select>
                                </div>

                                <% if (config.session_id) { %>
                                    <div class="alert alert-info"
                                        style="display: flex; flex-direction: column; gap: 10px;">
                                        <div
                                            style="display: flex; justify-content: space-between; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <span><i class="fas fa-check-circle"></i> متصل</span>
                                                <button onclick="unlinkSession()" class="btn btn-outline"
                                                    style="padding: 2px 8px; font-size: 0.7rem; color: #dc3545; border-color: #dc3545;" title="إلغاء ربط الجلسة">
                                                    <i class="fas fa-unlink"></i> إلغاء
                                                </button>
                                            </div>
                                            <button onclick="sendTestNotification()" class="btn btn-outline"
                                                style="padding: 2px 10px; font-size: 0.7rem; opacity: 0.8;">
                                                اختبار الكل
                                            </button>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                            <button onclick="testIndividuals()" class="btn btn-primary"
                                                style="padding: 5px; font-size: 0.8rem; border-radius: 8px;">
                                                <i class="fas fa-user"></i> اختبار الأفراد
                                            </button>
                                            <button onclick="testGroups()" class="btn btn-primary"
                                                style="padding: 5px; font-size: 0.8rem; border-radius: 8px; background: #673ab7;">
                                                <i class="fas fa-users"></i> اختبار المجموعات
                                            </button>
                                        </div>
                                    </div>
                                    <% } %>
                                        <% } %>
                    </div>

                    <!-- Location Settings -->
                    <div class="card">
                        <h2><i class="fas fa-map-marker-alt"></i> الموقع الجغرافي</h2>
                        <div class="form-group">
                            <label>الدولة:</label>
                            <select id="country" class="form-control" onchange="updateGovernorates()">
                                <option value="">-- اختر الدولة --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>المحافظة:</label>
                            <select id="governorate" class="form-control" onchange="updateCities()" disabled>
                                <option value="">-- اختر المحافظة --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>المدينة:</label>
                            <select id="city" class="form-control" onchange="updateCoordinates()" disabled>
                                <option value="">-- اختر المدينة --</option>
                            </select>
                        </div>

                        <div
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; opacity: 0.6; margin-bottom: 15px;">
                            <div>
                                <label style="font-size: 0.8rem;">خط العرض:</label>
                                <input type="number" step="0.0001" id="latitude" class="form-control"
                                    value="<%= config.latitude || '' %>" readonly
                                    style="font-size: 0.8rem; padding: 8px;">
                            </div>
                            <div>
                                <label style="font-size: 0.8rem;">خط الطول:</label>
                                <input type="number" step="0.0001" id="longitude" class="form-control"
                                    value="<%= config.longitude || '' %>" readonly
                                    style="font-size: 0.8rem; padding: 8px;">
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveLocation()" class="btn btn-primary" style="flex: 1;">
                                <i class="fas fa-save"></i> حفظ
                            </button>
                            <button onclick="locateMe()" class="btn btn-outline" style="flex: 1;">
                                <i class="fas fa-crosshairs"></i> تلقائي
                            </button>
                        </div>
                    </div>
                </div> <!-- End Tab Location -->

                <!-- Tab: Recipients -->
                <div id="tab-recipients" class="tab-pane">

                    <!-- Recipients -->
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px;">
                            <h2 style="border: none; margin: 0; padding: 0; font-size: 1.2rem;"><i
                                    class="fas fa-users"></i> المستلمون</h2>
                            <button onclick="showAddRecipientModal()" class="btn btn-primary"
                                style="padding: 5px 10px; font-size: 0.9rem;">
                                <i class="fas fa-plus"></i> إضافة
                            </button>
                        </div>

                        <% if (recipients.length === 0) { %>
                            <p style="color: var(--text-muted); text-align: center; font-size: 0.9rem;">
                                لا يوجد مستلمون. سيتم الإرسال لرقمك الافتراضي.
                            </p>
                            <% } else { %>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    <% recipients.forEach(recipient => { %>
                                        <div class="recipient-item">
                                            <div class="recipient-info">
                                                <div class="recipient-icon">
                                                    <% if (recipient.type === 'group') { %>
                                                        <i class="fas fa-users"></i>
                                                        <% } else { %>
                                                            <i class="fas fa-user"></i>
                                                            <% } %>
                                                </div>
                                                <div>
                                                    <div style="font-weight: bold;">
                                                        <%= recipient.name %>
                                                    </div>
                                                    <div style="font-size: 0.8rem; color: var(--text-muted);">
                                                        <%= recipient.whatsapp_id %>
                                                    </div>
                                                </div>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <button onclick="testRecipient('<%= recipient.id %>')" class="btn-icon"
                                                    title="اختبار"
                                                    style="background: none; border: none; cursor: pointer; color: var(--primary); font-size: 0.9rem;">
                                                    <i class="fas fa-paper-plane"></i>
                                                </button>
                                                <label class="toggle-switch">
                                                    <input type="checkbox"
                                                        onchange="toggleRecipient('<%= recipient.id %>', this.checked)"
                                                        <%=recipient.enabled ? 'checked' : '' %>>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <button onclick="editRecipient('<%= recipient.id %>')" class="btn-icon"
                                                    title="تعديل"
                                                    style="background: none; border: none; cursor: pointer; color: var(--primary); font-size: 0.9rem;">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="deleteRecipient('<%= recipient.id %>')"
                                                    class="btn-danger"
                                                    style="background: none; border: none; cursor: pointer; color: var(--danger);">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <% }) %>
                                </div>
                                <% } %>
                    </div>
                </div> <!-- End Tab Recipients -->
            </div> <!-- End Tab Wrapper -->
        </main>
    </div>

    <!-- Add Recipient Modal -->
    <div id="addRecipientModal" aria-hidden="true"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
        <div
            style="background: var(--bg-card); padding: 30px; border-radius: var(--radius-md); width: 90%; max-width: 500px; box-shadow: var(--shadow-lg);">
            <h3 style="margin-top: 0; margin-bottom: 20px; color: var(--text-main);"><span id="modalTitle">إضافة مستلم جديد</span></h3>

            <div class="form-group">
                <label>نوع المستلم:</label>
                <select id="recipientType" class="form-control" onchange="updateRecipientInputs()">
                    <option value="individual">فرد (رقم هاتف)</option>
                    <option value="group">مجموعة</option>
                    <option value="all">الإرسال للكل</option>
                </select>
            </div>

            <!-- Individual Inputs -->
            <div id="individualInputs">
                <div class="form-group">
                    <label>الاسم:</label>
                    <input type="text" id="individualName" class="form-control" placeholder="مثال: أحمد">
                </div>
                <div class="form-group">
                    <label>رقم الهاتف:</label>
                    <input type="text" id="individualPhone" class="form-control" placeholder="201xxxxxxxxx">
                    <small style="color: var(--text-muted);">أدخل الرقم مع كود الدولة بدون +</small>
                </div>
            </div>

            <!-- Group Inputs -->
            <div id="groupInputs" style="display: none;">
                <div class="form-group">
                    <label>اختر من المجموعات:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="availableGroups" class="form-control" onchange="selectGroup()" style="flex: 1;">
                            <option value="">-- اختر مجموعة --</option>
                        </select>
                        <button type="button" onclick="fetchGroups()" class="btn btn-success" style="flex: 0 0 auto; padding: 8px 15px; display: flex; align-items: center; gap: 5px;" title="اضغط هنا لجلب المجموعات من واتساب">
                            <i class="fas fa-sync-alt"></i> <span>تحديث القائمة</span>
                        </button>
                    </div>
                    <small class="text-muted" style="display: block; margin-top: 5px;">اضغط على زر "تحديث القائمة" لإظهار مجموعات واتساب المتاحة.</small>
                </div>
                <div class="form-group">
                    <label>اسم المجموعة:</label>
                    <input type="text" id="groupName" class="form-control">
                </div>
                <div class="form-group">
                    <label>معرف المجموعة:</label>
                    <input type="text" id="groupJid" class="form-control">
                </div>
            </div>

            <!-- All Contacts -->
            <div id="allInputs" style="display: none;">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    سيتم الإرسال لجميع جهات الاتصال
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="closeAddRecipientModal()" class="btn btn-outline">إلغاء</button>
                <button onclick="saveRecipient()" class="btn btn-primary" id="btnSaveRecipient">حفظ</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Scripts -->
    <script>
        // Global Config for Client-Side Logic
        const currentMode = "<%= config.prayer_time_mode || 'auto' %>";
        const manualTimes = {
            fajr: "<%= config.manual_fajr || '05:00' %>",
            dhuhr: "<%= config.manual_dhuhr || '12:00' %>",
            asr: "<%= config.manual_asr || '15:30' %>",
            maghrib: "<%= config.manual_maghrib || '18:00' %>",
            isha: "<%= config.manual_isha || '19:30' %>"
        };

        // Tab Switching Logic
        function switchTab(tabId) {
            // Hide all panes
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            // Deactivate all buttons
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

            // Activate target
            document.getElementById(tabId).classList.add('active');
            const btn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
            if (btn) btn.classList.add('active');

            // Save preference (Optional)
            localStorage.setItem('islamic_tab', tabId);
        }

        // Sidebar & Theme Logic
        function toggleSidebar() {
            document.getElementById('adminSidebar').classList.toggle('open');
            document.getElementById('sidebar-overlay').style.display =
                document.getElementById('adminSidebar').classList.contains('open') ? 'block' : 'none';
        }

        function collapseSidebar() {
            document.getElementById('adminSidebar').classList.toggle('collapsed');
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcon(next);
        }

        function updateThemeIcon(theme) {
            document.querySelectorAll('.theme-toggle i').forEach(icon => {
                icon.classList.remove('fa-moon', 'fa-sun');
                icon.classList.add(theme === 'dark' ? 'fa-sun' : 'fa-moon');
            });
        }

        // Initialize Theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);

        // Islamic Reminders Logic
        const LOCATION_DATA = {
            "Egypt": {
                "القاهرة": {
                    "القاهرة": { lat: 30.0444, lng: 31.2357 },
                    "مدينة نصر": { lat: 30.0561, lng: 31.3301 },
                    "المعادي": { lat: 29.9593, lng: 31.2580 },
                    "مصر الجديدة": { lat: 30.0898, lng: 31.3283 },
                    "التجمع الخامس": { lat: 30.0279, lng: 31.4795 },
                    "الرحاب": { lat: 30.0601, lng: 31.4925 }
                },
                "الجيزة": {
                    "الجيزة": { lat: 30.0131, lng: 31.2089 },
                    "6 أكتوبر": { lat: 29.9722, lng: 30.9575 },
                    "الشيخ زايد": { lat: 30.0401, lng: 30.9850 },
                    "الهرم": { lat: 29.9961, lng: 31.1309 },
                    "فيصل": { lat: 30.0075, lng: 31.1444 },
                    "الدقي": { lat: 30.0392, lng: 31.2093 }
                },
                "الإسكندرية": {
                    "الإسكندرية": { lat: 31.2001, lng: 29.9187 },
                    "برج العرب": { lat: 30.8524, lng: 29.6974 },
                    "العجمي": { lat: 31.1189, lng: 29.7719 }
                },
                "القليوبية": {
                    "بنها": { lat: 30.4623, lng: 31.1786 },
                    "قليوب": { lat: 30.1782, lng: 31.2081 },
                    "شبرا الخيمة": { lat: 30.1256, lng: 31.2422 }
                },
                "الغربية": {
                    "طنطا": { lat: 30.7865, lng: 31.0004 },
                    "المحلة الكبرى": { lat: 30.9686, lng: 31.1648 }
                },
                "الدقهلية": {
                    "المنصورة": { lat: 31.0409, lng: 31.3785 },
                    "ميت غمر": { lat: 30.7169, lng: 31.2682 }
                },
                "الشرقية": {
                    "الزقازيق": { lat: 30.5877, lng: 31.5020 },
                    "العاشر من رمضان": { lat: 30.3015, lng: 31.7431 }
                },
                "المنوفية": {
                    "شبين الكوم": { lat: 30.5562, lng: 31.0088 },
                    "منوف": { lat: 30.4682, lng: 30.9329 }
                },
                "البحيرة": {
                    "دمنهور": { lat: 31.0371, lng: 30.4735 },
                    "كفر الدوار": { lat: 31.1341, lng: 30.1293 }
                },
                "كفر الشيخ": {
                    "كفر الشيخ": { lat: 31.1077, lng: 30.9422 },
                    "دسوق": { lat: 31.1332, lng: 30.6475 }
                },
                "بورسعيد": {
                    "بورسعيد": { lat: 31.2653, lng: 32.3020 },
                    "بورفؤاد": { lat: 31.2500, lng: 32.3216 }
                },
                "الإسماعيلية": {
                    "الإسماعيلية": { lat: 30.5965, lng: 32.2715 },
                    "فايد": { lat: 30.3292, lng: 32.3027 }
                },
                "السويس": { "السويس": { lat: 29.9668, lng: 32.5498 } },
                "دمياط": {
                    "دمياط": { lat: 31.4175, lng: 31.8144 },
                    "رأس البر": { lat: 31.5138, lng: 31.8159 }
                },
                "الفيوم": { "الفيوم": { lat: 29.3084, lng: 30.8428 } },
                "بني سويف": { "بني سويف": { lat: 29.0661, lng: 31.0994 } },
                "المنيا": { "المنيا": { lat: 28.1130, lng: 30.7505 } },
                "أسيوط": { "أسيوط": { lat: 27.1783, lng: 31.1859 } },
                "سوهاج": { "سوهاج": { lat: 26.5590, lng: 31.6957 } },
                "قنا": { "قنا": { lat: 26.1524, lng: 32.7212 } },
                "الأقصر": { "الأقصر": { lat: 25.6872, lng: 32.6396 } },
                "أسوان": { "أسوان": { lat: 24.0889, lng: 32.8998 } },
                "البحر الأحمر": {
                    "الغردقة": { lat: 27.2579, lng: 33.8116 },
                    "سفاجا": { lat: 26.7460, lng: 33.9350 }
                },
                "جنوب سيناء": {
                    "شرم الشيخ": { lat: 27.9158, lng: 34.3299 },
                    "دهب": { lat: 28.5096, lng: 34.5135 }
                },
                "شمال سيناء": { "العريش": { lat: 31.1321, lng: 33.8033 } },
                "مطروح": { "مرسى مطروح": { lat: 31.3543, lng: 27.2373 } },
                "الوادي الجديد": { "الخارجة": { lat: 25.4390, lng: 30.5586 } }
            },
            "Saudi Arabia": {
                "الرياض": { "الرياض": { lat: 24.7136, lng: 46.6753 } },
                "مكة المكرمة": {
                    "مكة المكرمة": { lat: 21.3891, lng: 39.8579 },
                    "جدة": { lat: 21.4858, lng: 39.1925 },
                    "الطائف": { lat: 21.2854, lng: 40.4222 }
                },
                "المدينة المنورة": { "المدينة المنورة": { lat: 24.5247, lng: 39.5692 } },
                "الشرقية": {
                    "الدمام": { lat: 26.4207, lng: 50.0888 },
                    "الخبر": { lat: 26.2172, lng: 50.1971 },
                    "الهفوف": { lat: 25.3642, lng: 49.5630 }
                }
            },
            "UAE": {
                "دبي": { "دبي": { lat: 25.2048, lng: 55.2708 } },
                "أبو ظبي": {
                    "أبو ظبي": { lat: 24.4539, lng: 54.3773 },
                    "العين": { lat: 24.1302, lng: 55.8023 }
                },
                "الشارقة": { "الشارقة": { lat: 25.3463, lng: 55.4209 } }
            },
            "Slovakia": {
                "Bratislava (العاصمة)": { "Bratislava": { lat: 48.1485, lng: 17.1077 } },
                "Košice": { "Košice": { lat: 48.7164, lng: 21.2611 } },
                "Prešov": { "Prešov": { lat: 48.9984, lng: 21.2393 } },
                "Žilina": { "Žilina": { lat: 49.2232, lng: 18.7394 } },
                "Nitra": { "Nitra": { lat: 48.3061, lng: 18.0764 } }
            }
        };

        function populateCountries() {
            const countrySelect = document.getElementById('country');
            const countries = Object.keys(LOCATION_DATA);
            countrySelect.innerHTML = '<option value="">-- اختر الدولة --</option>';
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                if (country === 'Slovakia') {
                    option.textContent = 'سلوفاكيا (خاص لك 💖)';
                    option.style.fontWeight = 'bold';
                    option.style.color = 'var(--primary)';
                } else {
                    option.textContent = country === 'Egypt' ? 'مصر' :
                        country === 'Saudi Arabia' ? 'السعودية' :
                            country === 'UAE' ? 'الإمارات' : country;
                }
                countrySelect.appendChild(option);
            });
        }

        function updateGovernorates() {
            const country = document.getElementById('country').value;
            const govSelect = document.getElementById('governorate');
            const citySelect = document.getElementById('city');
            govSelect.innerHTML = '<option value="">-- اختر المحافظة --</option>';
            citySelect.innerHTML = '<option value="">-- اختر المدينة --</option>';
            citySelect.disabled = true;

            if (country && LOCATION_DATA[country]) {
                govSelect.disabled = false;
                Object.keys(LOCATION_DATA[country]).forEach(gov => {
                    const option = document.createElement('option');
                    option.value = gov;
                    option.textContent = gov;
                    govSelect.appendChild(option);
                });
            } else {
                govSelect.disabled = true;
            }
        }

        function updateCities() {
            const country = document.getElementById('country').value;
            const gov = document.getElementById('governorate').value;
            const citySelect = document.getElementById('city');
            citySelect.innerHTML = '<option value="">-- اختر المدينة --</option>';

            if (country && gov && LOCATION_DATA[country][gov]) {
                citySelect.disabled = false;
                const cities = LOCATION_DATA[country][gov];
                Object.keys(cities).forEach(cityName => {
                    const cityData = cities[cityName];
                    const option = document.createElement('option');
                    option.value = cityName;
                    option.textContent = cityName;
                    option.dataset.lat = cityData.lat;
                    option.dataset.lng = cityData.lng;
                    citySelect.appendChild(option);
                });
            } else {
                citySelect.disabled = true;
            }
        }

        function updateCoordinates() {
            const citySelect = document.getElementById('city');
            const selectedOption = citySelect.options[citySelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.lat) {
                document.getElementById('latitude').value = selectedOption.dataset.lat;
                document.getElementById('longitude').value = selectedOption.dataset.lng;
            }
        }

        function locateMe() {
            if (navigator.geolocation) {
                const btn = document.querySelector('button[onclick="locateMe()"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;

                navigator.geolocation.getCurrentPosition(position => {
                    document.getElementById('latitude').value = position.coords.latitude.toFixed(4);
                    document.getElementById('longitude').value = position.coords.longitude.toFixed(4);
                    Swal.fire('تم بنجاح', 'تم تحديد موقعك الحالي بنجاح! يرجى حفظ الإعدادات.', 'success');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, error => {
                    console.error("Error getting location:", error);
                    Swal.fire('خطأ', 'تعذر تحديد الموقع. يرجى التأكد من تفعيل خدمة الموقع.', 'error');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            } else {
                Swal.fire('خطأ', 'المستعرض الخاص بك لا يدعم تحديد الموقع الجغرافي.', 'error');
            }
        }

        async function saveLocation() {
            const country = document.getElementById('country').value;
            const city = document.getElementById('city').value;
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            let timezone = 'Africa/Cairo';
            let calculationMethod = 'Egypt';

            if (country === 'Saudi Arabia') {
                timezone = 'Asia/Riyadh';
                calculationMethod = 'Makkah';
            } else if (country === 'UAE') {
                timezone = 'Asia/Dubai';
                calculationMethod = 'MWL';
            } else if (country === 'Slovakia') {
                timezone = 'Europe/Bratislava';
                calculationMethod = 'MWL';
            }

            const locationData = { country, city, latitude: lat, longitude: lng, timezone, prayer_calculation_method: calculationMethod };

            if (!country || !city || !lat || !lng) {
                Swal.fire('تنبيه', 'يرجى اختيار الدولة والمحافظة والمدينة', 'warning');
                return;
            }

            try {
                const res = await fetch('/api/islamic-reminders/location', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(locationData)
                });
                if (res.ok) {
                    Swal.fire({
                        title: 'تم بنجاح!',
                        text: 'تم حفظ الموقع! جاري تحديث المواقيت...',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => location.reload());
                } else {
                    Swal.fire('خطأ', 'فشل حفظ الموقع', 'error');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('خطأ', 'خطأ في الاتصال', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateCountries();
            const savedCountry = "<%= config.location_country || 'Egypt' %>";
            const savedCity = "<%= config.location_city || '' %>";

            if (savedCountry) {
                const countrySelect = document.getElementById('country');
                countrySelect.value = savedCountry;
                updateGovernorates();
                if (savedCity) {
                    const countryData = LOCATION_DATA[savedCountry];
                    if (countryData) {
                        for (const [gov, cities] of Object.entries(countryData)) {
                            if (cities[savedCity]) {
                                document.getElementById('governorate').value = gov;
                                updateCities();
                                document.getElementById('city').value = savedCity;
                                break;
                            }
                        }
                    }
                }
            }

            const sessionSelect = document.getElementById('sessionSelect');
            if (sessionSelect && sessionSelect.options.length === 2 && sessionSelect.value === "") {
                sessionSelect.value = sessionSelect.options[1].value;
                linkSession();
            }

            // Dynamic Dua Feature
            const duas = [
                "اللهم إني أسألك علماً نافعاً، ورزقاً طيباً، وعملاً متقبلاً",
                "يا مقلب القلوب ثبت قلبي على دينك",
                "اللهم إنك عفو كريم تحب العفو فاعفُ عني",
                "سبحان الله وبحمده، سبحان الله العظيم",
                "اللهم صلِ وسلم على نبينا محمد",
                "ربنا آتنا في الدنيا حسنة وفي الآخرة حسنة وقنا عذاب النار",
                "اللهم إني أعوذ بك من الهم والحزن، والعجز والكسل"
            ];
            const duaElem = document.getElementById('daily-dua');
            if (duaElem) {
                const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                duaElem.innerText = `"${duas[dayOfYear % duas.length]}"`;
            }

            // Qibla Hint Update
            const qiblaData = { 'Egypt': 135, 'Saudi Arabia': 255, 'UAE': 260, 'Slovakia': 145 };
            const currentCountry = "<%= config.location_country || '' %>";
            const qiblaDegreeElem = document.getElementById('qibla-degree');
            if (qiblaDegreeElem && currentCountry && qiblaData[currentCountry]) {
                qiblaDegreeElem.innerText = qiblaData[currentCountry];
            }
        });



        // Manual Prayer Times Functions
        async function setPrayerTimeMode(mode) {
            if (mode === 'auto') {
                const result = await Swal.fire({
                    title: 'تفعيل الوضع التلقائي؟',
                    text: "سيتم حساب أوقات الصلاة بناءً على موقعك الجغرافي.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'نعم، تفعيل',
                    cancelButtonText: 'إلغاء'
                });
                if (!result.isConfirmed) return;
            } else {
                const result = await Swal.fire({
                    title: 'تفعيل الوضع اليدوي؟',
                    text: "ستتمكن من تحديد أوقات الصلاة يدوياً.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'نعم، تفعيل',
                    cancelButtonText: 'إلغاء'
                });
                if (!result.isConfirmed) return;
            }

            try {
                const res = await fetch('/api/islamic-reminders/prayer-time-mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });

                if (res.ok) {
                    // Update visual feedback immediately (optional, but nice)
                    const modeDesc = document.getElementById('mode-desc');
                    if (modeDesc) {
                        modeDesc.textContent = mode === 'manual' ? 'إدخال يدوي مخصص' : 'تلقائي حسب الموقع الجغرافي';
                    }

                    await Swal.fire({
                        title: 'تم بنجاح!',
                        text: 'تم تغيير وضع المواقيت بنجاح',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    // Reload to reflect changes globally (e.g. settings modal options)
                    location.reload();
                } else {
                    Swal.fire('خطأ', 'فشل تغيير الوضع', 'error');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('خطأ', 'خطأ في الاتصال', 'error');
            }
        }

        async function saveManualPrayerTimes() {
            try {
                const fajr = document.getElementById('manual-fajr').value;
                const dhuhr = document.getElementById('manual-dhuhr').value;
                const asr = document.getElementById('manual-asr').value;
                const maghrib = document.getElementById('manual-maghrib').value;
                const isha = document.getElementById('manual-isha').value;

                if (!fajr || !dhuhr || !asr || !maghrib || !isha) {
                    Swal.fire('تنبيه', 'يرجى إدخال جميع المواقيت', 'warning');
                    return;
                }

                const res = await fetch('/api/islamic-reminders/manual-prayer-times', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fajr, dhuhr, asr, maghrib, isha })
                });

                const data = await res.json();

                if (res.ok) {
                    Swal.fire({
                        title: 'تم بنجاح!',
                        text: data.message,
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => location.reload());
                } else {
                    Swal.fire('خطأ', (data.error || 'فشل حفظ المواقيت'), 'error');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('خطأ', 'خطأ في الاتصال', 'error');
            }
        }

        async function linkSession() {
            const sessionId = document.getElementById('sessionSelect').value;
            if (!sessionId) return;
            try {
                const res = await fetch('/api/islamic-reminders/link-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId })
                });
                if (res.ok) { 
                    Swal.fire({
                        title: 'تم بنجاح!',
                        text: 'تم ربط الجلسة بنجاح!',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => location.reload());
                } else { 
                    Swal.fire('خطأ', 'فشل ربط الجلسة', 'error'); 
                }
            } catch (error) { console.error(error); Swal.fire('خطأ', 'خطأ في الاتصال', 'error'); }
        }

        async function unlinkSession() {
            const result = await Swal.fire({
                title: 'هل أنت متأكد؟',
                text: "سيتم إلغاء ربط الجلسة ولن يتم إرسال التذكيرات.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'نعم، إلغاء الربط',
                cancelButtonText: 'تراجع'
            });

            if (!result.isConfirmed) return;

            try {
                const res = await fetch('/api/islamic-reminders/link-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: null })
                });
                if (res.ok) {
                    Swal.fire({
                        title: 'تم!',
                        text: 'تم إلغاء الربط بنجاح',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => location.reload());
                } else {
                    Swal.fire('خطأ', 'فشل إلغاء الربط', 'error');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('خطأ', 'خطأ في الاتصال', 'error');
            }
        }

        async function togglePrayer(id, enabled) {
            await updatePrayerSetting(id, 'enabled', enabled ? 1 : 0);
        }

        async function updatePrayerSetting(id, field, value) {
            try {
                await fetch(`/api/islamic-reminders/prayer/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: value })
                });
            } catch (error) { console.error(error); }
        }

        async function updateFasting(field, value) {
            try {
                const val = (typeof value === 'boolean') ? (value ? 1 : 0) : value;
                await fetch('/api/islamic-reminders/fasting', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: val })
                });
            } catch (error) { console.error(error); Swal.fire('خطأ', 'خطأ في الاتصال', 'error'); }
        }

        async function updateAdhkar(field, value) {
            try {
                const val = (typeof value === 'boolean') ? (value ? 1 : 0) : value;
                await fetch('/api/islamic-reminders/adhkar', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: val })
                });
            } catch (error) { console.error(error); Swal.fire('خطأ', 'خطأ في الاتصال', 'error'); }
        }

        async function loadCustomScheduleJobs() {
            try {
                const res = await fetch('/api/islamic-reminders/custom-schedule-jobs');
                const jobs = await res.json();
                customJobsCache = jobs;

                const jobsContainer = document.getElementById('customJobsContainer');
                jobsContainer.innerHTML = '';

                jobs.forEach(job => {
                    const jobDiv = document.createElement('div');
                    jobDiv.className = 'job';

                    const jobTitle = document.createElement('h3');
                    jobTitle.textContent = job.title;
                    jobDiv.appendChild(jobTitle);

                    const jobSchedule = document.createElement('p');
                    jobSchedule.textContent = `Schedule: ${job.schedule}`;
                    jobDiv.appendChild(jobSchedule);

                    const jobPayload = document.createElement('p');
                    jobPayload.textContent = `Payload: ${JSON.stringify(job.payload)}`;
                    jobDiv.appendChild(jobPayload);

                    const jobEnabled = document.createElement('label');
                    jobEnabled.textContent = 'Enabled: ';
                    const jobEnabledInput = document.createElement('input');
                    jobEnabledInput.type = 'checkbox';
                    jobEnabledInput.checked = job.enabled;
                    jobEnabledInput.onchange = () => toggleCustomJobEnabled(job.id, jobEnabledInput.checked);
                    jobEnabled.appendChild(jobEnabledInput);
                    jobDiv.appendChild(jobEnabled);

                    jobsContainer.appendChild(jobDiv);
                });
            } catch (e) {
                console.error(e);
            }
        }

        async function toggleCustomJobEnabled(id, enabled) {
            const job = (customJobsCache || []).find(j => j.id === id);
            if (!job) return;
            try {
                const res = await fetch('/api/islamic-reminders/custom-schedule-jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: job.id,
                        title: job.title,
                        enabled: enabled ? 1 : 0,
                        payload: job.payload,
                        schedule: job.schedule
                    })
                });
                if (!res.ok) return;
                await loadCustomScheduleJobs();
            } catch (e) {
                console.error(e);
            }
        }

        // Function to edit a recipient
        function editRecipient(recipientId) {
            fetch(`/api/islamic-reminders/recipient/${recipientId}`)
                .then(response => response.json())
                .then(recipient => {
                    if (!recipient) {
                        Swal.fire('خطأ', 'لم يتم العثور على المستلم', 'error');
                        return;
                    }

                    // Fill the modal with recipient data
                    document.getElementById('modalTitle').textContent = 'تعديل مستلم';
                    document.getElementById('recipientType').value = recipient.type;
                    updateRecipientInputs(); // Update UI based on type

                    if (recipient.type === 'individual') {
                        document.getElementById('individualName').value = recipient.name || '';
                        document.getElementById('individualPhone').value = recipient.whatsapp_id || '';
                    } else if (recipient.type === 'group') {
                        document.getElementById('groupName').value = recipient.name || '';
                        document.getElementById('groupJid').value = recipient.whatsapp_id || '';
                    }

                    // Store the recipient ID for the save function
                    document.getElementById('addRecipientModal').dataset.recipientId = recipient.id;

                    // Change the save button to update mode
                    const saveBtn = document.getElementById('btnSaveRecipient');
                    if (saveBtn) {
                        saveBtn.textContent = 'تحديث';
                        saveBtn.setAttribute('onclick', 'saveRecipient(false, true)');
                    }

                    // Show the modal
                    const modal = document.getElementById('addRecipientModal');
                    modal.style.display = 'flex';
                    modal.setAttribute('aria-hidden', 'false');
                })
                .catch(error => {
                    console.error('Error fetching recipient:', error);
                    Swal.fire('خطأ', 'حدث خطأ أثناء جلب بيانات المستلم', 'error');
                });
        }

        // Modified saveRecipient function to handle updates
        async function saveRecipient(addMore = false, isUpdate = false) {
            let name, whatsappId, type;

            type = document.getElementById('recipientType').value;

            if (type === 'individual') {
                name = document.getElementById('individualName').value.trim();
                whatsappId = document.getElementById('individualPhone').value.trim();
            } else if (type === 'group') {
                name = document.getElementById('groupName').value.trim();
                whatsappId = document.getElementById('groupJid').value.trim();
            } else {
                name = 'الجميع';
                whatsappId = 'all';
            }

            if (!name || !whatsappId) {
                Swal.fire('خطأ', 'يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }

            // Validate phone number format for individuals
            if (type === 'individual') {
                const phoneRegex = /^(\+?\d{1,3})?\d{10,15}$/;
                if (!phoneRegex.test(whatsappId.replace(/\s/g, ''))) {
                    Swal.fire('خطأ', 'الرجاء إدخال رقم هاتف صحيح (مع أو بدون كود الدولة)', 'error');
                    return;
                }
            }

            // Validate group ID format for groups
            if (type === 'group') {
                if (!whatsappId.includes('@g.us')) {
                    Swal.fire('خطأ', 'معرف المجموعة يجب أن ينتهي بـ @g.us', 'error');
                    return;
                }
            }

            try {
                const recipientData = {
                    type: type,
                    name: name,
                    whatsapp_id: whatsappId
                };

                let url, method;
                if (isUpdate) {
                    const recipientId = document.getElementById('addRecipientModal').dataset.recipientId;
                    url = `/api/islamic-reminders/recipient/${recipientId}`;
                    method = 'PUT';
                } else {
                    url = '/api/islamic-reminders/recipient';
                    method = 'POST';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(recipientData)
                });

                const result = await response.json();

                if (response.ok) {
                    if (addMore) {
                        // Clear form for adding another recipient
                        if (type === 'individual') {
                            document.getElementById('individualName').value = '';
                            document.getElementById('individualPhone').value = '';
                        } else if (type === 'group') {
                            document.getElementById('groupName').value = '';
                            document.getElementById('groupJid').value = '';
                        }
                        Swal.fire('تم', `تم ${isUpdate ? 'تحديث' : 'إضافة'} المستلم بنجاح`, 'success');
                    } else {
                        // Close modal and refresh the page
                        closeAddRecipientModal();
                        location.reload(); // Refresh to show updated recipients list
                    }
                } else {
                    Swal.fire('خطأ', result.error || `فشل ${isUpdate ? 'تحديث' : 'إضافة'} المستلم`, 'error');
                }
            } catch (error) {
                console.error(`Error ${isUpdate ? 'updating' : 'adding'} recipient:`, error);
                Swal.fire('خطأ', 'حدث خطأ في الاتصال', 'error');
            }
        }

        // Function to close the add recipient modal and reset it to add mode
        function closeAddRecipientModal() {
            const modal = document.getElementById('addRecipientModal');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            
            // Reset to add mode
            document.getElementById('modalTitle').textContent = 'إضافة مستلم جديد';
            const saveBtn = document.getElementById('btnSaveRecipient');
            if (saveBtn) {
                saveBtn.textContent = 'حفظ';
                saveBtn.setAttribute('onclick', 'saveRecipient()');
            }
            
            // Clear the stored recipient ID
            delete document.getElementById('addRecipientModal').dataset.recipientId;
            
            // Clear form fields
            document.getElementById('individualName').value = '';
            document.getElementById('individualPhone').value = '';
            document.getElementById('groupName').value = '';
            document.getElementById('groupJid').value = '';
        }

        // Function to get all WhatsApp groups for a session
        async function fetchGroups() {
            const sessionId = document.getElementById('sessionSelect')?.value;
            if (!sessionId) {
                Swal.fire('خطأ', 'يرجى اختيار جلسة واتساب أولاً', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/whatsapp/groups/${sessionId}`);
                const data = await response.json();

                if (response.ok) {
                    const select = document.getElementById('availableGroups');
                    select.innerHTML = '<option value="">-- اختر مجموعة --</option>';
                    
                    // Fixed: data is an array
                    const groups = Array.isArray(data) ? data : (data.groups || []);
                    groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.id._serialized || group.id;
                        option.textContent = group.subject || 'بدون اسم';
                        select.appendChild(option);
                    });
                } else {
                    Swal.fire('خطأ', data.error || 'فشل جلب المجموعات', 'error');
                }
            } catch (error) {
                console.error('Error fetching groups:', error);
                Swal.fire('خطأ', 'حدث خطأ في جلب المجموعات', 'error');
            }
        }

        // Function to auto-fill group data when selected from dropdown
        function selectGroup() {
            const select = document.getElementById('availableGroups');
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption.value) {
                document.getElementById('groupJid').value = selectedOption.value;
                document.getElementById('groupName').value = selectedOption.textContent;
            }
        }

        // Function to update UI based on recipient type
        function updateRecipientInputs() {
            const type = document.getElementById('recipientType').value;
            document.getElementById('individualInputs').style.display = (type === 'individual') ? 'block' : 'none';
            document.getElementById('groupInputs').style.display = (type === 'group') ? 'block' : 'none';
            document.getElementById('allInputs').style.display = (type === 'all') ? 'block' : 'none';
        }

        // Function to toggle recipient status
        async function toggleRecipient(recipientId, enabled) {
            try {
                const response = await fetch(`/api/islamic-reminders/recipient/${recipientId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled: enabled })
                });

                if (response.ok) {
                    showToast(enabled ? 'تم تفعيل المستلم' : 'تم إلغاء تفعيل المستلم', 'success');
                } else {
                    const result = await response.json();
                    showToast(result.error || 'فشل التحديث', 'error');
                }
            } catch (error) {
                console.error('Error toggling recipient:', error);
                showToast('حدث خطأ في الاتصال', 'error');
            }
        }

        // Function to delete a recipient
        async function deleteRecipient(recipientId) {
            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: "لن تتمكن من التراجع عن هذا!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'نعم، احذفه!',
                cancelButtonText: 'إلغاء'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`/api/islamic-reminders/recipient/${recipientId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            Swal.fire('تم الحذف!', 'تم حذف المستلم بنجاح.', 'success');
                            location.reload(); // Reload to update the list
                        } else {
                            const result = await response.json();
                            Swal.fire('خطأ', result.error || 'فشل حذف المستلم', 'error');
                        }
                    } catch (error) {
                        console.error('Error deleting recipient:', error);
                        Swal.fire('خطأ', 'حدث خطأ أثناء حذف المستلم', 'error');
                    }
                }
            });
        }

        // Function to test a recipient (Updated)
        async function testRecipient(id) {
            try {
                const res = await fetch(`/api/islamic-reminders/test-recipient/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (res.ok) { 
                    Swal.fire('تم بنجاح!', 'تم إرسال الاختبار بنجاح!', 'success'); 
                } else { 
                    Swal.fire('خطأ', 'فشل الإرسال: ' + (data.error || 'خطأ غير معروف'), 'error'); 
                }
            } catch (error) { console.error(error); Swal.fire('خطأ', 'خطأ في الاتصال', 'error'); }
        }

        async function sendTestNotification() {
            const result = await Swal.fire({
                title: 'هل أنت متأكد؟',
                text: "هل تريد إرسال رسالة تجريبية لجميع المستلمين المفعلين؟",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نعم، أرسل',
                cancelButtonText: 'إلغاء'
            });
            
            if (!result.isConfirmed) return;

            try {
                const res = await fetch('/api/islamic-reminders/test-notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (res.ok) { 
                    Swal.fire('تم بنجاح!', 'تم الإرسال بنجاح!\n' + data.message, 'success'); 
                } else { 
                    Swal.fire('خطأ', 'فشل الإرسال: ' + (data.error || 'خطأ غير معروف'), 'error'); 
                }
            } catch (error) { console.error(error); Swal.fire('خطأ', 'خطأ في الاتصال', 'error'); }
        }



        document.addEventListener('DOMContentLoaded', function () {
            // Restore Tab
            const savedTab = localStorage.getItem('islamic_tab');
            if (savedTab && document.getElementById(savedTab)) {
                switchTab(savedTab);
            }

            // Mobile Header Logic
            const mainContent = document.querySelector('.admin-content');
            const header = document.querySelector('.content-header');
            let lastScrollTop = 0;
            const scrollThreshold = 10;

            if (mainContent && header) {
                mainContent.addEventListener('scroll', function () {
                    if (window.innerWidth > 1024) return;
                    let currentScroll = mainContent.scrollTop;
                    if (Math.abs(lastScrollTop - currentScroll) <= scrollThreshold) return;
                    if (currentScroll > lastScrollTop && currentScroll > 50) {
                        header.classList.add('header-hidden');
                    } else {
                        header.classList.remove('header-hidden');
                    }
                    lastScrollTop = currentScroll;
                });
            }

            // Toggle Submenu
            window.toggleSubmenu = function (id) {
                const submenu = document.getElementById(id);
                const trigger = document.querySelector(`[onclick="window.toggleSubmenu('${id}')"]`);

                if (submenu) {
                    submenu.classList.toggle('open');
                    if (trigger) {
                        trigger.classList.toggle('open');
                    }
                }
            };

            // Initialization (Location & Sessions)
            if (typeof populateCountries === 'function') populateCountries();
            const savedCountry = "<%= config.location_country || 'Egypt' %>";
            const savedCity = "<%= config.location_city || '' %>";

            if (savedCountry && typeof updateGovernorates === 'function') {
                const countrySelect = document.getElementById('country');
                if (countrySelect) countrySelect.value = savedCountry;
                updateGovernorates();
                if (savedCity) {
                    const countryData = LOCATION_DATA[savedCountry];
                    if (countryData) {
                        for (const [gov, cities] of Object.entries(countryData)) {
                            if (cities[savedCity]) {
                                const govElem = document.getElementById('governorate');
                                if (govElem) {
                                    govElem.value = gov;
                                    updateCities();
                                    const cityElem = document.getElementById('city');
                                    if (cityElem) cityElem.value = savedCity;
                                }
                                break;
                            }
                        }
                    }
                }
            }

            // Auto-link session if only one available
            const sessionSelect = document.getElementById('sessionSelect');
            if (sessionSelect && sessionSelect.options.length === 2 && sessionSelect.value === "") {
                sessionSelect.value = sessionSelect.options[1].value;
                if (typeof linkSession === 'function') linkSession();
            }

            // --- Dynamic "WOW" Features ---

            // 1. Dua of the Day
            const duas = [
                "اللهم إني أسألك علماً نافعاً، ورزقاً طيباً، وعملاً متقبلاً",
                "يا مقلب القلوب ثبت قلبي على دينك",
                "اللهم إنك عفو كريم تحب العفو فاعفُ عني",
                "سبحان الله وبحمده، سبحان الله العظيم",
                "اللهم صلِ وسلم على نبينا محمد",
                "ربنا آتنا في الدنيا حسنة وفي الآخرة حسنة وقنا عذاب النار",
                "اللهم إني أعوذ بك من الهم والحزن، والعجز والكسل"
            ];
            const duaElem = document.getElementById('daily-dua');
            if (duaElem) {
                const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                duaElem.innerText = `"${duas[dayOfYear % duas.length]}"`;
            }

            // 2. Qibla Hint Update
            const qiblaData = { 'Egypt': 135, 'Saudi Arabia': 255, 'UAE': 260, 'Slovakia': 145 };
            const currentCountry = "<%= config.location_country || '' %>";
            const qiblaDegreeElem = document.getElementById('qibla-degree');
            if (qiblaDegreeElem && currentCountry && qiblaData[currentCountry]) {
                qiblaDegreeElem.innerText = qiblaData[currentCountry];
            }
        });

        // Function to show the add recipient modal
        function showAddRecipientModal() {
            document.getElementById('modalTitle').textContent = 'إضافة مستلم جديد';
            document.getElementById('recipientType').value = 'individual';
            updateRecipientInputs(); // Update UI based on default type
            
            // Clear form fields
            document.getElementById('individualName').value = '';
            document.getElementById('individualPhone').value = '';
            document.getElementById('groupName').value = '';
            document.getElementById('groupJid').value = '';
            
            // Reset buttons to add mode
            const saveBtn = document.getElementById('btnSaveRecipient');
            if (saveBtn) {
                saveBtn.textContent = 'حفظ';
                saveBtn.setAttribute('onclick', 'saveRecipient()');
            }
            
            // Clear stored recipient ID
            delete document.getElementById('addRecipientModal').dataset.recipientId;
            
            const modal = document.getElementById('addRecipientModal');
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden', 'false');
        }
    </script>

    <!-- Prayer Settings Modal -->
    <div id="prayer-settings-modal" class="modal-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="background: var(--bg-card); padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">⚙️ إعدادات الصلاة</h3>
                <button onclick="closePrayerSettings()"
                    style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            </div>

            <input type="hidden" id="modal-prayer-id">
            <input type="hidden" id="modal-prayer-key"> <!-- e.g., 'fajr', 'isha' -->
            <p id="modal-prayer-name"
                style="margin-bottom: 20px; font-weight: bold; color: var(--primary); font-size: 1.1rem; text-align: center;">
            </p>

            <!-- Manual Time Input (Only visible in manual mode) -->
            <div id="modal-manual-time-group" class="form-group"
                style="margin-bottom: 20px; display: none; background: var(--bg-secondary); padding: 10px; border-radius: 8px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">⏰ وقت الصلاة (يدوي):</label>
                <input type="time" id="modal-manual-time" class="form-control" style="font-size: 1.1rem;">
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">🔔 تنبيه قبل الأذان بـ (دقيقة):</label>
                <input type="number" id="modal-reminder-before" class="form-control" min="0" max="60"
                    placeholder="0 = في الوقت بالضبط">
                <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                    0 = تنبيه في نفس وقت الصلاة.
                </small>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closePrayerSettings()" class="btn btn-outline"
                    style="padding: 8px 15px;">إلغاء</button>
                <button onclick="savePrayerSettings()" class="btn btn-primary" style="padding: 8px 15px;">حفظ
                    التغييرات</button>
            </div>
        </div>
    </div>

    <script>
        function openPrayerSettings(id, name, currentReminderVal) {
            const prayerNames = { 'fajr': 'الفجر', 'dhuhr': 'الظهر', 'asr': 'العصر', 'maghrib': 'المغرب', 'isha': 'العشاء' };
            const prayerKey = name.toLowerCase();

            document.getElementById('modal-prayer-id').value = id;
            document.getElementById('modal-prayer-key').value = prayerKey;
            document.getElementById('modal-prayer-name').textContent = prayerNames[prayerKey] || name;
            document.getElementById('modal-reminder-before').value = currentReminderVal;

            // Show manual time input ONLY if mode is manual
            const manualGroup = document.getElementById('modal-manual-time-group');
            if (currentMode === 'manual') {
                manualGroup.style.display = 'block';
                document.getElementById('modal-manual-time').value = manualTimes[prayerKey] || '12:00';
            } else {
                manualGroup.style.display = 'none';
            }

            const modal = document.getElementById('prayer-settings-modal');
            modal.style.display = 'flex';
        }

        function closePrayerSettings() {
            document.getElementById('prayer-settings-modal').style.display = 'none';
        }

        async function savePrayerSettings() {
            const id = document.getElementById('modal-prayer-id').value;
            const prayerKey = document.getElementById('modal-prayer-key').value;
            const reminderBefore = document.getElementById('modal-reminder-before').value;
            const manualTime = document.getElementById('modal-manual-time').value;

            try {
                // 1. Save Reminder Value (Always)
                const p1 = fetch('/api/islamic-reminders/prayer-setting', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: id,
                        settings: { reminder_before_minutes: parseInt(reminderBefore) || 0 }
                    })
                });

                // 2. Save Manual Time (Only if manual mode)
                let p2 = Promise.resolve();
                if (currentMode === 'manual') {
                    const payload = {};
                    payload[prayerKey] = manualTime; // e.g. { fajr: "05:00" } or { isha: "19:30" }

                    p2 = fetch('/api/islamic-reminders/manual-prayer-times', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                await Promise.all([p1, p2]);
                closePrayerSettings();
                window.location.reload();

            } catch (error) {
                console.error('Save Settings Error:', error);
                Swal.fire('خطأ', 'حدث خطأ في الاتصال', 'error');
            }
        }

        async function testIndividuals() {
            const result = await Swal.fire({
                title: 'هل أنت متأكد؟',
                text: "هل تريد إرسال رسالة تجريبية لجميع الأفراد المفعلين؟",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نعم، أرسل',
                cancelButtonText: 'إلغاء'
            });
            if (!result.isConfirmed) return;

            try {
                const res = await fetch('/api/islamic-reminders/test-individuals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (res.ok) { 
                    Swal.fire('تم بنجاح!', data.message, 'success'); 
                } else { 
                    Swal.fire('خطأ', 'فشل الإرسال: ' + (data.error || 'خطأ غير معروف'), 'error'); 
                }
            } catch (error) { console.error(error); Swal.fire('خطأ', 'خطأ في الاتصال', 'error'); }
        }

        async function testGroups() {
            const result = await Swal.fire({
                title: 'هل أنت متأكد؟',
                text: "هل تريد إرسال رسالة تجريبية لجميع المجموعات المفعلة؟",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نعم، أرسل',
                cancelButtonText: 'إلغاء'
            });
            if (!result.isConfirmed) return;

            try {
                const res = await fetch('/api/islamic-reminders/test-groups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (res.ok) { 
                    Swal.fire('تم بنجاح!', data.message, 'success'); 
                } else { 
                    Swal.fire('خطأ', 'فشل الإرسال: ' + (data.error || 'خطأ غير معروف'), 'error'); 
                }
            } catch (error) { console.error(error); Swal.fire('خطأ', 'خطأ في الاتصال', 'error'); }
        }

        async function setExperienceMode(mode) {
            const btnManual = document.getElementById('btn-mode-manual');
            const btnAuto = document.getElementById('btn-mode-auto');
            const mediaContainer = document.getElementById('media-pref-container');
            // Visual Feedback First
            if (mode === 'manual') {
                btnManual.classList.remove('mode-btn-inactive');
                btnManual.classList.add('mode-btn-active');
                btnAuto.classList.remove('mode-btn-active');
                btnAuto.classList.add('mode-btn-inactive');
                // Use class for hiding
                mediaContainer.classList.add('hidden');
                // Set Logic: Manual Source (Reading Mode)
                await updateAdhkar('morning_source', 'manual');
                await updateAdhkar('evening_source', 'manual');
                await updateAdhkar('hadith_source', 'manual');
            } else {
                btnManual.classList.remove('mode-btn-active');
                btnManual.classList.add('mode-btn-inactive');
                btnAuto.classList.remove('mode-btn-inactive');
                btnAuto.classList.add('mode-btn-active');
                // Use class for showing
                mediaContainer.classList.remove('hidden');
                // Set Logic: Auto Source (Visual Mode)
                await updateAdhkar('morning_source', 'auto');
                await updateAdhkar('evening_source', 'auto');
                await updateAdhkar('hadith_source', 'auto');
            }
        }

        // --- NEW: Instant Tools Logic ---
        let currentContentTab = 'hadith';
        let currentAdhkarHubTab = 'morning-evening';
        let hadithHistory = [];
        let hadithHistoryIndex = -1;
        let hadithBaseText = '';
        let hadithBaseSource = '';
        let hadithBackgroundUrl = '';
        let hadithBackgroundSource = '';
        let selectedBaseText = '';
        let selectedBaseSource = '';
        let selectedBaseSourceUrl = '';
        let selectedBackgroundUrl = '';
        let selectedBackgroundSource = '';

        function switchAdhkarHubTab(tab) {
            currentAdhkarHubTab = tab;

            const tabs = ['morning-evening', 'hadith', 'selected', 'custom', 'fasting'];
            tabs.forEach(t => {
                const btn = document.getElementById(`hub-btn-${t}`);
                if (btn) {
                    if (t === tab) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            });

            const instantPanel = document.getElementById('hub-panel-instant');
            const schedulePanel = document.getElementById('hub-panel-schedule');
            const fastingPanel = document.getElementById('hub-panel-fasting');
            const hadithMediaControls = document.getElementById('hadith-media-controls');
            const hadithInlineSchedule = document.getElementById('hadith-inline-schedule');
            const selectedMediaControls = document.getElementById('selected-media-controls');
            const selectedInlineSchedule = document.getElementById('selected-inline-schedule');
            const customScheduleBuilder = document.getElementById('custom-schedule-builder');
            const hadithPanel = document.getElementById('content-panel-hadith');
            const selectedPanel = document.getElementById('content-panel-selected');

            const showInstant = (tab === 'hadith' || tab === 'selected' || tab === 'custom');
            const showSchedule = (tab === 'morning-evening' || tab === 'selected');
            const showFasting = (tab === 'fasting');

            if (instantPanel) instantPanel.style.display = showInstant ? 'block' : 'none';
            if (schedulePanel) schedulePanel.style.display = showSchedule ? 'block' : 'none';
            if (fastingPanel) fastingPanel.style.display = showFasting ? 'block' : 'none';
            if (hadithMediaControls) hadithMediaControls.style.display = (tab === 'hadith') ? 'block' : 'none';
            if (hadithInlineSchedule) hadithInlineSchedule.style.display = (tab === 'hadith') ? 'block' : 'none';
            if (selectedMediaControls) selectedMediaControls.style.display = (tab === 'selected') ? 'block' : 'none';
            if (hadithPanel) hadithPanel.style.display = (tab === 'hadith') ? 'flex' : 'none';
            if (selectedPanel) selectedPanel.style.display = (tab === 'selected') ? 'flex' : 'none';
            if (selectedInlineSchedule) selectedInlineSchedule.style.display = (tab === 'selected') ? 'block' : 'none';
            if (customScheduleBuilder) customScheduleBuilder.style.display = (tab === 'custom') ? 'block' : 'none';

            const scheduleItems = document.querySelectorAll('[data-schedule-group]');
            scheduleItems.forEach(el => {
                const group = el.getAttribute('data-schedule-group');
                el.style.display = (showSchedule && group === tab) ? '' : 'none';
            });

            const scheduleSubtitle = document.getElementById('hub-schedule-subtitle');
            if (scheduleSubtitle) {
                scheduleSubtitle.textContent = (tab === 'hadith')
                    ? 'جدولة حديث اليوم فقط'
                    : 'تفعيل/إيقاف وتعديل الوقت والرابط لكل قسم';
            }

            if (tab === 'hadith') {
                switchContentTab('hadith');
                updateHadithInstantUI();
                persistHadithSettingsFromUI();
            } else if (tab === 'selected') {
                switchContentTab('adhkar-preview');
                updateSelectedInstantUI();
                if (!selectedBaseText) fetchRandomSelectedAdhkar(false);
            } else if (tab === 'custom') {
                switchContentTab('custom');
                loadCustomScheduleJobs();
                resetCustomJobForm();
            }

            localStorage.setItem('adhkar_hub_tab', tab);
        }

        function switchContentTab(tab) {
            currentContentTab = tab;

            // Visual Tab State
            const tabs = ['hadith', 'adhkar-preview', 'custom'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-btn-${t}`);
                if (btn) {
                    if (t === tab) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            });

            // Panel Visibility (Simplified: just hiding headers/controls specific to type if needed)
            const hadithPanel = document.getElementById('content-panel-hadith');
            if (hadithPanel) {
                hadithPanel.style.display = (tab === 'hadith') ? 'block' : 'none';
            }
            const selectedPanel = document.getElementById('content-panel-selected');
            if (selectedPanel) {
                selectedPanel.style.display = (currentAdhkarHubTab === 'selected') ? 'block' : 'none';
            }

            // Clear/Setup Preview
            const previewText = document.getElementById('preview-text');
            const previewSource = document.getElementById('preview-source');

            if (tab === 'custom') {
                previewText.readOnly = false;
                previewText.value = '';
                previewText.placeholder = 'أكتب رسالتك هنا...';
                previewSource.readOnly = false;
                previewSource.value = '';
                previewSource.placeholder = 'المصدر (اختياري)';
            } else if (tab === 'adhkar-preview') {
                previewText.readOnly = true;
                previewSource.readOnly = true;
                if (currentAdhkarHubTab === 'selected') {
                    updateSelectedInstantPreview();
                } else {
                    previewText.value = 'سيتم اختيار ذكر عشوائي عند الإرسال...';
                    previewSource.value = 'تلقائي';
                }
            } else {
                previewText.readOnly = true;
                previewText.placeholder = 'انتظر تحميل الحديث...';
                previewSource.readOnly = true;
                previewSource.value = '';
                if (previewText.value === '') fetchRandomHadith(false); // Auto-fetch on switch back
            }
        }

        function getSelectedSendMode() {
            const selected = document.querySelector('input[name="selected_send_mode"]:checked');
            return selected ? selected.value : 'text';
        }

        function generateSelectedMoreLink() {
            return selectedBaseSourceUrl ? String(selectedBaseSourceUrl) : '';
        }

        function updateSelectedInstantUI() {
            if (currentAdhkarHubTab !== 'selected') return;
            const mode = getSelectedSendMode();
            const wrap = document.getElementById('preview-media-wrap');
            const changeBtn = document.getElementById('selected-change-image-btn');
            if (wrap) wrap.style.display = (mode === 'image') ? 'block' : 'none';
            if (changeBtn) changeBtn.style.display = (mode === 'image') ? 'inline-flex' : 'none';
            updateSelectedInstantPreview();
            if (mode === 'image' && !selectedBackgroundUrl) fetchSelectedBackground(false);
        }

        function updateSelectedInstantPreview() {
            if (currentAdhkarHubTab !== 'selected') return;
            const previewText = document.getElementById('preview-text');
            const previewSource = document.getElementById('preview-source');
            const includeSource = document.getElementById('selected_include_source') ? document.getElementById('selected_include_source').checked : true;
            const includeMore = document.getElementById('selected_include_more_link') ? document.getElementById('selected_include_more_link').checked : true;

            const text = selectedBaseText || '';
            const source = selectedBaseSource || '';
            let composedText = text;
            if (includeMore) {
                const link = generateSelectedMoreLink();
                if (link) composedText = `${composedText}\n\n🔗 للمزيد: ${link}`;
            }
            if (previewText) previewText.value = composedText;
            if (previewSource) previewSource.value = includeSource ? source : '';
        }

        async function fetchSelectedBackground(forceNew = false) {
            try {
                const t = forceNew ? `?t=${Date.now()}` : '';
                const res = await fetch(`/api/adhkar/background${t}`);
                const data = await res.json();
                if (!res.ok) return;

                selectedBackgroundUrl = data.url || '';
                selectedBackgroundSource = data.source || '';

                const img = document.getElementById('preview-media');
                const src = document.getElementById('preview-media-source');
                if (img) img.src = selectedBackgroundUrl;
                if (src) src.textContent = selectedBackgroundSource ? `مصدر الصورة: ${selectedBackgroundSource}` : '';
            } catch (e) {
                console.error(e);
            }
        }

        async function fetchRandomSelectedAdhkar(forceNew = true) {
            const category = document.getElementById('selected-adhkar-category')?.value || 'general';
            const previewText = document.getElementById('preview-text');
            const previewSource = document.getElementById('preview-source');
            if (previewText) previewText.value = 'جاري التحميل...';
            if (previewSource) previewSource.value = '';

            try {
                const res = await fetch(`/api/adhkar/random?category=${encodeURIComponent(category)}`);
                const data = await res.json();
                if (!res.ok) return;

                selectedBaseText = data.text || '';
                selectedBaseSource = data.source || '';
                selectedBaseSourceUrl = data.source_url || '';

                updateSelectedInstantPreview();

                if (getSelectedSendMode() === 'image') {
                    if (forceNew) {
                        selectedBackgroundUrl = '';
                        selectedBackgroundSource = '';
                    }
                    if (!selectedBackgroundUrl || forceNew) {
                        await fetchSelectedBackground(forceNew);
                    }
                }
            } catch (e) {
                console.error(e);
                if (previewText) previewText.value = 'خطأ في الاتصال';
            }
        }

        async function fetchRandomHadith(forceNew = true) {
            const book = document.getElementById('hadith-book-select').value;
            const previewText = document.getElementById('preview-text');
            const previewSource = document.getElementById('preview-source');

            previewText.value = 'جاري التحميل...';

            try {
                const res = await fetch(`/api/hadith/random?book=${book}`);
                const data = await res.json();

                if (res.ok) {
                    persistHadithSettingsFromUI();
                    hadithBaseText = data.text || data.content_ar || '';
                    hadithBaseSource = [data.source, data.grade].filter(Boolean).join(' - ');

                    if (forceNew || hadithHistoryIndex === -1 || hadithHistoryIndex === hadithHistory.length - 1) {
                        hadithHistory.push({ text: hadithBaseText, source: hadithBaseSource });
                        hadithHistoryIndex = hadithHistory.length - 1;
                    } else if (hadithHistory[hadithHistoryIndex]) {
                        hadithHistory[hadithHistoryIndex] = { text: hadithBaseText, source: hadithBaseSource };
                    }

                    updateHadithInstantPreview();
                    if (getHadithSendMode() === 'image' && !hadithBackgroundUrl) {
                        await fetchHadithBackground();
                    }
                } else {
                    previewText.value = 'فشل تحميل الحديث. حاول مرة أخرى.';
                }
            } catch (e) {
                console.error(e);
                previewText.value = 'خطأ في الاتصال';
            }
        }

        function hadithPrev() {
            if (currentAdhkarHubTab !== 'hadith') return;
            if (hadithHistoryIndex <= 0) return;
            hadithHistoryIndex -= 1;
            const item = hadithHistory[hadithHistoryIndex];
            if (item) {
                hadithBaseText = item.text;
                hadithBaseSource = item.source;
                updateHadithInstantPreview();
            }
        }

        function hadithNext() {
            if (currentAdhkarHubTab !== 'hadith') return;
            if (hadithHistoryIndex < hadithHistory.length - 1) {
                hadithHistoryIndex += 1;
                const item = hadithHistory[hadithHistoryIndex];
                if (item) {
                    hadithBaseText = item.text;
                    hadithBaseSource = item.source;
                    updateHadithInstantPreview();
                }
                return;
            }
            fetchRandomHadith(true);
        }

        function getHadithSendMode() {
            const selected = document.querySelector('input[name="hadith_send_mode"]:checked');
            return selected ? selected.value : 'text';
        }

        function generateHadithMoreLink(text) {
            const coreText = String(text || '').includes('قال رسول الله ﷺ:') ? String(text).split('قال رسول الله ﷺ:')[1] : String(text || '');
            const snippet = coreText.substring(0, 100).replace(/[^\u0621-\u064A\s]/g, '').trim();
            if (!snippet) return '';
            return `https://dorar.net/hadith/search?q=${encodeURIComponent(snippet)}`;
        }

        function updateHadithInstantUI() {
            const mode = getHadithSendMode();
            const wrap = document.getElementById('preview-media-wrap');
            const changeBtn = document.getElementById('hadith-change-image-btn');
            const sourceSel = document.getElementById('hadith_image_source');
            const themeSel = document.getElementById('hadith_image_theme');
            if (wrap) wrap.style.display = (currentAdhkarHubTab === 'hadith' && mode === 'image') ? 'block' : 'none';
            if (changeBtn) changeBtn.style.display = (currentAdhkarHubTab === 'hadith' && mode === 'image') ? 'inline-flex' : 'none';
            if (themeSel) {
                const showTheme = (currentAdhkarHubTab === 'hadith' && mode === 'image' && (sourceSel?.value || 'islamic_backgrounds') === 'islamic_backgrounds');
                themeSel.style.display = showTheme ? 'inline-block' : 'none';
            }
            updateHadithInstantPreview();
            persistHadithSettingsFromUI();
        }

        let hadithSettingsSaveTimer = null;

        async function saveHadithSettings(payload) {
            try {
                await fetch('/api/islamic-reminders/adhkar', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } catch (error) {
                console.error(error);
                Swal.fire('خطأ', 'خطأ في الاتصال', 'error');
            }
        }

        function scheduleHadithSettingsSave(payload) {
            if (hadithSettingsSaveTimer) clearTimeout(hadithSettingsSaveTimer);
            hadithSettingsSaveTimer = setTimeout(() => saveHadithSettings(payload), 250);
        }

        function persistHadithSettingsFromUI() {
            if (currentAdhkarHubTab !== 'hadith') return;
            const book = document.getElementById('hadith-book-select')?.value || 'mixed';
            const mode = getHadithSendMode();
            const includeSource = document.getElementById('hadith_include_source')?.checked ? 1 : 0;
            const includeImageSource = document.getElementById('hadith_include_image_source')?.checked ? 1 : 0;
            const includeMore = document.getElementById('hadith_include_more_link')?.checked ? 1 : 0;
            const imageSource = document.getElementById('hadith_image_source')?.value || 'islamic_backgrounds';
            const imageTheme = document.getElementById('hadith_image_theme')?.value || 'mosques';

            scheduleHadithSettingsSave({
                hadith_source: book,
                hadith_media_mode: mode,
                hadith_show_source_text: includeSource,
                hadith_show_image_source_text: includeImageSource,
                hadith_show_link: includeMore,
                hadith_image_source: imageSource,
                hadith_image_theme: imageTheme
            });
        }

        function onHadithSettingChanged() {
            updateHadithInstantPreview();
            persistHadithSettingsFromUI();
        }

        async function saveHadithTabNow() {
            try {
                if (currentAdhkarHubTab !== 'hadith') return;
                persistHadithSettingsFromUI();
                await saveHadithScheduleInline();
                Swal.fire({ title: 'تم الحفظ', icon: 'success', timer: 900, showConfirmButton: false });
            } catch (e) {
                console.error(e);
                Swal.fire('خطأ', 'تعذر الحفظ', 'error');
            }
        }

        async function saveSelectedScheduleInline(showToast = false) {
            try {
                if (currentAdhkarHubTab !== 'selected') return;
                const enabled = document.getElementById('selected_schedule_enabled')?.checked ? 1 : 0;
                const countRaw = Number(document.getElementById('selected_schedule_count')?.value || 1);
                const count = Math.min(5, Math.max(1, Number.isFinite(countRaw) ? countRaw : 1));
                const mediaMode = document.getElementById('selected_schedule_media_mode')?.value || 'text';
                const showSource = document.getElementById('selected_schedule_show_source')?.checked ? 1 : 0;
                const showLink = document.getElementById('selected_schedule_show_link')?.checked ? 1 : 0;
                const category = document.getElementById('selected-adhkar-category')?.value || 'general';

                const times = [];
                for (let i = 1; i <= count; i++) {
                    const el = document.getElementById(`selected_schedule_time_${i}`);
                    const v = String(el?.value || '').trim();
                    times.push(v || '');
                }

                const normalized = times.map(t => String(t).trim()).filter(Boolean);
                if (normalized.length !== count) return;
                const uniq = new Set(normalized);
                if (uniq.size !== normalized.length) return;

                await fetch('/api/islamic-reminders/adhkar', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        selected_enabled: enabled,
                        selected_category: category,
                        selected_media_mode: mediaMode,
                        selected_show_source_text: showSource,
                        selected_show_link: showLink,
                        selected_times_count: count,
                        selected_times_json: JSON.stringify(normalized)
                    })
                });

                if (showToast) {
                    Swal.fire({ title: 'تم الحفظ', icon: 'success', timer: 900, showConfirmButton: false });
                }
            } catch (e) {
                console.error(e);
                if (showToast) Swal.fire('خطأ', 'تعذر الحفظ', 'error');
            }
        }

        function onSelectedScheduleCountChanged() {
            const countRaw = Number(document.getElementById('selected_schedule_count')?.value || 1);
            const count = Math.min(5, Math.max(1, Number.isFinite(countRaw) ? countRaw : 1));
            document.querySelectorAll('.selected-schedule-time-row').forEach(row => {
                const idx = Number(row.getAttribute('data-index') || 0);
                row.classList.toggle('hidden', !(idx && idx <= count));
            });
            saveSelectedScheduleInline(false);
        }

        async function testSelectedAdhkarNow() {
            try {
                if (currentAdhkarHubTab !== 'selected') return;
                const mode = document.getElementById('selected_schedule_media_mode')?.value || getSelectedSendMode();
                if (mode === 'image' && !selectedBackgroundUrl) {
                    await fetchSelectedBackground(false);
                }

                const text = document.getElementById('preview-text')?.value || '';
                const mediaUrl = (mode === 'image') ? (selectedBackgroundUrl || '') : '';

                const res = await fetch('/api/islamic-reminders/test-self', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text,
                        mediaUrl: mediaUrl || undefined,
                        mediaType: mediaUrl ? 'image' : undefined
                    })
                });
                const contentType = res.headers.get('content-type') || '';
                if (!contentType.includes('application/json')) {
                    Swal.fire('خطأ', 'الاختبار غير متاح حالياً. أعد تشغيل السيرفر ثم جرّب مرة أخرى.', 'error');
                    return;
                }
                const data = await res.json();
                if (res.ok) {
                    Swal.fire('تم بنجاح', 'تم إرسال الاختبار لنفسك', 'success');
                } else {
                    Swal.fire('خطأ', data.error || 'فشل الإرسال', 'error');
                }
            } catch (e) {
                console.error(e);
                Swal.fire('خطأ', 'خطأ في الاتصال', 'error');
            }
        }

        async function testFastingReminder(type) {
            try {
                const res = await fetch('/api/islamic-reminders/test-fasting', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type })
                });
                const data = await res.json();
                if (res.ok) {
                    Swal.fire('تم بنجاح', 'تم إرسال اختبار الصيام لنفسك', 'success');
                } else {
                    Swal.fire('خطأ', data.error || 'فشل الإرسال', 'error');
                }
            } catch (e) {
                console.error(e);
                Swal.fire('خطأ', 'خطأ في الاتصال', 'error');
            }
        }

        async function saveHadithScheduleInline() {
            try {
                const enabled = document.getElementById('hadith_schedule_enabled')?.checked ? 1 : 0;
                const countRaw = Number(document.getElementById('hadith_schedule_count')?.value || 1);
                const count = Math.min(5, Math.max(1, Number.isFinite(countRaw) ? countRaw : 1));

                const addMinutes = (t, minutesToAdd) => {
                    const parts = String(t || '').split(':');
                    const h = parseInt(parts[0], 10);
                    const m = parseInt(parts[1], 10);
                    if (!Number.isFinite(h) || !Number.isFinite(m)) return '12:00';
                    const total = (h * 60 + m + minutesToAdd) % (24 * 60);
                    const hh = String(Math.floor(total / 60)).padStart(2, '0');
                    const mm = String(total % 60).padStart(2, '0');
                    return `${hh}:${mm}`;
                };

                const times = [];
                for (let i = 1; i <= count; i++) {
                    const el = document.getElementById(`hadith_schedule_time_${i}`);
                    const v = String(el?.value || '').trim();
                    times.push(v || '');
                }

                for (let i = 0; i < times.length; i++) {
                    if (times[i]) continue;
                    const prev = times[i - 1] || times[0] || '12:00';
                    times[i] = addMinutes(prev, 180);
                    const el = document.getElementById(`hadith_schedule_time_${i + 1}`);
                    if (el) el.value = times[i];
                }

                const normalized = times.map(t => String(t).trim()).filter(Boolean);
                if (normalized.length !== count) {
                    Swal.fire('خطأ', 'يرجى اختيار وقت صحيح لكل مرة', 'error');
                    return;
                }
                const uniq = new Set(normalized);
                if (uniq.size !== normalized.length) {
                    Swal.fire('خطأ', 'لا يمكن تكرار نفس الوقت أكثر من مرة', 'error');
                    return;
                }

                await saveHadithSettings({
                    hadith_enabled: enabled,
                    hadith_times_count: count,
                    hadith_times_json: JSON.stringify(normalized),
                    hadith_time: normalized[0]
                });
            } catch (e) {
                console.error(e);
            }
        }

        function onHadithScheduleCountChanged() {
            const countRaw = Number(document.getElementById('hadith_schedule_count')?.value || 1);
            const count = Math.min(5, Math.max(1, Number.isFinite(countRaw) ? countRaw : 1));
            document.querySelectorAll('.hadith-schedule-time-row').forEach(row => {
                const idx = Number(row.getAttribute('data-index') || 0);
                row.style.display = (idx && idx <= count) ? 'flex' : 'none';
            });
            saveHadithScheduleInline();
        }

        let customJobsCache = [];

        function onCustomKindChanged() {
            const kind = document.getElementById('custom-kind')?.value || 'text';
            const controls = document.getElementById('custom-media-controls');
            if (controls) controls.classList.toggle('hidden', kind === 'text');
        }

        function onCustomScheduleModeChanged() {
            const mode = document.getElementById('custom-schedule-mode')?.value || 'weekly';
            const weeklyWrap = document.getElementById('custom-weekly-wrap');
            const dateWrap = document.getElementById('custom-date-wrap');
            if (weeklyWrap) weeklyWrap.classList.toggle('hidden', mode !== 'weekly');
            if (dateWrap) dateWrap.classList.toggle('hidden', mode !== 'date');
        }

        function resetCustomJobForm() {
            const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v; };
            setVal('custom-job-id', '');
            setVal('custom-title', '');
            setVal('custom-text', '');
            setVal('custom-media-url', '');
            setVal('custom-kind', 'text');
            setVal('custom-schedule-mode', 'weekly');
            setVal('custom-weekday', '0');
            setVal('custom-date', '');
            setVal('custom-time', '12:00');
            const enabled = document.getElementById('custom-enabled');
            if (enabled) enabled.checked = true;
            const file = document.getElementById('custom-media-file');
            if (file) file.value = '';
            onCustomKindChanged();
            onCustomScheduleModeChanged();
        }

        function collectCustomJobFromForm() {
            const id = document.getElementById('custom-job-id')?.value || undefined;
            const title = document.getElementById('custom-title')?.value || '';
            const enabled = document.getElementById('custom-enabled')?.checked ? 1 : 0;
            const text = document.getElementById('custom-text')?.value || '';
            const mediaUrl = document.getElementById('custom-media-url')?.value || '';
            const kind = document.getElementById('custom-kind')?.value || 'text';
            const scheduleMode = document.getElementById('custom-schedule-mode')?.value || 'weekly';
            const time = document.getElementById('custom-time')?.value || '';
            const weekday = Number(document.getElementById('custom-weekday')?.value || 0);
            const date = document.getElementById('custom-date')?.value || '';

            const payload = {
                text: text,
                mediaType: (kind === 'text') ? '' : kind,
                mediaUrl: (kind === 'text') ? '' : mediaUrl
            };

            const schedule = {};
            if (scheduleMode === 'date') {
                schedule.type = 'date';
                schedule.date = date;
                schedule.time = time;
            } else {
                schedule.type = 'weekly';
                schedule.day = weekday;
                schedule.time = time;
            }

            return { id, title, enabled, payload, schedule };
        }

        async function uploadCustomMediaFile() {
            try {
                const input = document.getElementById('custom-media-file');
                const file = input?.files?.[0];
                if (!file) {
                    Swal.fire('تنبيه', 'اختر ملف أولاً', 'warning');
                    return;
                }
                const fd = new FormData();
                fd.append('file', file);
                const res = await fetch('/api/islamic-reminders/upload-custom-media', { method: 'POST', body: fd });
                const data = await res.json();
                if (!res.ok) {
                    Swal.fire('خطأ', data.error || 'فشل الرفع', 'error');
                    return;
                }
                const url = document.getElementById('custom-media-url');
                if (url) url.value = data.url || '';
                const kind = document.getElementById('custom-kind');
                if (kind && data.mediaType) kind.value = data.mediaType;
                onCustomKindChanged();
                Swal.fire({ title: 'تم الرفع', icon: 'success', timer: 900, showConfirmButton: false });
            } catch (e) {
                console.error(e);
                Swal.fire('خطأ', 'خطأ في الاتصال', 'error');
            }
        }

        async function saveCustomJob() {
            const job = collectCustomJobFromForm();

            const hasText = String(job.payload.text || '').trim().length > 0;
            const hasMedia = String(job.payload.mediaUrl || '').trim().length > 0 && ['image', 'video', 'audio'].includes(String(job.payload.mediaType || ''));
            if (!hasText && !hasMedia) {
                Swal.fire('تنبيه', 'اكتب نص أو أضف رابط وسائط', 'warning');
                return;
            }
            if (!job.schedule.time) {
                Swal.fire('تنبيه', 'اختر وقت', 'warning');
                return;
            }

            if (job.schedule.type === 'date') {
                const d = String(job.schedule.date || '');
                if (!d) {
                    Swal.fire('تنبيه', 'اختر تاريخ', 'warning');
                    return;
                }
                const re = /^\d{4}-\d{2}-\d{2}$/;
                if (!re.test(d)) {
                    Swal.fire('تنبيه', 'صيغة التاريخ يجب أن تكون YYYY-MM-DD', 'warning');
                    return;
                }
            }

            if (job.payload.mediaType) {
                const u = String(job.payload.mediaUrl || '').trim();
                if (!u) {
                    Swal.fire('تنبيه', 'أضف رابط أو ارفع ملف', 'warning');
                    return;
                }
                if (!(u.startsWith('http') || u.startsWith('/uploads/'))) {
                    Swal.fire('تنبيه', 'الرابط يجب أن يبدأ بـ http/https', 'warning');
                    return;
                }
            }

            try {
                const res = await fetch('/api/islamic-reminders/custom-schedule-jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(job)
                });
                const data = await res.json();
                if (!res.ok) {
                    Swal.fire('خطأ', data.error || 'فشل حفظ الجدولة', 'error');
                    return;
                }
                const idEl = document.getElementById('custom-job-id');
                if (idEl) idEl.value = data.id;
                Swal.fire({ title: 'تم الحفظ', text: 'تم حفظ الجدولة الخاصة', icon: 'success', timer: 1200, showConfirmButton: false });
                await loadCustomScheduleJobs();
            } catch (e) {
                console.error(e);
                Swal.fire('خطأ', 'خطأ في الاتصال', 'error');
            }
        }

        async function deleteCustomJob(id) {
            const result = await Swal.fire({
                title: 'حذف الجدولة؟',
                text: 'سيتم حذف هذه الجدولة نهائياً',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء'
            });
            if (!result.isConfirmed) return;

            try {
                const res = await fetch(`/api/islamic-reminders/custom-schedule-jobs/${encodeURIComponent(id)}`, { method: 'DELETE' });
                const data = await res.json();
                if (!res.ok) {
                    Swal.fire('خطأ', data.error || 'فشل الحذف', 'error');
                    return;
                }
                Swal.fire({ title: 'تم الحذف', icon: 'success', timer: 900, showConfirmButton: false });
                await loadCustomScheduleJobs();
                resetCustomJobForm();
            } catch (e) {
                console.error(e);
                Swal.fire('خطأ', 'خطأ في الاتصال', 'error');
            }
        }

        function editCustomJob(id) {
            const job = (customJobsCache || []).find(j => j.id === id);
            if (!job) return;
            const setVal = (id2, v) => { const el = document.getElementById(id2); if (el) el.value = v; };
            const setChecked = (id2, v) => { const el = document.getElementById(id2); if (el) el.checked = !!v; };
            setVal('custom-job-id', job.id);
            setVal('custom-title', job.title || '');
            setChecked('custom-enabled', Number(job.enabled) !== 0);
            setVal('custom-text', job.payload?.text || '');
            setVal('custom-media-url', job.payload?.mediaUrl || '');
            setVal('custom-kind', job.payload?.mediaType || 'text');

            const st = String(job.schedule?.type || 'weekly');
            const mode = (st === 'date' || st === 'dates') ? 'date' : 'weekly';
            setVal('custom-schedule-mode', mode);
            setVal('custom-time', job.schedule?.time || (Array.isArray(job.schedule?.times) ? (job.schedule.times[0] || '') : '') || '12:00');
            setVal('custom-weekday', (job.schedule?.day !== undefined ? String(job.schedule.day) : (Array.isArray(job.schedule?.days) ? String(job.schedule.days[0] || 0) : '0')));
            setVal('custom-date', job.schedule?.date || (Array.isArray(job.schedule?.dates) ? (job.schedule.dates[0] || '') : ''));

            const file = document.getElementById('custom-media-file');
            if (file) file.value = '';
            onCustomKindChanged();
            onCustomScheduleModeChanged();
        }

        function summarizeCustomSchedule(schedule) {
            const type = String(schedule?.type || 'weekly');
            const t = schedule?.time || (Array.isArray(schedule?.times) ? schedule.times[0] : '');
            if (type === 'date' || type === 'dates') {
                const d = schedule?.date || (Array.isArray(schedule?.dates) ? schedule.dates[0] : '');
                return `${d || 'تاريخ'} - ${t || 'وقت'}`;
            }
            const day = (schedule?.day !== undefined && schedule?.day !== null) ? Number(schedule.day)
                : (Array.isArray(schedule?.days) ? Number(schedule.days[0]) : null);
            const dayNames = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            const dayLabel = (day !== null && day >= 0 && day <= 6) ? dayNames[day] : 'أسبوعي';
            return `${dayLabel} - ${t || 'وقت'}`;
        }

        async function loadCustomScheduleJobs() {
            try {
                const list = document.getElementById('custom-jobs-list');
                if (!list) return;
                list.innerHTML = '<div style="color: var(--text-muted);">جاري التحميل...</div>';
                const res = await fetch('/api/islamic-reminders/custom-schedule-jobs');
                const data = await res.json();
                if (!res.ok) {
                    list.innerHTML = `<div style="color: var(--danger);">فشل التحميل</div>`;
                    return;
                }
                customJobsCache = Array.isArray(data.jobs) ? data.jobs : [];
                if (!customJobsCache.length) {
                    list.innerHTML = '<div style="color: var(--text-muted);">لا توجد جدولّات بعد</div>';
                    return;
                }
                list.innerHTML = customJobsCache.map(j => {
                    const title = j.title ? String(j.title) : 'جدولة بدون عنوان';
                    const enabled = Number(j.enabled) !== 0;
                    const summary = summarizeCustomSchedule(j.schedule);
                    const hasMedia = j.payload?.mediaType && j.payload?.mediaUrl;
                    const badge = hasMedia ? `(${j.payload.mediaType})` : '(نص)';
                    const idJson = JSON.stringify(String(j.id));
                    return `
                        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 10px; display:flex; gap: 10px; align-items: center; justify-content: space-between; flex-wrap: wrap;">
                            <div style="min-width: 220px;">
                                <div style="font-weight: 800;">${title} <span style="color: var(--text-muted); font-weight: 600;">${badge}</span></div>
                                <div style="color: var(--text-muted); font-size: 0.85rem;">${summary}</div>
                            </div>
                            <div style="display:flex; gap: 8px; align-items:center; flex-wrap: wrap; justify-content: flex-end;">
                                <label style="display:flex; align-items:center; gap:8px; background: var(--bg-secondary); border: 1px solid var(--border); padding: 6px 10px; border-radius: 12px;">
                                    <input type="checkbox" ${enabled ? 'checked' : ''} onchange="toggleCustomJobEnabled(${idJson}, this.checked)">
                                    <span>مفعل</span>
                                </label>
                                <button class="btn btn-outline" style="padding: 7px 10px;" onclick="editCustomJob(${idJson})">تعديل</button>
                                <button class="btn btn-outline" style="padding: 7px 10px;" onclick="deleteCustomJob(${idJson})">حذف</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error(e);
            }
        }

        async function toggleCustomJobEnabled(id, enabled) {
            const job = (customJobsCache || []).find(j => j.id === id);
            if (!job) return;
            try {
                const res = await fetch('/api/islamic-reminders/custom-schedule-jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: job.id,
                        title: job.title,
                        enabled: enabled ? 1 : 0,
                        payload: job.payload,
                        schedule: job.schedule
                    })
                });
                if (!res.ok) return;
                await loadCustomScheduleJobs();
            } catch (e) {
                console.error(e);
            }
        }

        function updateHadithInstantPreview() {
            if (currentAdhkarHubTab !== 'hadith') return;
            const previewText = document.getElementById('preview-text');
            const previewSource = document.getElementById('preview-source');
            const includeSource = document.getElementById('hadith_include_source') ? document.getElementById('hadith_include_source').checked : true;
            const includeImageSource = document.getElementById('hadith_include_image_source') ? document.getElementById('hadith_include_image_source').checked : true;
            const includeMore = document.getElementById('hadith_include_more_link') ? document.getElementById('hadith_include_more_link').checked : true;
            const sendMode = getHadithSendMode();

            const text = hadithBaseText || '';
            const source = hadithBaseSource || '';

            let composedText = text;
            if (sendMode === 'image' && includeImageSource) {
                const imgSource = document.getElementById('hadith_image_source')?.value || 'islamic_backgrounds';
                composedText = imgSource === 'islamic_backgrounds'
                    ? `${composedText}\n\n🖼️ مصدر الصورة: صور مساجد احترافية`
                    : composedText;
            }
            if (includeMore) {
                const link = generateHadithMoreLink(text);
                if (link) composedText = `${composedText}\n\n🔗 للمزيد: ${link}`;
            }

            if (previewText) previewText.value = composedText;
            if (previewSource) previewSource.value = includeSource ? source : '';
        }

        async function fetchHadithBackground() {
            try {
                const source = document.getElementById('hadith_image_source')?.value || 'islamic_backgrounds';
                const theme = document.getElementById('hadith_image_theme')?.value || 'mixed';
                const res = await fetch(`/api/hadith/background?source=${encodeURIComponent(source)}&theme=${encodeURIComponent(theme)}`);
                const data = await res.json();
                if (!res.ok) return;

                hadithBackgroundUrl = data.url || '';
                hadithBackgroundSource = data.source || '';

                const img = document.getElementById('preview-media');
                const src = document.getElementById('preview-media-source');
                if (img) img.src = hadithBackgroundUrl;
                if (src) {
                    const license = data?.attribution?.license ? ` - ${String(data.attribution.license).replace(/<[^>]+>/g, '').trim()}` : '';
                    src.textContent = hadithBackgroundSource ? `مصدر الصورة: ${hadithBackgroundSource}${license}` : '';
                }
            } catch (e) {
                console.error(e);
            }
        }

        function onHadithImageSourceChanged() {
            hadithBackgroundUrl = '';
            hadithBackgroundSource = '';
            const themeSel = document.getElementById('hadith_image_theme');
            const sourceSel = document.getElementById('hadith_image_source');
            if (themeSel) themeSel.style.display = ((sourceSel?.value || 'islamic_backgrounds') === 'islamic_backgrounds' && getHadithSendMode() === 'image') ? 'inline-block' : 'none';
            const img = document.getElementById('preview-media');
            const src = document.getElementById('preview-media-source');
            if (img) img.src = '';
            if (src) src.textContent = '';
            if (getHadithSendMode() === 'image') fetchHadithBackground();
            updateHadithInstantPreview();
        }

        async function sendInstantMessage() {
            const previewText = document.getElementById('preview-text').value;
            const previewSource = document.getElementById('preview-source').value;

            if (!previewText || previewText === 'جاري التحميل...') {
                Swal.fire('تنبيه', 'الرجاء تجهيز محتوى للإرسال أولاً', 'warning');
                return;
            }

            const result = await Swal.fire({
                title: 'هل أنت متأكد؟',
                text: "هل تريد إرسال هذا المحتوى الآن لجميع المستلمين؟",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نعم، أرسل',
                cancelButtonText: 'إلغاء'
            });

            if (!result.isConfirmed) return;

            try {
                const sendMode = (currentAdhkarHubTab === 'hadith') ? getHadithSendMode()
                    : (currentAdhkarHubTab === 'selected') ? getSelectedSendMode()
                    : 'text';

                if (currentAdhkarHubTab === 'hadith' && sendMode === 'image' && !hadithBackgroundUrl) {
                    await fetchHadithBackground();
                }
                if (currentAdhkarHubTab === 'selected' && sendMode === 'image' && !selectedBackgroundUrl) {
                    await fetchSelectedBackground(false);
                }

                const res = await fetch('/api/islamic-reminders/test-notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        forceContent: previewText,
                        forceSource: previewSource,
                        forceMediaUrl: (sendMode === 'image' && currentAdhkarHubTab === 'hadith') ? hadithBackgroundUrl
                            : (sendMode === 'image' && currentAdhkarHubTab === 'selected') ? selectedBackgroundUrl
                            : undefined,
                        forceMediaType: (sendMode === 'image' && (currentAdhkarHubTab === 'hadith' || currentAdhkarHubTab === 'selected')) ? 'image' : undefined
                    })
                });

                const data = await res.json();
                if (res.ok) {
                    Swal.fire('تم بنجاح', 'تم الإرسال بنجاح!', 'success');
                } else {
                    Swal.fire('خطأ', 'فشل الإرسال: ' + (data.error || 'خطأ غير معروف'), 'error');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('خطأ', 'خطأ في الاتصال', 'error');
            }
        }

        // Initialize default tab
        document.addEventListener('DOMContentLoaded', () => {
            const savedHub = localStorage.getItem('adhkar_hub_tab');
            switchAdhkarHubTab(savedHub || 'morning-evening');
        });

        // Switch between Adhkar sub-tabs
        function switchAdhkarSubTab(tab) {
            // Update tab buttons
            const tabs = ['morning', 'evening', 'hadith', 'quran', 'variety'];
            tabs.forEach(t => {
                const btn = document.getElementById(`adhkar-subtab-${t}`);
                const panel = document.getElementById(`adhkar-panel-${t}`);

                if (btn) {
                    if (t === tab) {
                        btn.classList.add('active');
                        if (panel) panel.style.display = 'block';
                    } else {
                        btn.classList.remove('active');
                        if (panel) panel.style.display = 'none';
                    }
                }
            });
        }

        async function saveAdhkarTabSettings() {
            try {
                // 1. Gather Adhkar Data
                const expModeElem = document.getElementById('experience_mode_input');
                const expMode = expModeElem ? expModeElem.value : 'auto';
                
                const mediaPrefElem = document.querySelector('input[name="media_pref"]:checked');
                const mediaPref = mediaPrefElem ? mediaPrefElem.value : 'mixed';

                const textLengthElem = document.querySelector('input[name="text_length"]:checked');
                const textLength = textLengthElem ? textLengthElem.value : 'full';

                const adhkarPayload = {
                    morning_source: expMode,
                    evening_source: expMode,
                    hadith_source: expMode,
                    media_preference: mediaPref,
                    text_length: textLength
                };

                // 2. Gather Fasting Data
                const fastingPayload = {
                    reminder_time: document.getElementById('fasting_reminder_time') ? document.getElementById('fasting_reminder_time').value : '20:00',
                    monday_thursday: document.getElementById('fasting_monday_thursday') ? document.getElementById('fasting_monday_thursday').checked : false,
                    white_days: document.getElementById('fasting_white_days') ? document.getElementById('fasting_white_days').checked : false,
                    ashura: document.getElementById('fasting_ashura') ? document.getElementById('fasting_ashura').checked : false,
                    ramadan_alerts: document.getElementById('fasting_ramadan_alerts') ? document.getElementById('fasting_ramadan_alerts').checked : false
                };

                if (fastingPayload.monday_thursday !== undefined) {
                    fastingPayload.monday = fastingPayload.monday_thursday;
                    fastingPayload.thursday = fastingPayload.monday_thursday;
                }

                // 3. Send Requests
                const p1 = fetch('/api/islamic-reminders/adhkar', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(adhkarPayload)
                });

                const p2 = fetch('/api/islamic-reminders/fasting', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(fastingPayload)
                });

                await Promise.all([p1, p2]);

                Swal.fire({
                    title: 'تم بنجاح!',
                    text: 'تم حفظ جميع الإعدادات بنجاح!',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Save Adhkar Tab Error:', error);
                Swal.fire('خطأ', 'حدث خطأ أثناء الحفظ', 'error');
            }
        }

        // --- New Smart Card Functions ---

        // 1. Quick Settings Update (Directly from Card)
        async function updateReminderDirectly(id, minutes) {
            try {
                // Optimistic UI Update
                const card = document.getElementById(`card-${id}`);
                if (card) {
                    const buttons = card.querySelectorAll('.pill-btn');
                    buttons.forEach(btn => {
                        // Check if button text matches the minutes (handling 'لا يوجد')
                        const btnText = btn.innerText;
                        const isMatch = (minutes === 0 && btnText.includes('لا يوجد')) || 
                                      (minutes !== 0 && btnText.includes(`${minutes}`));
                        
                        if (isMatch) btn.classList.add('active');
                        else btn.classList.remove('active');
                    });
                }

                const response = await fetch('/api/islamic-reminders/prayer-setting', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: id,
                        settings: { reminder_before_minutes: parseInt(minutes) }
                    })
                });
                
                if (response.ok) {
                    showToast(`تم تحديث وقت التنبيه بنجاح`, 'success');
                } else {
                    showToast('فشل حفظ الإعدادات', 'error');
                    // Revert UI if needed (omitted for brevity)
                }
            } catch (e) {
                console.error(e);
                showToast('حدث خطأ في الاتصال', 'error');
            }
        }

        async function testPrayerTimeActual(prayerName, prayerNameAr) {
            Swal.fire({
                title: 'جاري إرسال اختبار الصلاة...',
                text: `يتم إرسال رسالة تذكير صلاة ${prayerNameAr} الآن...`,
                icon: 'info',
                showConfirmButton: false,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const res = await fetch('/api/islamic-reminders/test-prayer-time', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prayerName, prayerNameAr })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    Swal.fire('تم بنجاح', `تم إرسال تذكير صلاة ${prayerNameAr} بنجاح`, 'success');
                } else {
                    Swal.fire('خطأ', data.error || 'فشل الإرسال', 'error');
                }
            } catch (e) {
                console.error(e);
                Swal.fire('خطأ', 'خطأ في الاتصال', 'error');
            }
        }

        // 2. Adhan Simulation (Deprecated - Kept for reference or alternative use)
        function testAdhanSimulation(prayerName) {
            showToast(`🔊 جاري محاكاة أذان ${prayerName}...`, 'info');
            
            // Visual Pulse Effect on the card
            const cards = document.querySelectorAll('.prayer-card');
            cards.forEach(c => {
                if (c.innerText.includes(prayerName)) {
                    c.style.animation = 'pulse-border 2s infinite';
                    setTimeout(() => {
                        c.style.animation = '';
                    }, 5000);
                }
            });

            // Simulate Audio (Browser beep or placeholder)
            // In a real app, new Audio('/path/to/adhan.mp3').play();
            setTimeout(() => {
                showToast(`الله أكبر... الله أكبر (تجربة صوتية)`, 'success');
            }, 1000);
        }

        // 3. Real-time Prayer Timers (Elapsed / Remaining)
        function startPrayerTimers() {
            setInterval(() => {
                const counters = document.querySelectorAll('.time-elapsed-counter');
                const now = new Date();
                
                counters.forEach(counter => {
                    const timeStr = counter.getAttribute('data-prayer-time');
                    if (!timeStr) return;
                    
                    const [hours, minutes] = timeStr.split(':');
                    const prayerDate = new Date();
                    prayerDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                    
                    let diff = now - prayerDate;
                    
                    // Logic: If prayer is more than 12 hours away/ago, adjust day to find nearest instance
                    // Actually, let's keep it simple: Compare to TODAY'S prayer time.
                    
                    if (diff >= 0) {
                        // Prayer passed today
                        const diffSecs = Math.floor(diff / 1000);
                        const h = Math.floor(diffSecs / 3600);
                        const m = Math.floor((diffSecs % 3600) / 60);
                        const s = diffSecs % 60;
                        counter.innerHTML = `<i class="fas fa-history"></i> مضى: ${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                        counter.style.color = 'var(--text-muted)';
                    } else {
                        // Prayer is upcoming today
                        const diffSecs = Math.abs(Math.floor(diff / 1000));
                        const h = Math.floor(diffSecs / 3600);
                        const m = Math.floor((diffSecs % 3600) / 60);
                        const s = diffSecs % 60;
                        counter.innerHTML = `<i class="fas fa-hourglass-half"></i> متبقي: ${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                        counter.style.color = 'var(--primary)';
                    }
                });
            }, 1000);
        }

        // Start timers on load
        document.addEventListener('DOMContentLoaded', startPrayerTimers);

    </script>
    <!-- Test Prayer Modal -->
    <div id="testPrayerModal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
        <div style="background: var(--bg-card); padding: 30px; border-radius: var(--radius-md); width: 90%; max-width: 400px; box-shadow: var(--shadow-lg); text-align: center; border: 1px solid var(--border);">
            <div style="margin-bottom: 20px;">
                <i class="fas fa-stopwatch" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
                <h3 id="testModalTitle" style="margin: 0; color: var(--text-main);">اختبار التذكير</h3>
                <p style="color: var(--text-muted); margin-top: 5px;">ضبط مؤقت للاختبار</p>
            </div>

            <input type="hidden" id="testPrayerName">

            <div class="timer-display" id="timerDisplay">00:00</div>

            <div class="timer-controls">
                <button class="timer-btn" onclick="adjustTimer(-10)" title="-10 ثواني"><i class="fas fa-minus"></i></button>
                <button class="timer-btn" onclick="adjustTimer(10)" title="+10 ثواني"><i class="fas fa-plus"></i></button>
                <button class="timer-btn" onclick="adjustTimer(60)" title="+1 دقيقة">1d</button>
            </div>

            <div class="form-group" style="margin-bottom: 15px; text-align: right;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-main);">إرسال إلى:</label>
                <div style="display: flex; gap: 15px; justify-content: center; background: var(--bg-main); padding: 10px; border-radius: var(--radius-sm);">
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; color: var(--text-main);">
                        <input type="radio" name="testTarget" value="all" checked> الجميع
                    </label>
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; color: var(--text-main);">
                        <input type="radio" name="testTarget" value="individuals"> الأفراد
                    </label>
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; color: var(--text-main);">
                        <input type="radio" name="testTarget" value="groups"> المجموعات
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label style="text-align: right;">رسالة مخصصة (اختياري):</label>
                <input type="text" id="testCustomMessage" class="form-control" placeholder="اكتب رسالة للتجربة...">
            </div>

            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button onclick="closeTestModal()" class="btn btn-outline" style="flex: 1;">إلغاء</button>
                <button onclick="startTestTimer()" class="btn btn-primary" style="flex: 1;" id="startTestBtn">
                    <i class="fas fa-play"></i> بدء الاختبار
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <style>
        /* Toast CSS */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--bg-card);
            color: var(--text-main);
            padding: 12px 20px;
            border-radius: var(--radius-md);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 280px;
            max-width: 400px;
            border-right: 4px solid var(--primary);
            animation: slideIn 0.3s ease-out;
            font-weight: 500;
        }

        .toast.success { border-right-color: #4caf50; }
        .toast.error { border-right-color: #f44336; }
        .toast.info { border-right-color: var(--primary); }

        .toast i { font-size: 1.2rem; }
        .toast.success i { color: #4caf50; }
        .toast.error i { color: #f44336; }
        .toast.info i { color: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { transform: translateX(-100%); opacity: 0; }
        }

        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary);
            margin: 20px 0;
            font-family: monospace;
            transition: all 0.3s ease;
        }

        .timer-display.running {
            color: #e74c3c;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .timer-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
        }
    </style>

    <script>
        // Toast Function
        function showToast(message, type = 'info') {
            const Toast = Swal.mixin({
                toast: true,
                position: 'bottom-start',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });

            Toast.fire({
                icon: type,
                title: message
            });
        }

        let currentTestMode = 'athkar'; // 'athkar' or 'prayer_time'
        let testTimerInterval;
        let testTimeSeconds = 10;

        function openTestModal(prayerName, mode = 'athkar') {
            currentTestMode = mode;
            document.getElementById('testPrayerName').value = prayerName;
            
            const titleEl = document.getElementById('testModalTitle');
            const messageInput = document.getElementById('testCustomMessage');
            
            if (mode === 'athkar') {
                titleEl.innerText = `اختبار أذكار ${prayerName}`;
                // Random Athkar Suggestions
                const athkars = [
                    "سبحان الله وبحمده، سبحان الله العظيم",
                    "أستغفر الله العظيم وأتوب إليه",
                    "لا إله إلا الله وحده لا شريك له",
                    "اللهم صل وسلم على نبينا محمد"
                ];
                const randomAthkar = athkars[Math.floor(Math.random() * athkars.length)];
                messageInput.value = randomAthkar;
                messageInput.placeholder = "نص الأذكار المقترح...";
                messageInput.closest('.form-group').style.display = 'block';
            } else if (mode === 'prayer_time') {
                titleEl.innerText = `اختبار وقت صلاة ${prayerName}`;
                messageInput.value = "";
                messageInput.placeholder = "هذا الاختبار سيرسل رسالة وقت الصلاة الفعلي";
                // Hide custom message input for prayer time test as it uses fixed template
                messageInput.closest('.form-group').style.display = 'none';
            } else {
                titleEl.innerText = `اختبار تذكير ${prayerName}`;
                messageInput.value = "";
                messageInput.placeholder = "رسالة إضافية اختيارية...";
                messageInput.closest('.form-group').style.display = 'block';
            }

            document.getElementById('testPrayerModal').style.display = 'flex';
            testTimeSeconds = 10; // Reset
            updateTimerDisplay();
            
            // Reset UI state
            document.getElementById('timerDisplay').classList.remove('running');
            const startBtn = document.getElementById('startTestBtn');
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-play"></i> بدء الاختبار';
            
            // Clear any existing interval
            if (testTimerInterval) clearInterval(testTimerInterval);
        }

        function closeTestModal() {
            document.getElementById('testPrayerModal').style.display = 'none';
            if (testTimerInterval) clearInterval(testTimerInterval);
        }

        function adjustTimer(seconds) {
            testTimeSeconds += seconds;
            if (testTimeSeconds < 0) testTimeSeconds = 0;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(testTimeSeconds / 60);
            const seconds = testTimeSeconds % 60;
            document.getElementById('timerDisplay').innerText = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function startTestTimer() {
            const timerDisplay = document.getElementById('timerDisplay');
            const startBtn = document.getElementById('startTestBtn');
            
            if (testTimeSeconds <= 0) {
                sendTestWithTimer();
                return;
            }

            // Visual effects
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-hourglass-half fa-spin"></i> جاري العد...';
            timerDisplay.classList.add('running');

            testTimerInterval = setInterval(() => {
                testTimeSeconds--;
                updateTimerDisplay();

                if (testTimeSeconds <= 0) {
                    clearInterval(testTimerInterval);
                    timerDisplay.classList.remove('running');
                    sendTestWithTimer();
                }
            }, 1000);
        }

        async function sendTestWithTimer() {
            const prayerName = document.getElementById('testPrayerName').value;
            const customMessage = document.getElementById('testCustomMessage').value;
            const sessionId = document.getElementById('sessionSelect')?.value || document.getElementById('config-session-id')?.value;
            const targetType = document.querySelector('input[name="testTarget"]:checked')?.value || 'all';

            if (!sessionId) {
                showToast('❌ لا توجد جلسة واتساب مختارة أو متصلة', 'error');
                closeTestModal();
                return;
            }

            try {
                closeTestModal();
                showToast('🚀 جاري إرسال الاختبار...', 'info');

                let endpoint = '/api/islamic-reminders/test-notification';
                let body = { 
                    prayerName, 
                    sessionId, 
                    customMessage,
                    targetType,
                    isTest: true 
                };

                if (currentTestMode === 'prayer_time') {
                    endpoint = '/api/islamic-reminders/test-prayer-time';
                    // Map prayer name to arabic for display if needed, though backend handles logic
                    const prayerNamesAr = {
                        'fajr': 'الفجر',
                        'dhuhr': 'الظهر',
                        'asr': 'العصر',
                        'maghrib': 'المغرب',
                        'isha': 'العشاء'
                    };
                    body = {
                        prayerName: prayerName,
                        prayerNameAr: prayerNamesAr[prayerName] || prayerName,
                        sessionId,
                        targetType
                    };
                }

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await res.json();
                
                if (res.ok && data.success) {
                    showToast('✅ ' + data.message, 'success');
                } else {
                    showToast('❌ فشل إرسال الاختبار: ' + (data.message || 'خطأ غير معروف'), 'error');
                }
            } catch (error) {
                console.error(error);
                showToast('❌ حدث خطأ أثناء الإرسال', 'error');
            }
        }
        async function testScheduler(type, category) {
            Swal.fire({
                title: 'جاري الإرسال...',
                text: 'يتم تحضير وإرسال المحتوى...',
                icon: 'info',
                showConfirmButton: false,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const res = await fetch('/api/islamic-reminders/test-scheduler', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, category })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    Swal.fire('تم بنجاح', 'تم إرسال رسالة الاختبار بنجاح.\nتحقق من هاتفك.', 'success');
                } else {
                    Swal.fire('خطأ', data.error || 'فشل الإرسال', 'error');
                }
            } catch (e) {
                console.error(e);
                Swal.fire('خطأ', 'خطأ في الاتصال', 'error');
            }
        }
    </script>

    <!-- Post-Prayer Adhkar Settings Modal -->
    <div id="post-prayer-adhkar-settings-modal" class="modal-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="background: var(--bg-card); padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">⚙️ إعدادات أذكار دبر الصلاة</h3>
                <button onclick="closePostPrayerAdhkarSettings()"
                    style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            </div>

            <input type="hidden" id="modal-pp-prayer-id">
            <p id="modal-pp-prayer-name"
                style="margin-bottom: 20px; font-weight: bold; color: var(--primary); font-size: 1.1rem; text-align: center;">
            </p>

            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">⏳ وقت الإرسال بعد الصلاة (دقيقة):</label>
                <input type="number" id="modal-pp-delay" class="form-control" min="0" max="60"
                    placeholder="5">
                <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                    المدة الزمنية للانتظار بعد موعد الصلاة قبل إرسال الأذكار.
                </small>
            </div>

            <div class="form-group" style="margin-bottom: 20px; background: var(--bg-secondary); padding: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 2px;">🔗 إرفاق رابط المصدر</label>
                    <small style="color: var(--text-muted);">إظهار رابط "للمزيد" مع الأذكار</small>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="modal-pp-show-link">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closePostPrayerAdhkarSettings()" class="btn btn-outline"
                    style="padding: 8px 15px;">إلغاء</button>
                <button onclick="savePostPrayerAdhkarSettings()" class="btn btn-primary" style="padding: 8px 15px;">حفظ
                    التغييرات</button>
            </div>
        </div>
    </div>

    <script>
        function openPostPrayerAdhkarSettings(id, name, currentDelay, currentShowLink) {
            const prayerNames = { 'fajr': 'الفجر', 'dhuhr': 'الظهر', 'asr': 'العصر', 'maghrib': 'المغرب', 'isha': 'العشاء' };
            const prayerKey = name.toLowerCase();

            document.getElementById('modal-pp-prayer-id').value = id;
            document.getElementById('modal-pp-prayer-name').textContent = prayerNames[prayerKey] || name;
            document.getElementById('modal-pp-delay').value = currentDelay || 5;
            // Convert to boolean. existing data might be undefined, treat as true (1) default
            const isChecked = (currentShowLink === '1' || currentShowLink === 1 || currentShowLink === 'true');
            document.getElementById('modal-pp-show-link').checked = isChecked;

            const modal = document.getElementById('post-prayer-adhkar-settings-modal');
            modal.style.display = 'flex';
        }

        function closePostPrayerAdhkarSettings() {
            document.getElementById('post-prayer-adhkar-settings-modal').style.display = 'none';
        }

        async function savePostPrayerAdhkarSettings() {
            const id = document.getElementById('modal-pp-prayer-id').value;
            const delay = document.getElementById('modal-pp-delay').value;
            const showLink = document.getElementById('modal-pp-show-link').checked ? 1 : 0;

            try {
                const res = await fetch('/api/islamic-reminders/prayer-setting', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: id,
                        settings: { 
                            post_prayer_adhkar_delay: parseInt(delay) || 5,
                            post_prayer_adhkar_show_link: showLink
                        }
                    })
                });

                if (res.ok) {
                    Swal.fire({
                        title: 'تم الحفظ',
                        text: 'تم تحديث إعدادات أذكار دبر الصلاة',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => location.reload());
                } else {
                    Swal.fire('خطأ', 'فشل حفظ الإعدادات', 'error');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('خطأ', 'حدث خطأ في الاتصال', 'error');
            }
        }
    </script>
    <!-- Daily Adhkar Settings Modal -->
    <div id="daily-adhkar-settings-modal" class="modal-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-content"
            style="background: var(--bg-card); padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modal-daily-title" style="margin: 0;">⚙️ إعدادات الأذكار</h3>
                <button onclick="closeDailyAdhkarSettings()"
                    style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            </div>

            <input type="hidden" id="modal-daily-key">
            <p id="modal-daily-name"
                style="margin-bottom: 20px; font-weight: bold; color: var(--primary); font-size: 1.1rem; text-align: center;">
            </p>

            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">⏰ وقت الإرسال:</label>
                <input type="time" id="modal-daily-time" class="form-control">
            </div>

            <div class="form-group"
                style="margin-bottom: 15px; background: var(--bg-secondary); padding: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 2px;">🔔 تفعيل التذكير</label>
                    <small style="color: var(--text-muted);">إرسال هذا النوع من الأذكار</small>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="modal-daily-enabled">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="form-group"
                style="margin-bottom: 20px; background: var(--bg-secondary); padding: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 2px;">🔗 إرفاق رابط المصدر</label>
                    <small style="color: var(--text-muted);">إظهار رابط "للمزيد" في الرسالة</small>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="modal-daily-show-link">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- Content Type (Only for Content) -->
            <div id="modal-daily-content-type-group" class="form-group" style="display: none; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">🎨 نوع المحتوى:</label>
                <select id="modal-daily-content-type" class="form-control">
                    <option value="mixed">كوكتيل (صور وفيديو) 🔀</option>
                    <option value="image">صور فقط 🖼️</option>
                    <option value="video">فيديو فقط 🎬</option>
                </select>
            </div>

            <div id="modal-daily-source-group" class="form-group" style="display: none; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">🧭 نمط الإرسال:</label>
                <select id="modal-daily-source" class="form-control" onchange="updateDailyModalMediaVisibility()">
                    <option value="manual">وضع القراءة (نص)</option>
                    <option value="auto">وضع المشاهدة (وسائط)</option>
                </select>
            </div>

            <div id="modal-daily-text-length-group" class="form-group" style="display: none; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">📏 طول النص:</label>
                <div style="display: flex; gap: 10px;">
                    <label style="flex: 1; cursor: pointer; background: var(--bg-secondary); padding: 10px; border-radius: 10px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="modal-daily-text-length" value="full">
                        <span>نص كامل</span>
                    </label>
                    <label style="flex: 1; cursor: pointer; background: var(--bg-secondary); padding: 10px; border-radius: 10px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="modal-daily-text-length" value="short">
                        <span>مختصر</span>
                    </label>
                </div>
            </div>

            <div id="modal-daily-media-pref-group" class="form-group" style="display: none; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">🎨 نوع الوسائط:</label>
                <select id="modal-daily-media-preference" class="form-control">
                    <option value="mixed">كوكتيل</option>
                    <option value="image">صور فقط</option>
                    <option value="video">فيديو فقط</option>
                </select>
            </div>

            <div id="modal-hadith-media-mode-group" class="form-group" style="display: none; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">🖼️ طريقة إرسال الحديث:</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <label style="flex: 1; cursor: pointer; background: var(--bg-secondary); padding: 10px; border-radius: 10px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; min-width: 150px;">
                        <input type="radio" name="modal-hadith-media-mode" value="text">
                        <span>حديث فقط</span>
                    </label>
                    <label style="flex: 1; cursor: pointer; background: var(--bg-secondary); padding: 10px; border-radius: 10px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; min-width: 150px;">
                        <input type="radio" name="modal-hadith-media-mode" value="image">
                        <span>حديث + صورة</span>
                    </label>
                </div>
                <small style="color: var(--text-muted); display:block; margin-top: 8px;">يتم الإرسال مرة يوميًا في الوقت المحدد.</small>
            </div>

            <div id="modal-hadith-show-source-text-group" class="form-group" style="display: none; margin-bottom: 20px; background: var(--bg-secondary); padding: 10px; border-radius: 8px; border: 1px solid var(--border); display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <label style="display: block; font-weight: bold; margin-bottom: 2px;">📚 إظهار نص المصدر</label>
                        <small style="color: var(--text-muted);">إظهار سطر المصدر داخل الرسالة</small>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="modal-hadith-show-source-text">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div id="modal-hadith-show-image-source-text-group" class="form-group" style="display: none; margin-bottom: 20px; background: var(--bg-secondary); padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <label style="display: block; font-weight: bold; margin-bottom: 2px;">🖼️ إظهار مصدر الصورة</label>
                        <small style="color: var(--text-muted);">إظهار مصدر الصورة داخل الرسالة</small>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="modal-hadith-show-image-source-text">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div id="modal-hadith-image-preview-group" class="form-group" style="display: none; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">🔎 معاينة الصورة:</label>
                <div style="background: var(--bg-secondary); padding: 10px; border-radius: 12px; border: 1px solid var(--border);">
                    <input type="hidden" id="modal-hadith-image-source" value="islamic_backgrounds" />
                    <input type="hidden" id="modal-hadith-image-theme" value="mosques" />
                    <img id="modal-hadith-image-preview" alt="preview" style="width: 100%; max-height: 240px; object-fit: cover; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-main); display: none;" />
                    <div id="modal-hadith-image-preview-meta" style="margin-top: 8px; color: var(--text-muted); font-size: 0.85rem;"></div>
                    <div style="margin-top: 10px; display:flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                        <button onclick="previewHadithScheduledImage()" class="btn btn-outline" style="padding: 8px 12px;">
                            <i class="fas fa-eye"></i> معاينة الصورة
                        </button>
                        <button onclick="previewHadithScheduledImage(true)" class="btn btn-outline" style="padding: 8px 12px;">
                            <i class="fas fa-sync"></i> تغيير الصورة
                        </button>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeDailyAdhkarSettings()" class="btn btn-outline"
                    style="padding: 8px 15px;">إلغاء</button>
                <button onclick="saveDailyAdhkarSettings()" class="btn btn-primary" style="padding: 8px 15px;">حفظ
                    التغييرات</button>
            </div>
        </div>
    </div>

    <script>
        function openDailyAdhkarSettingsFromButton(btn) {
            const key = btn.getAttribute('data-daily-key');
            const name = btn.getAttribute('data-daily-name');
            const time = btn.getAttribute('data-daily-time');
            const enabled = btn.getAttribute('data-daily-enabled');
            const showLink = btn.getAttribute('data-daily-show-link');
            const contentType = btn.getAttribute('data-daily-content-type');
            const source = btn.getAttribute('data-daily-source');
            const hadithMediaMode = btn.getAttribute('data-daily-hadith-media-mode');
            const hadithShowSourceText = btn.getAttribute('data-daily-hadith-show-source-text');
            const hadithShowImageSourceText = btn.getAttribute('data-daily-hadith-show-image-source-text');
            const hadithImageSource = btn.getAttribute('data-daily-hadith-image-source');
            const hadithImageTheme = btn.getAttribute('data-daily-hadith-image-theme');
            openDailyAdhkarSettings(key, name, time, enabled, showLink, contentType, source, hadithMediaMode, hadithShowSourceText, hadithShowImageSourceText, hadithImageSource, hadithImageTheme);
        }

        function openDailyAdhkarSettings(key, name, currentTime, currentEnabled, currentShowLink, contentType = null, currentSource = null, hadithMediaMode = null, hadithShowSourceText = null, hadithShowImageSourceText = null, hadithImageSource = null, hadithImageTheme = null) {
            const title = document.getElementById('modal-daily-title');
            if (title) title.textContent = (key === 'hadith') ? '⚙️ جدولة حديث اليوم' : '⚙️ إعدادات الأذكار';

            document.getElementById('modal-daily-key').value = key;
            document.getElementById('modal-daily-name').textContent = name;
            document.getElementById('modal-daily-time').value = currentTime;

            // Handle boolean or string inputs safely
            const isEnabled = (currentEnabled === 'true' || currentEnabled === true || currentEnabled === '1' || currentEnabled === 1);
            const isShowLink = (currentShowLink === 'true' || currentShowLink === true || currentShowLink === '1' || currentShowLink === 1);

            document.getElementById('modal-daily-enabled').checked = isEnabled;
            document.getElementById('modal-daily-show-link').checked = isShowLink;

            // Handle Content Type
            const typeGroup = document.getElementById('modal-daily-content-type-group');
            const typeSelect = document.getElementById('modal-daily-content-type');
            
            if (key === 'content') {
                typeGroup.style.display = 'block';
                typeSelect.value = contentType || 'mixed';
            } else {
                typeGroup.style.display = 'none';
            }

            const sourceGroup = document.getElementById('modal-daily-source-group');
            const sourceSelect = document.getElementById('modal-daily-source');
            const textLengthGroup = document.getElementById('modal-daily-text-length-group');
            const mediaPrefGroup = document.getElementById('modal-daily-media-pref-group');
            const mediaPrefSelect = document.getElementById('modal-daily-media-preference');
            const hadithModeGroup = document.getElementById('modal-hadith-media-mode-group');
            const hadithShowSourceTextGroup = document.getElementById('modal-hadith-show-source-text-group');
            const hadithShowSourceTextToggle = document.getElementById('modal-hadith-show-source-text');
            const hadithShowImageSourceTextGroup = document.getElementById('modal-hadith-show-image-source-text-group');
            const hadithShowImageSourceTextToggle = document.getElementById('modal-hadith-show-image-source-text');
            const hadithImagePreviewGroup = document.getElementById('modal-hadith-image-preview-group');
            const hadithImageSourceSelect = document.getElementById('modal-hadith-image-source');
            const hadithImageThemeSelect = document.getElementById('modal-hadith-image-theme');

            if (key === 'morning' || key === 'evening' || key === 'hadith') {
                textLengthGroup.style.display = 'block';
                mediaPrefSelect.value = (document.getElementById('tab-adhkar')?.dataset?.mediaPreference) || 'mixed';

                const textLength = (document.getElementById('tab-adhkar')?.dataset?.textLength) || 'full';
                const radios = document.querySelectorAll('input[name="modal-daily-text-length"]');
                radios.forEach(r => r.checked = (r.value === textLength));

                if (key === 'morning' || key === 'evening') {
                    sourceGroup.style.display = 'none';
                    mediaPrefGroup.style.display = 'none';
                    if (hadithModeGroup) hadithModeGroup.style.display = 'none';
                    if (hadithShowSourceTextGroup) hadithShowSourceTextGroup.style.display = 'none';
                    if (hadithShowImageSourceTextGroup) hadithShowImageSourceTextGroup.style.display = 'none';
                    if (hadithImagePreviewGroup) hadithImagePreviewGroup.style.display = 'none';
                } else {
                    sourceGroup.style.display = 'none';
                    textLengthGroup.style.display = 'none';
                    mediaPrefGroup.style.display = 'none';
                    if (hadithModeGroup) hadithModeGroup.style.display = 'block';
                    if (hadithShowSourceTextGroup) hadithShowSourceTextGroup.style.display = 'none';
                    if (hadithShowImageSourceTextGroup) hadithShowImageSourceTextGroup.style.display = 'block';
                    if (hadithShowSourceTextToggle) {
                        const isShow = (hadithShowSourceText === 'true' || hadithShowSourceText === true || hadithShowSourceText === '1' || hadithShowSourceText === 1);
                        hadithShowSourceTextToggle.checked = isShow;
                    }
                    if (hadithShowImageSourceTextToggle) {
                        const isShow = (hadithShowImageSourceText === 'true' || hadithShowImageSourceText === true || hadithShowImageSourceText === '1' || hadithShowImageSourceText === 1);
                        hadithShowImageSourceTextToggle.checked = isShow;
                    }

                    const mode = hadithMediaMode || 'text';
                    document.querySelectorAll('input[name="modal-hadith-media-mode"]').forEach(r => {
                        r.checked = (r.value === mode);
                    });

                    if (hadithImageSourceSelect) {
                        hadithImageSourceSelect.value = hadithImageSource || 'islamic_backgrounds';
                    }
                    if (hadithImageThemeSelect) {
                        hadithImageThemeSelect.value = hadithImageTheme || 'mosques';
                    }

                    if (hadithImagePreviewGroup) {
                        hadithImagePreviewGroup.style.display = (mode === 'image') ? 'block' : 'none';
                    }
                    if (hadithShowImageSourceTextGroup) {
                        hadithShowImageSourceTextGroup.style.display = (mode === 'image') ? 'block' : 'none';
                    }
                    document.querySelectorAll('input[name="modal-hadith-media-mode"]').forEach(r => {
                        r.onchange = () => {
                            const selected = document.querySelector('input[name="modal-hadith-media-mode"]:checked')?.value || 'text';
                            if (hadithImagePreviewGroup) hadithImagePreviewGroup.style.display = (selected === 'image') ? 'block' : 'none';
                            if (hadithShowImageSourceTextGroup) hadithShowImageSourceTextGroup.style.display = (selected === 'image') ? 'block' : 'none';
                        };
                    });
                }
            } else {
                sourceGroup.style.display = 'none';
                textLengthGroup.style.display = 'none';
                mediaPrefGroup.style.display = 'none';
                if (hadithModeGroup) hadithModeGroup.style.display = 'none';
                if (hadithShowSourceTextGroup) hadithShowSourceTextGroup.style.display = 'none';
                if (hadithShowImageSourceTextGroup) hadithShowImageSourceTextGroup.style.display = 'none';
                if (hadithImagePreviewGroup) hadithImagePreviewGroup.style.display = 'none';
            }

            document.getElementById('daily-adhkar-settings-modal').style.display = 'flex';
        }

        async function previewHadithScheduledImage(forceNew = false) {
            try {
                const img = document.getElementById('modal-hadith-image-preview');
                const meta = document.getElementById('modal-hadith-image-preview-meta');
                if (meta) meta.textContent = 'جاري التحميل...';
                const srcSelect = document.getElementById('modal-hadith-image-source');
                const source = srcSelect ? srcSelect.value : 'islamic_backgrounds';
                const themeSel = document.getElementById('modal-hadith-image-theme');
                const theme = themeSel ? themeSel.value : 'mixed';
                if (themeSel) themeSel.style.display = (source === 'islamic_backgrounds') ? 'block' : 'none';
                const t = forceNew ? `&t=${Date.now()}` : '';
                const res = await fetch(`/api/hadith/background?source=${encodeURIComponent(source)}&theme=${encodeURIComponent(theme)}${t}`);
                const data = await res.json();
                if (!res.ok) return;
                if (img) {
                    img.src = data.url;
                    img.style.display = 'block';
                }
                if (meta) {
                    const license = data?.attribution?.license ? ` - ${String(data.attribution.license).replace(/<[^>]+>/g, '').trim()}` : '';
                    meta.textContent = data.source ? `مصدر الصورة: ${data.source}${license}` : '';
                }
            } catch (e) {
                console.error(e);
            }
        }

        function updateDailyModalMediaVisibility() {
            const key = document.getElementById('modal-daily-key')?.value;
            const source = document.getElementById('modal-daily-source')?.value;
            const mediaPrefGroup = document.getElementById('modal-daily-media-pref-group');

            if (!mediaPrefGroup) return;
            if (key === 'morning' || key === 'evening' || key === 'hadith') {
                mediaPrefGroup.style.display = (source === 'auto') ? 'block' : 'none';
            } else {
                mediaPrefGroup.style.display = 'none';
            }
        }

        function closeDailyAdhkarSettings() {
            document.getElementById('daily-adhkar-settings-modal').style.display = 'none';
        }

        async function saveDailyAdhkarSettings() {
            const key = document.getElementById('modal-daily-key').value; // e.g., 'morning', 'evening'
            const time = document.getElementById('modal-daily-time').value;
            const enabled = document.getElementById('modal-daily-enabled').checked ? 1 : 0;
            const showLink = document.getElementById('modal-daily-show-link').checked ? 1 : 0;

            const payload = {};
            payload[key + '_time'] = time;
            payload[key + '_enabled'] = enabled;
            payload[key + '_show_link'] = showLink;

            if (key === 'content') {
                payload['content_type'] = document.getElementById('modal-daily-content-type').value;
            }

            if (key === 'hadith') {
                const hadithMode = document.querySelector('input[name="modal-hadith-media-mode"]:checked')?.value || 'text';
                payload['hadith_media_mode'] = hadithMode;
                payload['hadith_image_source'] = document.getElementById('modal-hadith-image-source')?.value || 'islamic_backgrounds';
                payload['hadith_image_theme'] = document.getElementById('modal-hadith-image-theme')?.value || 'mosques';
                payload['hadith_show_image_source_text'] = document.getElementById('modal-hadith-show-image-source-text')?.checked ? 1 : 0;
            }

            try {
                const res = await fetch('/api/islamic-reminders/adhkar', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    Swal.fire({
                        title: 'تم الحفظ',
                        text: 'تم تحديث إعدادات الأذكار بنجاح',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => location.reload());
                } else {
                    Swal.fire('خطأ', 'فشل حفظ الإعدادات', 'error');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('خطأ', 'حدث خطأ في الاتصال', 'error');
            }
        }
    </script>
</body>

</html>
